import e,{div as t,label as n,strong as o,small as r}from"/Utils/elements.js";import a from"/Utils/use-lang.js";import{useCallback as s,useState as c,useRef as i,useEffect as l,useContext as d}from"/cdn/react";import{keywords as m}from"/Components/card-template/keyword-renderer.js";import f from"/Utils/load-css.js";import u from"/Utils/datauri.js";import p from"/Components/context-menu.js";import g from"/Utils/use-debounce-callback.js";import{Globals as x}from"/Views/index.js";const h=f("/Components/card-config/edit-effect.css");function N(e,t){const n=t||m[e],o=document.createDocumentFragment();return n.forEach((n=>{const r=document.createElement("img");r.classList.add("keyword-img"),r.dataset.keywordName=e,o.appendChild(r),u(t?n:`/Assets/keyword/${n}`).then((e=>{r.src=e}))})),o}const y=e((function(e){const[n,o]=c([]);return l((()=>{if(!e.name)return;const t=m[e.name].map((e=>u(`/Assets/keyword/${e}`)));Promise.all(t).then(o)}),[e.name]),l((()=>{if(!e.icons)return;const t=e.icons.map((e=>u(e)));Promise.all(t).then(o)}),[e.icons]),t({contentEditable:!1,className:"keyword-icon-wrapper","data-keyword-name":e.name,style:{height:"1em",width:n.length+"em"}},n.map(((e,n)=>t({key:n,className:"keyword-icon",style:{backgroundImage:`url(${e})`}}))))}));function k(e){let t=!1;return Array.prototype.map.call(e.childNodes,(e=>t?(t=!1,e instanceof Image&&e.nextSibling instanceof Image&&e.nextSibling.dataset.keywordName===e.dataset.keywordName&&(t=!0),""):e instanceof HTMLDivElement?"\n"+k(e):e instanceof Text?e.textContent:e instanceof Image?(e.nextSibling instanceof Image&&e.nextSibling.dataset.keywordName===e.dataset.keywordName&&(t=!0),`<${e.dataset.keywordName}/>`):void 0)).join("")}const w=Object.keys(m).filter((e=>m[e].length));export default e((function(e){const f=a(),{customKeywords:u}=d(x),h=i();l((()=>{e.value&&h.current.replaceChildren(function(e,t){let n=[e];w.forEach((e=>{const t=`<${e}/>`;n=n.map((n=>{if("string"!=typeof n)return n;let o=n.split(t);if(1===o.length)return o[0];for(let t=o.length-1;t;t--)o.splice(t,0,N(e));return o})).flat()})),t.forEach((e=>{const t=`<${e.id}/>`;n=n.map((n=>{if("string"!=typeof n)return n;let o=n.split(t);if(1===o.length)return o[0];for(let t=o.length-1;t;t--)o.splice(t,0,N(e.id,e.icons));return o})).flat()})),n=n.map((e=>{if("string"!=typeof e)return e;let t=e.split(/\n+/g);if(1===t.length)return t[0];for(let e=t.length-1;e;e--)t.splice(e,0,document.createElement("br"));return t})).flat();const o=document.createDocumentFragment();return n=n.forEach((e=>{if("string"!=typeof e)return o.appendChild(e);o.appendChild(new Text(e))})),o}(e.value,u))}),[!!e.value]);const b=g((()=>{const t=k(h.current);e.updateValue(t)}),600,[e.updateValue]),[T,C]=c(),E=s((()=>{const e=window.getSelection(),t=e.focusNode;e&&(t===h.current||h.current.contains(t))&&C({node:t,offset:e.focusOffset});const n=h.current.querySelectorAll(".keyword-icon-wrapper");n.length&&Array.prototype.forEach.call(n,(e=>{e.nextSibling instanceof Text||(e.nextSibling?e.parentNode.insertBefore(document.createTextNode(" "),e.nextSibling):e.parentNode.appendChild(document.createTextNode(" ")))})),b()}),[b]),j=s((t=>{if(!T)return;const n=T.node,o=f(t);if(n instanceof HTMLDivElement)n.appendChild(N(t)),n.appendChild(document.createTextNode(o));else if(n instanceof Text){const e=n.splitText(T.offset);e.parentNode.insertBefore(N(t),e),e.parentNode.insertBefore(document.createTextNode(o),e)}else n.after(N(t),document.createTextNode(o));e.orangeWords.reduce(((e,t)=>e||t===o),!1)||e.updateOrangeWords([...e.orangeWords,o]),b()}),[e.updateValue,T,e.orangeWords,e.updateOrangeWords,b]),W=s((t=>{if(!T)return;const n=T.node,o=t.name;if(n instanceof HTMLDivElement)n.appendChild(N(t.id,t.icons)),n.appendChild(document.createTextNode(o));else if(n instanceof Text){const e=n.splitText(T.offset);e.parentNode.insertBefore(N(t.id,t.icons),e),e.parentNode.insertBefore(document.createTextNode(o),e)}else n.after(N(t.id,t.icons),document.createTextNode(o));e.orangeWords.reduce(((e,t)=>e||t===o),!1)||e.updateOrangeWords([...e.orangeWords,o]),b()}),[e.updateValue,T,e.orangeWords,e.updateOrangeWords,b]);return n({className:"box edit-effect"},t(o(e.label)," ",r(f("insert_icon_instruction"))),t({className:"flex column gutter-b-2"},t({className:"gutter-trbl-.5"},p({className:"react-contextmenu",menu:t(Object.keys(m).filter((e=>m[e].length)).sort().map((e=>t({onClick:()=>j(e),key:e,className:"react-contextmenu-item"},t({className:"flex vend"},y({name:e}),f(e))))),u.filter((e=>e.icons&&e.icons.length)).map((e=>t({onClick:()=>W(e),key:e.id,className:"react-contextmenu-item"},t({className:"flex vend"},y({icons:e.icons}),e.name)))))},t({ref:h,contentEditable:!0,className:"textarea box gutter-trbl-.5","data-placeholder":f("insert_icon_instruction"),onInput:E,onFocus:E,onBlur:E})))))}),h);