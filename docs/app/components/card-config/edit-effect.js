import e,{div as t,label as n,strong as o,small as r}from"/Utils/elements.js";import s from"/Utils/use-lang.js";import{useCallback as a,useState as i,useRef as c,useEffect as d,useContext as l}from"/cdn/react";import{keywords as m}from"/Components/card-template/keyword-renderer.js";import u from"/Utils/load-css.js";import f from"/Utils/datauri.js";import p from"/Utils/use-debounce-callback.js";import{Globals as g}from"/Views/index.js";import{ContextMenu as x,ContextMenuItem as h,useContextMenu as y}from"/cdn/usecontextmenu-react";import N from"/Utils/use-asset-cache.js";const w=u("/Components/card-config/edit-effect.css"),k=e(x),b=e(h);function v(e,t){const n=t||m[e],o=document.createDocumentFragment();return n.forEach((n=>{const r=document.createElement("img");r.classList.add("keyword-img"),r.dataset.keywordName=e,o.appendChild(r),f(t?n:`/Assets/keyword/${n}`).then((e=>{r.src=e}))})),o}const T=e((function(e){const n=N((t=>{if(e.icons){const n=e.icons.map((e=>f(e)));Promise.all(n).then(t)}else if(e.name){const n=m[e.name].map((e=>f(`/Assets/keyword/${e}`)));Promise.all(n).then(t)}}),[e.name,e.icons],[]);return t({contentEditable:!1,className:"keyword-icon-wrapper","data-keyword-name":e.name,style:{height:"1em",width:n.length+"em"}},n.map(((e,n)=>t({key:n,className:"keyword-icon",style:{backgroundImage:`url(${e})`}}))))}));function E(e){let t=!1;return Array.prototype.map.call(e.childNodes,(e=>t?(t=!1,e instanceof Image&&e.nextSibling instanceof Image&&e.nextSibling.dataset.keywordName===e.dataset.keywordName&&(t=!0),""):e instanceof Image?(e.nextSibling instanceof Image&&e.nextSibling.dataset.keywordName===e.dataset.keywordName&&(t=!0),`<${e.dataset.keywordName}/>`):e instanceof Text?e.textContent:e instanceof HTMLBRElement?"\n":e instanceof HTMLDivElement?"\n"+E(e):E(e))).join("")}const C=Object.keys(m).filter((e=>m[e].length));export default e((function(e){const u=s(),{customKeywords:f}=l(g),x=c();d((()=>{e.value&&(x.current&&x.current.innerText||x.current.replaceChildren(function(e,t){let n=[e];C.forEach((e=>{const t=`<${e}/>`;n=n.map((n=>{if("string"!=typeof n)return n;let o=n.split(t);if(1===o.length)return o[0];for(let t=o.length-1;t;t--)o.splice(t,0,v(e));return o})).flat()})),t.forEach((e=>{const t=`<${e.id}/>`;n=n.map((n=>{if("string"!=typeof n)return n;let o=n.split(t);if(1===o.length)return o[0];for(let t=o.length-1;t;t--)o.splice(t,0,v(e.id,e.icons));return o})).flat()})),n=n.map((e=>{if("string"!=typeof e)return e;let t=e.split(/\n+/g);if(1===t.length)return t[0];for(let e=t.length-1;e;e--)t.splice(e,0,document.createElement("br"));return t})).flat();const o=document.createDocumentFragment();return n=n.forEach((e=>{if("string"!=typeof e)return o.appendChild(e);o.appendChild(new Text(e))})),o}(e.value,f)))}),[!!e.value]);const h=p((()=>{const t=E(x.current);e.updateValue(t)}),600,[e.updateValue]),[N,w]=i(),j=a((()=>{const e=window.getSelection(),t=e.focusNode;e&&(t===x.current||x.current.contains(t))&&w({node:t,offset:e.focusOffset});const n=x.current.querySelectorAll(".keyword-icon-wrapper");n.length&&Array.prototype.forEach.call(n,(e=>{e.nextSibling instanceof Text||(e.nextSibling?e.parentNode.insertBefore(document.createTextNode(" "),e.nextSibling):e.parentNode.appendChild(document.createTextNode(" ")))})),h()}),[h]),L=a((t=>{if(!N)return;const n=N.node,o=u(t);if(n instanceof HTMLDivElement)n.appendChild(v(t)),n.appendChild(document.createTextNode(o));else if(n instanceof Text){const e=n.splitText(N.offset);e.parentNode.insertBefore(v(t),e),e.parentNode.insertBefore(document.createTextNode(o),e)}else n.after(v(t),document.createTextNode(o));e.orangeWords.reduce(((e,t)=>e||t===o),!1)||e.updateOrangeWords([...e.orangeWords,o]),h()}),[e.updateValue,N,e.orangeWords,e.updateOrangeWords,h]),W=a((t=>{if(!N)return;const n=N.node,o=t.name;if(n instanceof HTMLDivElement)n.appendChild(v(t.id,t.icons)),n.appendChild(document.createTextNode(o));else if(n instanceof Text){const e=n.splitText(N.offset);e.parentNode.insertBefore(v(t.id,t.icons),e),e.parentNode.insertBefore(document.createTextNode(o),e)}else n.after(v(t.id,t.icons),document.createTextNode(o));e.orangeWords.reduce(((e,t)=>e||t===o),!1)||e.updateOrangeWords([...e.orangeWords,o]),h()}),[e.updateValue,N,e.orangeWords,e.updateOrangeWords,h]),{menuProps:S,onContextMenu:O,visibleOnPosition:B}=y(),[I,M]=i(!1),U=a((e=>{j(e),M(!1)}),[j]);return d((()=>{function e(){M(!1)}return document.addEventListener("scroll",e),window.addEventListener("resize",e),document.addEventListener("click",e),function(){document.removeEventListener("scroll",e),window.removeEventListener("resize",e),document.removeEventListener("click",e)}}),[]),n({className:"box edit-effect"},t(o(e.label)," ",r(u("insert_icon_instruction"))),t({className:"flex column gutter-b-2"},t({className:"gutter-trbl-.5"},t({ref:x,contentEditable:!0,className:"textarea box gutter-trbl-.5","data-placeholder":u("insert_icon_instruction"),onInput:U,onFocus:j,onBlur:j,onContextMenu:(...e)=>{O(...e),M(!0)}}))),k({...S,visible:I},Object.keys(m).filter((e=>m[e].length)).sort().map((e=>b({key:e,onClick:()=>L(e),className:"flex vend"},T({name:e}),u(e)))),f.filter((e=>e.icons&&e.icons.length)).map((e=>b({key:e.id,onClick:()=>W(e),className:"flex vend",preventClose:!0},T({icons:e.icons}),e.name)))))}),w);