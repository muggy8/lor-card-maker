import e,{div as t,label as n,strong as o,small as r}from"/Utils/elements.js";import a from"/Utils/use-lang.js";import{useCallback as s,useState as c,useRef as i,useEffect as l}from"/cdn/react";import{keywords as d}from"/Components/card-template/keyword-renderer.js";import m from"/Utils/load-css.js";import u from"/Utils/datauri.js";import f from"/Components/context-menu.js";import p from"/Utils/use-debounce-callback.js";const g=m("/Components/card-config/edit-effect.css");function y(e){const t=d[e],n=document.createDocumentFragment();return t.forEach((t=>{const o=document.createElement("img");o.classList.add("keyword-img"),o.dataset.keywordName=e,n.appendChild(o),u(`/Assets/keyword/${t}`).then((e=>{o.src=e}))})),n}const x=e((function(e){const[n,o]=c([]);return l((()=>{const t=d[e.name].map((e=>u(`/Assets/keyword/${e}`)));Promise.all(t).then(o)}),[e.name]),t({contentEditable:!1,className:"keyword-icon-wrapper","data-keyword-name":e.name,style:{height:"1em",width:n.length+"em"}},n.map(((e,n)=>t({key:n,className:"keyword-icon",style:{backgroundImage:`url(${e})`}}))))}));function h(e){let t=!1;return Array.prototype.map.call(e.childNodes,(e=>t?(t=!1,e instanceof Image&&e.nextSibling instanceof Image&&e.nextSibling.dataset.keywordName===e.dataset.keywordName&&(t=!0),""):e instanceof HTMLDivElement?"\n"+h(e):e instanceof Text?e.textContent:e instanceof Image?(e.nextSibling instanceof Image&&e.nextSibling.dataset.keywordName===e.dataset.keywordName&&(t=!0),`<${e.dataset.keywordName}/>`):void 0)).join("")}const N=Object.keys(d).filter((e=>d[e].length));export default e((function(e){const m=a(),u=i(),[g,b]=c(!1);l((()=>{e.value&&!g&&u.current.replaceChildren(function(e){let t=[e];N.forEach((e=>{const n=`<${e}/>`;t=t.map((t=>{if("string"!=typeof t)return t;let o=t.split(n);if(1===o.length)return o[0];for(let t=o.length-1;t;t--)o.splice(t,0,y(e));return o})).flat()})),t=t.map((e=>{if("string"!=typeof e)return e;let t=e.split(/\n+/g);if(1===t.length)return t[0];for(let e=t.length-1;e;e--)t.splice(e,0,document.createElement("br"));return t})).flat();const n=document.createDocumentFragment();return t=t.forEach((e=>{if("string"!=typeof e)return n.appendChild(e);n.appendChild(new Text(e))})),n}(e.value))}),[!!e.value,g]);const k=p((()=>{const t=h(u.current);e.updateValue(t)}),600,[e.updateValue]),[w,C]=c(),T=s((()=>{const e=window.getSelection(),t=e.focusNode;e&&(t===u.current||u.current.contains(t))&&C({node:t,offset:e.focusOffset});const n=u.current.querySelectorAll(".keyword-icon-wrapper");n.length&&Array.prototype.forEach.call(n,(e=>{e.nextSibling instanceof Text||(e.nextSibling?e.parentNode.insertBefore(document.createTextNode(" "),e.nextSibling):e.parentNode.appendChild(document.createTextNode(" ")))})),b(!0),k()}),[k]),j=s((t=>{if(!w)return;const n=w.node,o=m(t);if(n instanceof HTMLDivElement)n.appendChild(y(t)),n.appendChild(document.createTextNode(o));else if(n instanceof Text){const e=n.splitText(w.offset);e.parentNode.insertBefore(y(t),e),e.parentNode.insertBefore(document.createTextNode(o),e)}else n.after(y(t),document.createTextNode(o));e.orangeWords.reduce(((e,t)=>e||t===o),!1)||e.updateOrangeWords([...e.orangeWords,o]),k()}),[e.updateValue,w,e.orangeWords,e.updateOrangeWords,k]);return n({className:"box edit-effect"},t(o(e.label)," ",r(m("insert_icon_instruction"))),t({className:"flex column gutter-b-2"},t({className:"gutter-trbl-.5"},f({className:"react-contextmenu",menu:Object.keys(d).filter((e=>d[e].length)).sort().map((e=>t({onClick:()=>j(e),key:e,className:"react-contextmenu-item"},t({className:"flex vend"},x({name:e}),m(e)))))},t({ref:u,contentEditable:!0,className:"textarea box gutter-trbl-.5","data-placeholder":m("insert_icon_instruction"),onInput:T,onFocus:T,onBlur:T})))))}),g);