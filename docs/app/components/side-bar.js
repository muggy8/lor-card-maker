import factory,{div,span,label,a,input,nav,select,option}from"/Utils/elements.js";import{useCallback,useState,useRef,useContext,useEffect}from"/cdn/react";import{Globals}from"/Views/index.js";import loadCss from"/Utils/load-css.js";import useLang from"/Utils/use-lang.js";import{getCardList,saveCard}from"/Utils/service.js";import BatchExport from"/Views/batch-export.js";import{usePWAInstall}from"/cdn/react-use-pwa-install";import useToggle from"/Utils/use-toggle.js";const cssLoaded=loadCss("/Components/side-bar.css"),themeClassNames=["oled","dark","light","flash-bomb"];function SidebarComponent(){const e=useLang(),t=useContext(Globals);useEffect(()=>{document.body.classList.remove(...document.body.classList),document.body.classList.add(t.state.settings.theme)},[t.state.settings]);const[s,l]=useState(!1),o=useCallback(()=>{l(!s)},[s]),i=useRef(),n=usePWAInstall(),c=useCallback(async()=>{const e=await getCardList();e.reverse();downloadFile(JSON.stringify({cards:e}),"card-data.json","application/json")},[]),[r,d,m]=useToggle(!1),p=useCallback(async e=>{m(!0);const a=await new Promise(a=>{let t=new FileReader,s=e.target.files[0];t.addEventListener("load",()=>{let e=JSON.parse(t.result);a(e)}),s&&t.readAsText(s)}),t=[...[{key:"savedChampions1",type:"champion1"},{key:"savedChampions2",type:"champion2"},{key:"savedChampions3",type:"champion3"},{key:"savedFollowers",type:"follower"},{key:"savedKeywords",type:"keyword"},{key:"savedLandmarks",type:"landmark"},{key:"savedSpells",type:"spell"}].map(e=>a[e.key]?a[e.key].map(({id:a,cardData:t})=>(t.id=a,t.type=e.type,"gemless"!==t.rarity&&"none"!==t.rarity||(t.rarity=""),t.dataVersion=2,t)):[]).flat(),...a.cards?a.cards.filter(e=>2===e.dataVersion):[]];for(let e of t)await saveCard(e.id,e);m(!1),document.location.reload()}),u=useCallback(()=>{t.setView(BatchExport),l(!1)},[t.setView]);return nav({className:"side-bar card-text-universe gutter-rl-3 flex column vhcenter "+(s?"open":"")},div({className:"menu-icon flex vhcenter",onClick:o},div({className:"icon animate clickable"},span({className:s?"delete":"menu"}))),label({className:"menu-option clickable gutter-tb"},div({className:"flex vhcenter"},e("theme")),select({value:t.state.settings.theme||"oled",onChange:e=>t.patchSettings({theme:e.target.value}),className:"select-theme gutter-rl-1 gutter-tb-.5"},themeClassNames.map(a=>option({key:a,value:a},e(a))))),div({className:"menu-option clickable gutter-tb",onClick:u},e("batch_export")),n?div({className:"menu-option clickable gutter-tb",onClick:n},e("install_app")):void 0,div({className:"menu-option clickable gutter-tb",onClick:c},e("export_save")),label({className:"menu-option clickable gutter-tb"},r?void 0:e("import_save"),r?void 0:input({className:"hide",accept:"application/json",type:"file",onChange:p}),r?div({className:"icon"},div({className:"loading"})):void 0),label({className:"menu-option clickable gutter-tb",onClick:()=>i.current.click()},e("report_bug"),a({ref:i,href:"https://github.com/muggy8/lor-card-maker/issues",className:"hide",target:"_blank"})))}function downloadFile(e,a,t){var s=document.createElement("a"),l=new Blob([e],{type:t});s.href=URL.createObjectURL(l),s.download=a,s.click()}export default factory(SidebarComponent,cssLoaded);