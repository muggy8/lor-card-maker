import factory,{div}from"/Utils/elements.js";import{useRef,useState,useEffect,useContext}from"/cdn/react";import{Globals}from"/Views/index.js";import{FastAverageColor}from"/cdn/fast-average-color";import loadCss from"/Utils/load-css.js";import SvgWrap from"/Components/card-template/svg-wrap.js";import ArtRenderer from"/Components/card-template/image-render.js";import EffectText,{scaleFontSize}from"/Components/card-template/effect-text.js";import KeywordRenderer from"/Components/card-template/keyword-renderer.js";import fitty from"/cdn/fitty";import datauri from"/Utils/datauri.js";import{speedOptions}from"/Components/card-config/edit-speed.js";import useEffectDebounce from"/Utils/use-debounce-effect.js";const cssLoaded=loadCss("/Components/card-template/spell.css");function getSpeedFrom(e){if(!e)return;return e.findLast(e=>speedOptions.some(t=>t===e))}function generateCleanedKeywordSet(e,t){if(!e)return;const r=e.filter(e=>!speedOptions.some(t=>e===t));return t&&r.push(t),r}function SpellComponent(e){const t=useContext(Globals),r=useRef(),[a,s]=useState("var(--color-dark, #777777)");useEffectDebounce(()=>{let t=r.current;t||(t=r.current=new FastAverageColor);const a=e.art||"/Assets/spell/backdrop.png";t.getColorAsync(a).then(e=>{s(e.hex)}).catch(console.warn)},200,[e.art]);const[n,o]=useState(""),[c,d]=useState(""),[l,i]=useState(""),[f,u]=useState(""),[m,p]=useState(""),[g,y]=useState([]),[w,h]=useState("");useEffect(()=>{datauri("/Assets/spell/background.png").then(o),datauri("/Assets/spell/backdrop.png").then(d),datauri("/Assets/landmark/typing.png").then(p)},[]),useEffect(()=>{const t=`/Assets/spell/frame${e.speed||"trap"}.png`;datauri(t).then(i)},[e.speed]),useEffect(()=>{if(!e.faction||!e.faction.length)return;const t=`/Assets/spell/regionbox${e.faction.length>3?3:e.faction.length}.png`;datauri(t).then(u);const r=e.faction.map(e=>datauri(`/Assets/region/${e}.png`));Promise.all(r).then(y)},[e.faction&&e.faction.length]),useEffect(()=>{if(e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity){const t=`/Assets/shared/gem${e.rarity}.png`;datauri(t).then(h)}else h("")},[e.rarity]);const b=useRef(),k=useRef(),v=useRef(),x=useRef(),S=useRef(),D=useRef(),C=useRef(),N=useRef();useEffectDebounce(()=>{scaleFontSize(b.current,70,16)},200,[e.name,!!l]),useEffectDebounce(()=>{scaleFontSize(k.current,40,16)},200,[e.clan,!!l]),useEffectDebounce(()=>{const e=D.current;if(e)e.fit();else{if(!v.current)return;D.current=fitty(v.current,{multiLine:!1,maxSize:90})}},200,[e.mana,!!l]),useEffectDebounce(()=>{if("number"!=typeof e.power)return;const t=C.current;if(t)t.fit();else{if(!x.current)return;C.current=fitty(x.current,{multiLine:!1,maxSize:70})}},200,[e.power,!!l]),useEffectDebounce(()=>{if("number"!=typeof e.health)return;const t=N.current;if(t)t.fit();else{if(!S.current)return;N.current=fitty(S.current,{multiLine:!1,maxSize:70})}},200,[e.health,!!l]);const U=useRef();return U.current=e,useEffect(()=>{const e=U.current,t=e.speed;if(!e.cardDataUpdaters)return;const r=getSpeedFrom(e.keywords),a=generateCleanedKeywordSet(e.keywords,t);if(!t||r===t){if(!e.keywords||!a)return;if(e.keywords.length===a.length)return;return e.cardDataUpdaters.keywords(a)}"equipment"===t?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null)),e.cardDataUpdaters.keywords(a)},[e.speed]),useEffect(()=>{const e=U.current;if(!e.cardDataUpdaters)return;const t=getSpeedFrom(e.keywords),r=generateCleanedKeywordSet(e.keywords,t);e.speed!==t&&(e.cardDataUpdaters.speed(t),"equipment"===t?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null))),r&&e.keywords&&r.length!==e.keywords.length&&e.cardDataUpdaters.keywords(r)},[e.keywords]),SvgWrap({loading:!l||e.loading,onTransform:e.updateTransform,...e.transform||{x:0,y:0,scale:1}},l?div({className:e.speed+" spell",id:e.id},div({className:"text-background",style:{backgroundColor:a}},div({className:"text-background-image",style:{backgroundImage:n?`url(${n})`:"none"}})),div({className:"art",style:{backgroundImage:t.state.defaultBg&&c?`url(${c})`:"none","--scale":e.transform?e.transform.scale:1,"--left":e.transform?e.transform.x:0,"--top":e.transform?e.transform.y:0}},div({className:"scale-adjuster"},ArtRenderer({url:e.art}))),div({className:"frame",style:{backgroundImage:l?`url(${l})`:"none"}}),div({className:"cost fitty-nowrap card-text-bold",ref:v},e.mana),e.faction&&e.faction.length?div({className:"region-frame",style:{backgroundImage:f?`url(${f})`:"none"}},g.map((e,t)=>div({key:e,className:"region-icon region-icon-"+t,style:{backgroundImage:e?`url(${e})`:"none"}}))):void 0,e.clan?div({className:"clan",style:{backgroundImage:m?`url(${m})`:"none"}},div({ref:k,className:"text-area fitty-nowrap text-area fitty-nowrap"},e.clan)):void 0,e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity?div({className:`${e.rarity||"no"} rarity ${e.clan?"with-clan":""}`,style:{backgroundImage:w?`url(${w})`:"none"}}):void 0,"number"==typeof e.power?div({className:"power fitty-nowrap card-text-bold",ref:x},e.power||0):void 0,"number"==typeof e.health?div({className:"health fitty-nowrap card-text-bold",ref:S},e.health||0):void 0,div({className:"card-text-wrapper"},e.name?div({className:"name fitty-wrap card-text-bold",ref:b},e.name):void 0,e.keywords&&e.keywords.length?div({className:"keyword-container card-text-bold"},e.keywords.map(t=>KeywordRenderer({key:t,name:t,size:e.keywords.length>1?"small":"large"}))):void 0,e.effect?EffectText({blueWords:e.blueWords,orangeWords:e.orangeWords,className:"effect-container card-text-universe"},e.effect):void 0)):null)}export default factory(SpellComponent,cssLoaded);