import e,{div as r}from"/Utils/elements.js";import{useRef as t,useState as a,useEffect as n,useContext as s}from"/cdn/react";import{Globals as o}from"/Views/index.js";import{FastAverageColor as c}from"/cdn/fast-average-color";import l from"/Utils/load-css.js";import i from"/Components/card-template/svg-wrap.js";import d from"/Components/card-template/image-render.js";import m,{scaleFontSize as p}from"/Components/card-template/effect-text.js";import f from"/Components/card-template/keyword-renderer.js";import u from"/cdn/fitty";import g from"/Utils/datauri.js";import{speedOptions as y}from"/Components/card-config/edit-speed.js";import h from"/Utils/use-debounce-effect.js";import k from"/Utils/concurrency-manager.js";import w,{useAssetCacheDebounced as x}from"/Utils/use-asset-cache.js";import{AutoFitClanText as b}from"/Components/card-template/unit.js";const U=l("/Components/card-template/spell.css");function N(e){if(!e)return;return e.findLast((e=>y.some((r=>r===e))))}function j(e,r){if(!e)return;const t=e.filter((e=>!y.some((r=>e===r))));return r&&t.push(r),t}const v=new c;export default e((function(e){const a=s(o),c=t();n((()=>{c.current=k()}),[]);const l=x((r=>{if(e.textBgColor)return r(e.textBgColor);const t=e.art||"/Assets/spell/backdrop.png";v.getColorAsync(t).then((e=>{r(e.hex)})).catch(console.warn)}),200,[e.textBgColor||e.art],"var(--color-dark, #777777)"),y=w((e=>{g("/Assets/spell/background.png").then(e)}),[]),U=w((e=>{g("/Assets/spell/backdrop.png").then(e)}),[]),D=w((e=>{g("/Assets/landmark/typing-2.png").then(e)}),[]),$=w((r=>{const t=`/Assets/spell/frame${e.speed||"trap"}.png`;g(t).then(r)}),[e.speed]),C=w((r=>{if(!e.faction||!e.faction.length)return;const t=`/Assets/spell/regionbox${e.faction.length>3?3:e.faction.length}.png`;g(t).then(r)}),[e.faction&&e.faction.length]),A=w((r=>{if(!e.faction||!e.faction.length)return;const t=e.faction.map((e=>g(`/Assets/region/${e}.png`)));Promise.all(t).then(r)}),[e.faction&&e.faction.length],[]),I=w((r=>{if(e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity){const t=`/Assets/shared/gem${e.rarity}.png`;g(t).then(r)}else r("")}),[e.rarity]),z=t(),B=(t(),t()),L=t(),T=t(),W=t(),q=t(),S=t(),P=t();h((()=>{$&&c.current.concurrent((()=>p(z.current,70,16)))}),200,[e.name,!!$]),h((()=>{if(!$)return;const e=q.current;if(e)e.fit();else{if(!B.current)return;q.current=u(B.current,{multiLine:!1,maxSize:90})}}),200,[e.mana,!!$]),h((()=>{if(!$)return;if("number"!=typeof e.power)return;const r=S.current;if(r)r.fit();else{if(!L.current)return;S.current=u(L.current,{multiLine:!1,maxSize:70})}}),200,[e.power,!!$]),h((()=>{if(!$)return;if("number"!=typeof e.health)return;const r=P.current;if(r)r.fit();else{if(!T.current)return;P.current=u(T.current,{multiLine:!1,maxSize:70})}}),200,[e.health,!!$]),h((()=>{$&&c.current.sequential((()=>p(W.current)))}),300,[!!e.name,!(!e.keywords||!e.keywords.length),e.effect,e.lvup,!!$]);const V=t();return V.current=e,n((()=>{const e=V.current,r=e.speed;if(!e.cardDataUpdaters)return;const t=N(e.keywords),a=j(e.keywords,r);if(!r||t===r){if(!e.keywords||!a)return;if(e.keywords.length===a.length)return;return e.cardDataUpdaters.keywords(a)}"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null)),e.cardDataUpdaters.keywords(a)}),[e.speed]),n((()=>{const e=V.current;if(!e.cardDataUpdaters)return;const r=N(e.keywords),t=j(e.keywords,r);e.speed!==r&&(e.cardDataUpdaters.speed(r),"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null))),t&&e.keywords&&t.length!==e.keywords.length&&e.cardDataUpdaters.keywords(t)}),[e.keywords]),i({loading:!$||e.loading,onTransform:e.updateTransform,...e.transform||{x:0,y:0,scale:1}},$?r({className:`${e.speed} spell`,id:e.id},r({className:"text-background",style:{backgroundColor:l}},r({className:"text-background-image",style:{backgroundImage:y?`url(${y})`:"none"}})),r({className:"art",style:{backgroundImage:!e.art&&a.state.defaultBg&&U?`url(${U})`:"none","--scale":e.transform?e.transform.scale:1,"--left":e.transform?e.transform.x:0,"--top":e.transform?e.transform.y:0}},r({className:"scale-adjuster"},d({url:e.art}))),r({className:"frame",style:{backgroundImage:$?`url(${$})`:"none"}}),r({className:"cost fitty-nowrap card-text-bold card-text-outline",ref:B},e.mana),e.faction&&e.faction.length?r({className:"region-frame",style:{backgroundImage:C?`url(${C})`:"none"}},A.map(((e,t)=>r({key:e,className:"region-icon region-icon-"+t,style:{backgroundImage:e?`url(${e})`:"none"}})))):void 0,e.clan&&e.clan.length?r({className:"clan",style:{backgroundImage:D?`url(${D})`:"none"}},e.clan.map(((r,t)=>b({key:t,multiple:e.clan.length>1},r)))):void 0,e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity?r({className:`${e.rarity||"no"} rarity ${e.clan&&e.clan.length?"with-clan":""}`,style:{backgroundImage:I?`url(${I})`:"none"}}):void 0,"number"==typeof e.power?r({className:"power fitty-nowrap card-text-bold card-text-outline",ref:L},e.power||0):void 0,"number"==typeof e.health?r({className:"health fitty-nowrap card-text-bold card-text-outline",ref:T},e.health||0):void 0,r({className:"card-text-wrapper",ref:W},e.name?r({className:"name fitty-wrap card-text-bold card-text-outline",ref:z},e.name):void 0,e.keywords&&e.keywords.length?r({className:"keyword-container card-text-bold"},e.keywords.map((r=>f("string"==typeof r?{key:r,name:r,size:e.keywords.length>1?"small":"large"}:{name:r.name,icons:r.icons,key:r.id,size:e.keywords.length>1?"small":"large"})))):void 0,m({blueWords:e.blueWords,orangeWords:e.orangeWords,className:"effect-container card-text-universe",effectText:e.effect,levelText:e.lvup}))):null)}),U);