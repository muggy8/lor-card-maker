import e,{div as r}from"/Utils/elements.js";import{useRef as t,useState as a,useEffect as n,useContext as s}from"/cdn/react";import{Globals as o}from"/Views/index.js";import{FastAverageColor as c}from"/cdn/fast-average-color";import l from"/Utils/load-css.js";import d from"/Components/card-template/svg-wrap.js";import i from"/Components/card-template/image-render.js";import m,{scaleFontSize as p}from"/Components/card-template/effect-text.js";import f from"/Components/card-template/keyword-renderer.js";import u from"/cdn/fitty";import g from"/Utils/datauri.js";import{speedOptions as y}from"/Components/card-config/edit-speed.js";import h from"/Utils/use-debounce-effect.js";const w=l("/Components/card-template/spell.css");function k(e){if(!e)return;return e.findLast((e=>y.some((r=>r===e))))}function b(e,r){if(!e)return;const t=e.filter((e=>!y.some((r=>e===r))));return r&&t.push(r),t}export default e((function(e){const l=s(o),y=t(),[w,x]=a("var(--color-dark, #777777)");h((()=>{let r=y.current;r||(r=y.current=new c);const t=e.art||"/Assets/spell/backdrop.png";r.getColorAsync(t).then((e=>{x(e.hex)})).catch(console.warn)}),200,[e.art]);const[N,U]=a(""),[D,$]=a(""),[v,j]=a(""),[A,C]=a(""),[I,z]=a(""),[L,W]=a([]),[S,q]=a("");n((()=>{g("/Assets/spell/background.png").then(U),g("/Assets/spell/backdrop.png").then($),g("/Assets/landmark/typing.png").then(z)}),[]),n((()=>{const r=`/Assets/spell/frame${e.speed||"trap"}.png`;g(r).then(j)}),[e.speed]),n((()=>{if(!e.faction||!e.faction.length)return;const r=`/Assets/spell/regionbox${e.faction.length>3?3:e.faction.length}.png`;g(r).then(C);const t=e.faction.map((e=>g(`/Assets/region/${e}.png`)));Promise.all(t).then(W)}),[e.faction&&e.faction.length]),n((()=>{if(e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity){const r=`/Assets/shared/gem${e.rarity}.png`;g(r).then(q)}else q("")}),[e.rarity]);const T=t(),B=t(),P=t(),V=t(),E=t(),F=t(),G=t(),H=t();h((()=>{p(T.current,70,16)}),200,[e.name,!!v]),h((()=>{p(B.current,40,16)}),200,[e.clan,!!v]),h((()=>{const e=F.current;if(e)e.fit();else{if(!P.current)return;F.current=u(P.current,{multiLine:!1,maxSize:90})}}),200,[e.mana,!!v]),h((()=>{if("number"!=typeof e.power)return;const r=G.current;if(r)r.fit();else{if(!V.current)return;G.current=u(V.current,{multiLine:!1,maxSize:70})}}),200,[e.power,!!v]),h((()=>{if("number"!=typeof e.health)return;const r=H.current;if(r)r.fit();else{if(!E.current)return;H.current=u(E.current,{multiLine:!1,maxSize:70})}}),200,[e.health,!!v]);const J=t();return J.current=e,n((()=>{const e=J.current,r=e.speed;if(!e.cardDataUpdaters)return;const t=k(e.keywords),a=b(e.keywords,r);if(!r||t===r){if(!e.keywords||!a)return;if(e.keywords.length===a.length)return;return e.cardDataUpdaters.keywords(a)}"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null)),e.cardDataUpdaters.keywords(a)}),[e.speed]),n((()=>{const e=J.current;if(!e.cardDataUpdaters)return;const r=k(e.keywords),t=b(e.keywords,r);e.speed!==r&&(e.cardDataUpdaters.speed(r),"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null))),t&&e.keywords&&t.length!==e.keywords.length&&e.cardDataUpdaters.keywords(t)}),[e.keywords]),d({loading:!v||e.loading,onTransform:e.updateTransform,...e.transform||{x:0,y:0,scale:1}},v?r({className:`${e.speed} spell`,id:e.id},r({className:"text-background",style:{backgroundColor:w}},r({className:"text-background-image",style:{backgroundImage:N?`url(${N})`:"none"}})),r({className:"art",style:{backgroundImage:l.state.defaultBg&&D?`url(${D})`:"none","--scale":e.transform?e.transform.scale:1,"--left":e.transform?e.transform.x:0,"--top":e.transform?e.transform.y:0}},r({className:"scale-adjuster"},i({url:e.art}))),r({className:"frame",style:{backgroundImage:v?`url(${v})`:"none"}}),r({className:"cost fitty-nowrap card-text-bold",ref:P},e.mana),e.faction&&e.faction.length?r({className:"region-frame",style:{backgroundImage:A?`url(${A})`:"none"}},L.map(((e,t)=>r({key:e,className:"region-icon region-icon-"+t,style:{backgroundImage:e?`url(${e})`:"none"}})))):void 0,e.clan?r({className:"clan",style:{backgroundImage:I?`url(${I})`:"none"}},r({ref:B,className:"text-area fitty-nowrap text-area fitty-nowrap"},e.clan)):void 0,e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity?r({className:`${e.rarity||"no"} rarity ${e.clan?"with-clan":""}`,style:{backgroundImage:S?`url(${S})`:"none"}}):void 0,"number"==typeof e.power?r({className:"power fitty-nowrap card-text-bold",ref:V},e.power||0):void 0,"number"==typeof e.health?r({className:"health fitty-nowrap card-text-bold",ref:E},e.health||0):void 0,r({className:"card-text-wrapper"},e.name?r({className:"name fitty-wrap card-text-bold",ref:T},e.name):void 0,e.keywords&&e.keywords.length?r({className:"keyword-container card-text-bold"},e.keywords.map((r=>f({key:r,name:r,size:e.keywords.length>1?"small":"large"})))):void 0,e.effect?m({blueWords:e.blueWords,orangeWords:e.orangeWords,className:"effect-container card-text-universe"},e.effect):void 0)):null)}),w);