import e,{div as r}from"/Utils/elements.js";import{useRef as t,useState as a,useEffect as n,useContext as s}from"/cdn/react";import{Globals as o}from"/Views/index.js";import{FastAverageColor as l}from"/cdn/fast-average-color";import c from"/Utils/load-css.js";import i from"/Components/card-template/svg-wrap.js";import d from"/Components/card-template/image-render.js";import m,{scaleFontSize as p}from"/Components/card-template/effect-text.js";import f from"/Components/card-template/keyword-renderer.js";import u from"/cdn/fitty";import g from"/Utils/datauri.js";import{speedOptions as y}from"/Components/card-config/edit-speed.js";import h from"/Utils/use-debounce-effect.js";import w from"/Utils/concurrency-manager.js";import k,{useAssetCacheDebounced as x}from"/Utils/use-asset-cache.js";import{AutoFitClanText as b}from"/Components/card-template/unit.js";import U from"/Utils/use-lang.js";const N=c("/Components/card-template/spell.css");function D(e){if(!e)return;return e.findLast((e=>y.some((r=>r===e))))}function j(e,r){if(!e)return;const t=e.filter((e=>!y.some((r=>e===r))));return r&&t.push(r),t}const v=new l;export default e((function(e){const a=s(o),l=U(),c=t();n((()=>{c.current=w()}),[]);const y=x((r=>{if(e.textBgColor)return r(e.textBgColor);const t=e.art||"/Assets/spell/backdrop.png";v.getColorAsync(t).then((e=>{r(e.hex)})).catch(console.warn)}),200,[e.textBgColor||e.art],"var(--color-dark, #777777)"),N=k((e=>{g("/Assets/spell/background.png").then(e)}),[]),$=k((e=>{g("/Assets/spell/backdrop.png").then(e)}),[]),C=k((e=>{g("/Assets/landmark/typing-2.png").then(e)}),[]),A=k((r=>{const t=`/Assets/spell/frame${e.speed||"trap"}.png`;g(t).then(r)}),[e.speed]),I=k((r=>{if(!e.faction||!e.faction.length)return;const t=`/Assets/spell/regionbox${e.faction.length>3?3:e.faction.length}.png`;g(t).then(r)}),[e.faction&&e.faction.length]),z=k((r=>{if(!e.faction||!e.faction.length)return;const t=e.faction.map((e=>g(`/Assets/region/${e}.png`)));Promise.all(t).then(r)}),[e.faction&&e.faction.length],[]),B=k((r=>{if(e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity){const t=`/Assets/shared/gem${e.rarity}.png`;g(t).then(r)}else r("")}),[e.rarity]),L=t(),T=(t(),t()),W=t(),q=t(),S=t(),O=t(),P=t(),V=t();h((()=>{A&&c.current.concurrent((()=>p(L.current,70,16)))}),200,[e.name,!!A]),h((()=>{if(!A)return;const e=O.current;if(e)e.fit();else{if(!T.current)return;O.current=u(T.current,{multiLine:!1,maxSize:90})}}),200,[e.mana,!!A]),h((()=>{if(!A)return;if("number"!=typeof e.power)return;const r=P.current;if(r)r.fit();else{if(!W.current)return;P.current=u(W.current,{multiLine:!1,maxSize:70})}}),200,[e.power,!!A]),h((()=>{if(!A)return;if("number"!=typeof e.health)return;const r=V.current;if(r)r.fit();else{if(!q.current)return;V.current=u(q.current,{multiLine:!1,maxSize:70})}}),200,[e.health,!!A]),h((()=>{A&&c.current.sequential((()=>p(S.current)))}),300,[!!e.name,!(!e.keywords||!e.keywords.length),e.effect,e.lvup,!!A]);const E=t();return E.current=e,n((()=>{const e=E.current,r=e.speed;if(!e.cardDataUpdaters)return;const t=D(e.keywords),a=j(e.keywords,r);if(!r||t===r){if(!e.keywords||!a)return;if(e.keywords.length===a.length)return;return e.cardDataUpdaters.keywords(a)}"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null));const n=l("elemental"),s=e.clan.indexOf(n);"elementalskill"===r?s<0&&e.cardDataUpdaters.clan([l("elemental"),...e.clan]):s>-1&&(e.clan.splice(s,1),e.cardDataUpdaters.clan(e.clan)),e.cardDataUpdaters.keywords(a)}),[e.speed]),n((()=>{const e=E.current;if(!e.cardDataUpdaters)return;const r=D(e.keywords),t=j(e.keywords,r);e.speed!==r&&(e.cardDataUpdaters.speed(r),"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null))),t&&e.keywords&&t.length!==e.keywords.length&&e.cardDataUpdaters.keywords(t)}),[e.keywords]),i({loading:!A||e.loading,onTransform:e.updateTransform,...e.transform||{x:0,y:0,scale:1}},A?r({className:`${e.speed} spell`,id:e.id},r({className:"text-background",style:{backgroundColor:y}},r({className:"text-background-image",style:{backgroundImage:N?`url(${N})`:"none"}})),r({className:"art",style:{backgroundImage:!e.art&&a.state.defaultBg&&$?`url(${$})`:"none","--scale":e.transform?e.transform.scale:1,"--left":e.transform?e.transform.x:0,"--top":e.transform?e.transform.y:0}},r({className:"scale-adjuster"},d({url:e.art}))),r({className:"frame",style:{backgroundImage:A?`url(${A})`:"none"}}),r({className:"cost fitty-nowrap card-text-bold card-text-outline",ref:T},e.mana),e.faction&&e.faction.length?r({className:"region-frame",style:{backgroundImage:I?`url(${I})`:"none"}},z.map(((e,t)=>r({key:e,className:"region-icon region-icon-"+t,style:{backgroundImage:e?`url(${e})`:"none"}})))):void 0,e.clan&&e.clan.length?r({className:"clan",style:{backgroundImage:C?`url(${C})`:"none"}},e.clan.map(((r,t)=>b({key:t,multiple:e.clan.length>1},r)))):void 0,e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity?r({className:`${e.rarity||"no"} rarity ${e.clan&&e.clan.length?"with-clan":""}`,style:{backgroundImage:B?`url(${B})`:"none"}}):void 0,"number"==typeof e.power?r({className:"power fitty-nowrap card-text-bold card-text-outline",ref:W},(e.power&&e.power>0?"+":"")+(e.power||0)):void 0,"number"==typeof e.health?r({className:"health fitty-nowrap card-text-bold card-text-outline",ref:q},(e.health&&e.health>0?"+":"")+(e.health||0)):void 0,r({className:"card-text-wrapper",ref:S},e.name?r({className:"name fitty-wrap card-text-bold card-text-outline",ref:L},e.name):void 0,e.keywords&&e.keywords.length?r({className:"keyword-container card-text-bold"},e.keywords.map((r=>f("string"==typeof r?{key:r,name:r,size:e.keywords.length>1?"small":"large"}:{name:r.name,icons:r.icons,key:r.id,size:e.keywords.length>1?"small":"large"})))):void 0,m({blueWords:e.blueWords,orangeWords:e.orangeWords,className:"effect-container card-text-universe",effectText:e.effect,levelText:e.lvup}))):null)}),N);