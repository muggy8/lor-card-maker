import e,{div as r}from"/Utils/elements.js";import{useRef as t,useState as a,useEffect as n,useContext as s}from"/cdn/react";import{Globals as o}from"/Views/index.js";import{FastAverageColor as c}from"/cdn/fast-average-color";import l from"/Utils/load-css.js";import d from"/Components/card-template/svg-wrap.js";import i from"/Components/card-template/image-render.js";import m,{scaleFontSize as p}from"/Components/card-template/effect-text.js";import f from"/Components/card-template/keyword-renderer.js";import u from"/cdn/fitty";import g from"/Utils/datauri.js";import{speedOptions as y}from"/Components/card-config/edit-speed.js";import h from"/Utils/use-debounce-effect.js";import w from"/Utils/concurrency-manager.js";const k=l("/Components/card-template/spell.css");function b(e){if(!e)return;return e.findLast((e=>y.some((r=>r===e))))}function x(e,r){if(!e)return;const t=e.filter((e=>!y.some((r=>e===r))));return r&&t.push(r),t}export default e((function(e){const l=s(o),y=t(),k=t();n((()=>{k.current=w()}),[]);const[U,N]=a("var(--color-dark, #777777)");h((()=>{let r=y.current;r||(r=y.current=new c);const t=e.art||"/Assets/spell/backdrop.png";r.getColorAsync(t).then((e=>{N(e.hex)})).catch(console.warn)}),200,[e.art]);const[v,D]=a(""),[$,j]=a(""),[A,C]=a(""),[I,z]=a(""),[L,T]=a(""),[W,q]=a([]),[S,B]=a("");n((()=>{g("/Assets/spell/background.png").then(D),g("/Assets/spell/backdrop.png").then(j),g("/Assets/landmark/typing.png").then(T)}),[]),n((()=>{const r=`/Assets/spell/frame${e.speed||"trap"}.png`;g(r).then(C)}),[e.speed]),n((()=>{if(!e.faction||!e.faction.length)return;const r=`/Assets/spell/regionbox${e.faction.length>3?3:e.faction.length}.png`;g(r).then(z);const t=e.faction.map((e=>g(`/Assets/region/${e}.png`)));Promise.all(t).then(q)}),[e.faction&&e.faction.length]),n((()=>{if(e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity){const r=`/Assets/shared/gem${e.rarity}.png`;g(r).then(B)}else B("")}),[e.rarity]);const P=t(),V=t(),E=t(),F=t(),G=t(),H=t(),J=t(),K=t(),M=t();h((()=>{A&&k.current.concurrent((()=>p(P.current,70,16)))}),200,[e.name,!!A]),h((()=>{A&&p(V.current,40,16)}),200,[e.clan,!!A]),h((()=>{if(!A)return;const e=J.current;if(e)e.fit();else{if(!E.current)return;J.current=u(E.current,{multiLine:!1,maxSize:90})}}),200,[e.mana,!!A]),h((()=>{if(!A)return;if("number"!=typeof e.power)return;const r=K.current;if(r)r.fit();else{if(!F.current)return;K.current=u(F.current,{multiLine:!1,maxSize:70})}}),200,[e.power,!!A]),h((()=>{if(!A)return;if("number"!=typeof e.health)return;const r=M.current;if(r)r.fit();else{if(!G.current)return;M.current=u(G.current,{multiLine:!1,maxSize:70})}}),200,[e.health,!!A]),h((()=>{A&&k.current.sequential((()=>p(H.current)))}),300,[!!e.name,!(!e.keywords||!e.keywords.length),e.effect,e.lvup,!!A]);const O=t();return O.current=e,n((()=>{const e=O.current,r=e.speed;if(!e.cardDataUpdaters)return;const t=b(e.keywords),a=x(e.keywords,r);if(!r||t===r){if(!e.keywords||!a)return;if(e.keywords.length===a.length)return;return e.cardDataUpdaters.keywords(a)}"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null)),e.cardDataUpdaters.keywords(a)}),[e.speed]),n((()=>{const e=O.current;if(!e.cardDataUpdaters)return;const r=b(e.keywords),t=x(e.keywords,r);e.speed!==r&&(e.cardDataUpdaters.speed(r),"equipment"===r?(e.cardDataUpdaters.power(0),e.cardDataUpdaters.health(0)):(e.cardDataUpdaters.power(null),e.cardDataUpdaters.health(null))),t&&e.keywords&&t.length!==e.keywords.length&&e.cardDataUpdaters.keywords(t)}),[e.keywords]),d({loading:!A||e.loading,onTransform:e.updateTransform,...e.transform||{x:0,y:0,scale:1}},A?r({className:`${e.speed} spell`,id:e.id},r({className:"text-background",style:{backgroundColor:U}},r({className:"text-background-image",style:{backgroundImage:v?`url(${v})`:"none"}})),r({className:"art",style:{backgroundImage:l.state.defaultBg&&$?`url(${$})`:"none","--scale":e.transform?e.transform.scale:1,"--left":e.transform?e.transform.x:0,"--top":e.transform?e.transform.y:0}},r({className:"scale-adjuster"},i({url:e.art}))),r({className:"frame",style:{backgroundImage:A?`url(${A})`:"none"}}),r({className:"cost fitty-nowrap card-text-bold",ref:E},e.mana),e.faction&&e.faction.length?r({className:"region-frame",style:{backgroundImage:I?`url(${I})`:"none"}},W.map(((e,t)=>r({key:e,className:"region-icon region-icon-"+t,style:{backgroundImage:e?`url(${e})`:"none"}})))):void 0,e.clan?r({className:"clan",style:{backgroundImage:L?`url(${L})`:"none"}},r({ref:V,className:"text-area fitty-nowrap text-area fitty-nowrap"},e.clan)):void 0,e.rarity&&"gemless"!==e.rarity&&"none"!==e.rarity?r({className:`${e.rarity||"no"} rarity ${e.clan?"with-clan":""}`,style:{backgroundImage:S?`url(${S})`:"none"}}):void 0,"number"==typeof e.power?r({className:"power fitty-nowrap card-text-bold",ref:F},e.power||0):void 0,"number"==typeof e.health?r({className:"health fitty-nowrap card-text-bold",ref:G},e.health||0):void 0,r({className:"card-text-wrapper",ref:H},e.name?r({className:"name fitty-wrap card-text-bold",ref:P},e.name):void 0,e.keywords&&e.keywords.length?r({className:"keyword-container card-text-bold"},e.keywords.map((r=>f({key:r,name:r,size:e.keywords.length>1?"small":"large"})))):void 0,m({blueWords:e.blueWords,orangeWords:e.orangeWords,className:"effect-container card-text-universe",effectText:e.effect,levelText:e.lvup}))):null)}),k);