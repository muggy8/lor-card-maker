import e,{div as t,span as n}from"/Utils/elements.js";import{keywords as r}from"/Components/card-template/keyword-renderer.js";import o,{useRef as s,useLayoutEffect as i,useState as l,useEffect as c}from"/cdn/react";import p from"/Utils/set-immediate-batch.js";import f from"/Utils/load-css.js";import a from"/Utils/datauri.js";import m from"/Utils/use-debounce-effect.js";const u=f("/Components/card-template/effect-text.css"),g=Object.keys(r).filter((e=>r[e].length));export const effectTextSize=24;const h=({clientWidth:e,clientHeight:t,scrollWidth:n,scrollHeight:r})=>n>e||r>t;function d(e,t){return(e+t)/2}function y(){return new Promise((e=>p(e)))}const w=new Map;export async function scaleFontSize(e,t=36,n=24){if(!e)return;let r=window.getComputedStyle(e).getPropertyValue("font-size");if(r=parseFloat(r),r==t&&!h(e))return;const o=w.get(e);if(o)return o;const s=new Promise((o=>{(async()=>{let s=t,i=n,l=r;for(;s-i>.5;){e.style.fontSize=`${l+.5}px`,await y();const t=h(e);e.style.fontSize=`${l}px`,await y();const n=h(e);if(!n&&t)return o();n?(s=l,l=d(s,i)):(i=l,l=d(s,i))}o()})()}));return w.set(e,s.then((()=>{w.delete(e)}))),w.get(e)}export const InlineIcon=e((function(e){const[t,r]=l("");return c((()=>{a(`/Assets/keyword/${e.pngName}`).then(r)}),[e.pngName]),n({className:"inline-icon",style:{"--icon-image":t?`url(${t})`:"none"}},e.children)}));export default e((function(c){let p=c.children;if(p&&"string"!=typeof p)throw new Error("Only strings accepted");let f=[...c.blueWords],a=[...c.orangeWords];f.sort(((e,t)=>t.length-e.length)),a.sort(((e,t)=>t.length-e.length));const[u,h]=l([]);m((()=>{let s=[p];g.forEach((e=>{const t=`<${e}/>`,n=r[e];s=s.map((e=>{if("string"!=typeof e)return e;let r=e.split(t);if(1===r.length)return r[0];for(let e=r.length-1;e;e--)r.splice(e,0,n.map((t=>InlineIcon({key:t+e,pngName:t}))));return r})).flat()})),f.forEach((e=>{e&&(s=s.map((t=>{if("string"!=typeof t)return t;let r=t.split(e);if(1===r.length)return r[0];for(let t=r.length-1;t;t--)r.splice(t,0,n({className:"blue-word"},e));return r})).flat())})),a.forEach((e=>{e&&(s=s.map((t=>{if("string"!=typeof t)return t;let r=t.split(e);if(1===r.length)return r[0];for(let t=r.length-1;t;t--)r.splice(t,0,n({className:"orange-word"},e));return r})).flat())})),s=s.map((e=>{if("string"!=typeof e)return e;let n=e.split(/\n+/g);if(1===n.length)return n[0];for(let e=n.length-1;e;e--)n.splice(e,0,t());return n})).flat(),s=s.filter((e=>!!e));for(let t=0;t<s.length;t++){const n=s[t];if("string"==typeof n)continue;if(!o.isValidElement(n))continue;if(!n.props.pngName)continue;const r={},i=[];Object.keys(n.props).forEach((e=>{r[e]=n.props[e]})),n.props.children&&!Array.isArray(n.props.children)&&i.push(n.props.children);let l=s[t+1];for(;l;)s.splice(t+1,1),i.push(l),l="string"!=typeof l||l.trim()?o.isValidElement(l)&&l.props.pngName?s[t+1]:void 0:s[t+1];s.splice(t,1,Function.apply.call(InlineIcon,e,[r,...i]))}h(s)}),200,[p,c.blueWords,c.orangeWords]);const d=s();return i((()=>{scaleFontSize(d.current)}),[u]),t.apply(e,[{className:`effect-text ${c.className||""}`,ref:d},...u])}),u);