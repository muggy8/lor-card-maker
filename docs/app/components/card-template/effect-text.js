import e,{div as t,span as r}from"/Utils/elements.js";import{keywords as n}from"/Components/card-template/keyword-renderer.js";import o,{useContext as l,useRef as s}from"/cdn/react";import i from"/Utils/set-immediate-batch.js";import a from"/Utils/load-css.js";import c from"/Utils/use-lang.js";import p from"/Utils/datauri.js";import{Globals as f}from"/Views/index.js";import{useAssetCache as u,useAssetCacheDebounced as m}from"/Utils/use-asset-cache.js";import g from"/Utils/use-debounce-effect.js";const d=a("/Components/card-template/effect-text.css"),h=Object.keys(n).filter((e=>n[e].length));export const effectTextSize=24;const y=({clientWidth:e,clientHeight:t,scrollWidth:r,scrollHeight:n})=>r>e||n>t;function w(e,t){return(e+t)/2}function N(){return new Promise((e=>i(e)))}function b(e){return e?new Promise((e=>requestAnimationFrame(e))):N()}const x=new Map;export async function scaleFontSize(e,t=36,r=24){if(!e)return b(scaleFontSize.lowPowerMode);const n=x.get(e);if(n)return n;let o,l=window.getComputedStyle(e).getPropertyValue("font-size");return l=parseFloat(l),o=l!=t||y(e)?new Promise((n=>{(async()=>{let o=t,s=r,i=l;async function a(){return await b(scaleFontSize.lowPowerMode),e.style.fontSize=`${Math.floor(i)}px`,n()}for(i>o?i=o:i<s&&(i=s);o-s>.5;){e.style.fontSize=`${i+.5}px`,await b(scaleFontSize.lowPowerMode);const t=y(e);e.style.fontSize=`${i}px`,await b(scaleFontSize.lowPowerMode);const r=y(e);if(!r&&t)return a();r?(o=i,i=w(o,s)):(s=i,i=w(o,s))}a()})()})):N(),x.set(e,o.then((()=>{x.delete(e)}))),x.get(e)}function W(l,s,i,a){let c=[l];h.forEach((e=>{const t=`<${e}/>`,r=n[e];c=c.map((e=>{if("string"!=typeof e)return e;let n=e.split(t);if(1===n.length)return n[0];for(let e=n.length-1;e;e--)n.splice(e,0,r.map((t=>InlineIcon({key:t+e,pngName:t}))));return n})).flat()})),a.forEach((e=>{const t=`<${e.id}/>`,r=e.icons;c=c.map((e=>{if("string"!=typeof e)return e;let n=e.split(t);if(1===n.length)return n[0];for(let e=n.length-1;e;e--)n.splice(e,0,r.map((t=>InlineIcon({key:t+"+"+e,url:t,className:"custom"}))));return n})).flat()})),s.forEach((e=>{e&&(c=c.map((t=>{if("string"!=typeof t)return t;let n=t.split(e);if(1===n.length)return n[0];for(let t=n.length-1;t;t--)n.splice(t,0,r({className:"blue-word card-text-no-outline"},e));return n})).flat())})),i.forEach((e=>{e&&(c=c.map((t=>{if("string"!=typeof t)return t;let n=t.split(e);if(1===n.length)return n[0];for(let t=n.length-1;t;t--)n.splice(t,0,r({className:"orange-word card-text-no-outline"},e));return n})).flat())})),c=c.map((e=>{if("string"!=typeof e)return e;let r=e.split(/\n+/g);if(1===r.length)return r[0];for(let e=r.length-1;e;e--)r.splice(e,0,t());return r})).flat(),c=c.filter((e=>!!e));for(let t=0;t<c.length;t++){const r=c[t];if("string"==typeof r)continue;if(!o.isValidElement(r))continue;if(!r.props.pngName)continue;const n={},l=[];Object.keys(r.props).forEach((e=>{n[e]=r.props[e]})),r.props.children&&!Array.isArray(r.props.children)&&l.push(r.props.children);let s=c[t+1];for(;s;)c.splice(t+1,1),l.push(s),s="string"!=typeof s||s.trim()?o.isValidElement(s)&&s.props.pngName?c[t+1]:void 0:c[t+1];c.splice(t,1,Function.apply.call(InlineIcon,e,[n,...l]))}return c}export const InlineIcon=e((function(e){const t=u((t=>{const r=e.url||`/Assets/keyword/${e.pngName}`;p(r).then(t)}),[e.pngName,e.url]);return r({className:"inline-icon "+(e.className||""),style:{"--icon-image":t?`url(${t})`:"none"}},e.children)}));export default e((function(r){let n=c(),o=r.effectText,i=r.levelText;if(o&&"string"!=typeof o||i&&"string"!=typeof i)throw new Error("Only strings accepted");const{customKeywords:a}=l(f),d=m((e=>{let t=r.blueWords?[...r.blueWords]:[],n=r.orangeWords?[...r.orangeWords]:[];t.sort(((e,t)=>t.length-e.length)),n.sort(((e,t)=>t.length-e.length));e(W(o,t,n,a))}),200,[o,r.blueWords,r.orangeWords],[]),h=m((e=>{let t=r.blueWords?[...r.blueWords]:[],n=r.orangeWords?[...r.orangeWords]:[];t.sort(((e,t)=>t.length-e.length)),n.sort(((e,t)=>t.length-e.length));e(W(i,t,n,a))}),200,[i,r.blueWords,r.orangeWords],[]),y=s();g((()=>{y.current&&scaleFontSize(y.current,36,24)}),150,[y.current]);const w=u((e=>{p("/Assets/champion/levelupbar.png").then(e)}),[]),N=t.apply(e,[{className:`effect-text ${r.className||""}`},...d]),b=t.apply(e,[{className:`effect-text level-color ${r.className||""}`},...h]);return o||i?t({className:"card-effects-wrapper"},o?N:void 0,i?t({className:"level-bar",style:{backgroundImage:w?`url(${w||""})`:"none"}},t({className:"level-bar-label",ref:y},n("lv_up"))):void 0,i?b:void 0):null}),d);