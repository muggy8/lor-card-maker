import e,{div as t,span as r}from"/Utils/elements.js";import{keywords as n}from"/Components/card-template/keyword-renderer.js";import o,{useContext as s,useState as l,useEffect as i}from"/cdn/react";import c from"/Utils/set-immediate-batch.js";import a from"/Utils/load-css.js";import p from"/Utils/datauri.js";import f from"/Utils/use-debounce-effect.js";import{Globals as u}from"/Views/index.js";const m=a("/Components/card-template/effect-text.css"),g=Object.keys(n).filter((e=>n[e].length));export const effectTextSize=24;const d=({clientWidth:e,clientHeight:t,scrollWidth:r,scrollHeight:n})=>r>e||n>t;function h(e,t){return(e+t)/2}function y(){return new Promise((e=>c(e)))}const w=new Map;export async function scaleFontSize(e,t=36,r=24){if(!e)return y();const n=w.get(e);if(n)return n;let o,s=window.getComputedStyle(e).getPropertyValue("font-size");return s=parseFloat(s),o=s!=t||d(e)?new Promise((n=>{(async()=>{let o=t,l=r,i=s;for(;o-l>.5;){e.style.fontSize=`${i+.5}px`,await y();const t=d(e);e.style.fontSize=`${i}px`,await y();const r=d(e);if(!r&&t)return n();r?(o=i,i=h(o,l)):(l=i,i=h(o,l))}n()})()})):y(),w.set(e,o.then((()=>{w.delete(e)}))),w.get(e)}function b(s,l,i,c){let a=[s];g.forEach((e=>{const t=`<${e}/>`,r=n[e];a=a.map((e=>{if("string"!=typeof e)return e;let n=e.split(t);if(1===n.length)return n[0];for(let e=n.length-1;e;e--)n.splice(e,0,r.map((t=>InlineIcon({key:t+e,pngName:t}))));return n})).flat()})),c.forEach((e=>{const t=`<${e.id}/>`,r=e.icons;a=a.map((e=>{if("string"!=typeof e)return e;let n=e.split(t);if(1===n.length)return n[0];for(let e=n.length-1;e;e--)n.splice(e,0,r.map((t=>InlineIcon({key:t+"+"+e,url:t}))));return n})).flat()})),l.forEach((e=>{e&&(a=a.map((t=>{if("string"!=typeof t)return t;let n=t.split(e);if(1===n.length)return n[0];for(let t=n.length-1;t;t--)n.splice(t,0,r({className:"blue-word"},e));return n})).flat())})),i.forEach((e=>{e&&(a=a.map((t=>{if("string"!=typeof t)return t;let n=t.split(e);if(1===n.length)return n[0];for(let t=n.length-1;t;t--)n.splice(t,0,r({className:"orange-word"},e));return n})).flat())})),a=a.map((e=>{if("string"!=typeof e)return e;let r=e.split(/\n+/g);if(1===r.length)return r[0];for(let e=r.length-1;e;e--)r.splice(e,0,t());return r})).flat(),a=a.filter((e=>!!e));for(let t=0;t<a.length;t++){const r=a[t];if("string"==typeof r)continue;if(!o.isValidElement(r))continue;if(!r.props.pngName)continue;const n={},s=[];Object.keys(r.props).forEach((e=>{n[e]=r.props[e]})),r.props.children&&!Array.isArray(r.props.children)&&s.push(r.props.children);let l=a[t+1];for(;l;)a.splice(t+1,1),s.push(l),l="string"!=typeof l||l.trim()?o.isValidElement(l)&&l.props.pngName?a[t+1]:void 0:a[t+1];a.splice(t,1,Function.apply.call(InlineIcon,e,[n,...s]))}return a}export const InlineIcon=e((function(e){const[t,n]=l("");return i((()=>{const t=e.url||`/Assets/keyword/${e.pngName}`;p(t).then(n)}),[e.pngName,e.url]),r({className:"inline-icon",style:{"--icon-image":t?`url(${t})`:"none"}},e.children)}));export default e((function(r){let n=r.effectText,o=r.levelText;if(n&&"string"!=typeof n||o&&"string"!=typeof o)throw new Error("Only strings accepted");const{customKeywords:c}=s(u),[a,m]=l([]);f((()=>{let e=r.blueWords?[...r.blueWords]:[],t=r.orangeWords?[...r.orangeWords]:[];e.sort(((e,t)=>t.length-e.length)),t.sort(((e,t)=>t.length-e.length));const o=b(n,e,t,c);m(o)}),200,[n,r.blueWords,r.orangeWords]);const[g,d]=l([]);f((()=>{let e=r.blueWords?[...r.blueWords]:[],t=r.orangeWords?[...r.orangeWords]:[];e.sort(((e,t)=>t.length-e.length)),t.sort(((e,t)=>t.length-e.length));const n=b(o,e,t,c);d(n)}),200,[o,r.blueWords,r.orangeWords]);const[h,y]=l("");i((()=>{p("/Assets/champion/levelupbar.png").then(y)}));const w=t.apply(e,[{className:`effect-text ${r.className||""}`},...a]),N=t.apply(e,[{className:`effect-text level-color ${r.className||""}`},...g]);return n||o?t({className:"card-effects-wrapper"},n?w:void 0,o?t({className:"level-bar",style:{backgroundImage:h?`url(${h||""})`:"none"}}):void 0,o?N:void 0):null}),m);