import e,{useContext as r,useRef as t,useEffect as n,useState as c}from"/cdn/react";import a,{svg as i,rect as s,foreignObject as o,div as u}from"/Utils/elements.js";import{svgRefference as l}from"/Views/card-editor.js";import d from"/cdn/gesto";import h from"/Utils/load-css.js";import m,{isSafari as g,isIOS as f}from"/cdn/react-device-detect";const p=h("/Components/card-template/svg-wrap.css");export default a((function(e){const a=r(l),h=t(),m=t({x:e.x||0,y:e.y||0,scale:e.scale||0}),p=t();p.current=e.onTransform;const[w,v]=c("inherit");n((()=>{if(!e.onTransform||!a.current)return;m.current.x=e.x||0,m.current.y=e.y||0,m.current.scale=e.scale||1;const r=h.current;r.addEventListener("wheel",n),v("grab");const t=new d(r,{container:a.current,preventClickEventOnDrag:!0,preventClickEventOnDragStart:!0,pinchOutside:!0,preventDefault:!0}).on("dragStart",(()=>{v("grabbing")})).on("drag",(e=>{m.current.x+=e.deltaX*(1/m.current.scale),m.current.y+=e.deltaY*(1/m.current.scale),p.current({...m.current})})).on("dragEnd",(()=>{v("grab")})).on("pinchStart",(e=>{e.datas.startScale=m.current.scale,v("grabbing")})).on("pinch",(e=>{m.current.scale=e.datas.startScale*e.scale,p.current({...m.current})})).on("pinchEnd",(()=>{v("grab")}));return p.current({...m.current}),function(){r.removeEventListener("wheel",n),t.unset(),v("inherit")};function n(e){e.preventDefault(),m.current.scale=m.current.scale*(1+e.deltaY/1e3),p.current({...m.current})}}),[!!e.onTransform,a.current]);const x=t(),[y,b]=c({});return n((()=>{if(g||f)return requestAnimationFrame(e),window.addEventListener("resize",e),function(){window.removeEventListener("resize",e)};function e(){const r=x.current.clientWidth,t=x.current.parentElement.clientWidth;if(!r||!t)return requestAnimationFrame(e);b({"--safari-scale-fix":t/r})}}),[e.loading]),u({style:y},i({width:e.width||"680",height:e.height||"1024",xmlns:"http://www.w3.org/2000/svg",viewBox:`0 0 ${e.width||"680"} ${e.height||"1024"}`,ref:e=>{e&&e!==a.current&&a.setRef(e)}},o({width:e.width||"680",height:e.height||"1024",style:{backgroundColor:"rgba(0,0,0,0)"},ref:x,className:g||f?"fix-safari":""},e.children,e.loading?u({className:"loading-shade"},u({className:"icon"},u({className:"loading"}))):void 0),s({x:0,y:0,width:e.width||"680",height:e.height||"1024",opacity:0,ref:h,style:{touchAction:"manipulation",cursor:w}})))}),p);