import{useContext as e,useRef as r,useEffect as t,useState as n}from"/cdn/react";import{isSafari as c,isIOS as i}from"/cdn/react-device-detect";import a from"/cdn/gesto";import s,{svg as o,rect as u,foreignObject as l,div as d,fragment as h}from"/Utils/elements.js";import{svgRefference as m}from"/Views/card-editor.js";import f from"/Utils/load-css.js";import g from"/Utils/use-asset-cache.js";const p=f("/Components/card-template/svg-wrap.css"),w=()=>{};export default s((function(s){const h=e(m),f=r({current:null,setRef:w}),p=s.isInclusion?f.current:h,v=r(),x=r({x:s.x||0,y:s.y||0,scale:s.scale||0}),b=r();b.current=s.onTransform;const[y,E]=n("inherit");t((()=>{if(!s.onTransform||!p.current)return;x.current.x=s.x||0,x.current.y=s.y||0,x.current.scale=s.scale||1;const e=v.current;e.addEventListener("wheel",t,{passive:!1}),E("grab");const r=new a(e,{container:p.current,preventClickEventOnDrag:!0,preventClickEventOnDragStart:!0,pinchOutside:!0,preventDefault:!0}).on("dragStart",(()=>{E("grabbing")})).on("drag",(e=>{x.current.x+=e.deltaX*(1/x.current.scale),x.current.y+=e.deltaY*(1/x.current.scale),b.current({...x.current})})).on("dragEnd",(()=>{E("grab")})).on("pinchStart",(e=>{e.datas.startScale=x.current.scale,E("grabbing")})).on("pinch",(e=>{x.current.scale=e.datas.startScale*e.scale,b.current({...x.current})})).on("pinchEnd",(()=>{E("grab")}));return b.current({...x.current}),function(){e.removeEventListener("wheel",t),r.unset(),E("inherit")};function t(e){return e.preventDefault(),e.stopPropagation(),x.current.scale=x.current.scale*(1+e.deltaY/1e3),b.current({...x.current}),!1}}),[!!s.onTransform,p.current]);const S=r(),j=g((e=>{if(c||i)return requestAnimationFrame(r),window.addEventListener("resize",r),function(){window.removeEventListener("resize",r)};function r(){const t=S.current.clientWidth,n=S.current.parentElement.clientWidth;if(!t||!n)return requestAnimationFrame(r);e({"--safari-scale-fix":n/t})}}),[s.loading]);return o({width:s.width||"680",height:s.height||"1024",xmlns:"http://www.w3.org/2000/svg",viewBox:`0 0 ${s.width||"680"} ${s.height||"1024"}`,ref:e=>{e&&e!==p.current&&p.setRef(e)}},l({width:s.width||"680",height:s.height||"1024",style:{backgroundColor:"rgba(0,0,0,0)",...j},ref:S,className:c||i?"fix-safari":""},s.children,s.loading?d({className:"loading-shade"},d({className:"icon loading"})):void 0,d({ref:v,className:"ios-gesture-receiver"})),c||i?void 0:u({x:0,y:0,width:s.width||"680",height:s.height||"1024",opacity:0,ref:v,style:{touchAction:"manipulation",cursor:y}}))}),p);