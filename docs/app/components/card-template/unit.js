import factory,{div}from"/Utils/elements.js";import{Component,createRef}from"/cdn/react";import{Globals}from"/Views/index.js";import KeywordRenderer from"/Components/card-template/keyword-renderer.js";import ArtRenderer from"/Components/card-template/image-render.js";import EffectText,{scaleFontSize}from"/Components/card-template/effect-text.js";import loadCss from"/Utils/load-css.js";import SvgWrap from"/Components/card-template/svg-wrap.js";import fitty from"/cdn/fitty";import datauri from"/Utils/datauri.js";import{defaultShade}from"/Views/list.js";import debounce from"/Utils/debounce-function.js";const cssLoaded=loadCss("/Components/card-template/unit.css");export class UnitRendererComponent extends Component{clipPathPolygon=[[25,50],[655,50],[655,950],[340,965],[25,950]];state={};cardFrame="/Assets/champion/frame1.png";clanFrame="/Assets/champion/typing.png";regionPosition="champion";static get contextType(){return Globals}constructor(t){super(t),this.clanRef=createRef(),this.costRef=createRef(),this.powerRef=createRef(),this.healthRef=createRef(),this.nameRef=createRef(),this.fitClan=debounce(()=>this.clanRef.current&&scaleFontSize(this.clanRef.current,40,16)),this.fitName=debounce(()=>this.nameRef.current&&scaleFontSize(this.nameRef.current,70,16)),this.fitCost=debounce(()=>{this.costRef.current&&(this.costFitty?this.costFitty.fit():this.costFitty=fitty(this.costRef.current,{multiLine:!1,maxSize:90}))}),this.fitPower=debounce(()=>{this.powerRef.current&&(this.powerFitty?this.powerFitty.fit():this.powerFitty=fitty(this.powerRef.current,{multiLine:!1,maxSize:70}))}),this.fitHealth=debounce(()=>{this.healthRef.current&&(this.healthFitty?this.healthFitty.fit():this.healthFitty=fitty(this.healthRef.current,{multiLine:!1,maxSize:70}))})}getRegionFrameUrl(){let t=this.props.faction.length;return t>3&&(t=3),`/Assets/champion/lvl1regionbox${t}.png`}componentDidMount(){const{fitClan:t,fitCost:e,fitPower:r,fitHealth:s,fitName:i}=this;if(t(),e(),r(),s(),i(),this.fetchUrlAsUriAndStoreInState("/Assets/champion/backdrop.png","backdropUri"),this.fetchUrlAsUriAndStoreInState(this.cardFrame,"frameUri"),this.fetchUrlAsUriAndStoreInState(this.clanFrame,"clanFrameUri"),this.fetchUrlAsUriAndStoreInState("/Assets/champion/levelupbar.png","levelupBarUri"),this.props.rarity&&"gemless"!==this.props.rarity&&this.fetchUrlAsUriAndStoreInState(`/Assets/shared/gem${this.props.rarity}.png`,"rarityUri"),this.props.faction&&this.props.faction.length){const t=this.props.faction.map(t=>datauri(`/Assets/region/${t}.png`));Promise.all(t).then(t=>{this.setState(e=>({...e,factionUri:t}))}),this.fetchUrlAsUriAndStoreInState(this.getRegionFrameUrl(),"regionFrameUri")}}fetchUrlAsUriAndStoreInState(t,e){datauri(t).then(t=>{this.setState(r=>({...r,[e]:t}))})}componentDidUpdate(t,e){const{clan:r,cost:s,power:i,health:a,name:o}=this.props,{fitClan:n,fitCost:p,fitPower:h,fitHealth:l,fitName:c}=this,d=!!this.state.frameUri!=!!e.frameUri;if((t.clan!==r||d)&&n(),(t.cost!==s||d)&&p(),(t.power!==i||d)&&h(),(t.health!==a||d)&&l(),(t.name!==o||d)&&c(),t.rarity!==this.props.rarity&&"gemless"!==this.props.rarity&&"none"!==this.props.rarity&&this.fetchUrlAsUriAndStoreInState(`/Assets/shared/gem${this.props.rarity}.png`,"rarityUri"),this.props.faction&&this.props.faction.length&&t.faction!==this.props.faction){const t=this.props.faction.map(t=>datauri(`/Assets/region/${t}.png`));Promise.all(t).then(t=>{this.setState(e=>({...e,factionUri:t}))}),this.fetchUrlAsUriAndStoreInState(this.getRegionFrameUrl(),"regionFrameUri")}}render(){const t=this.props.shade||defaultShade,[e,r]=t.gradientLocation;return SvgWrap({loading:!this.state.frameUri||this.props.loading,onTransform:this.props.updateTransform,...this.props.transform||{x:0,y:0,scale:1}},this.state.frameUri?div({style:{"--background-image":this.context.state.defaultBg?`url(${this.state.backdropUri||""})`:"none","--scale":this.props.transform?this.props.transform.scale:1,"--left":this.props.transform?this.props.transform.x:0,"--top":this.props.transform?this.props.transform.y:0,"--blur":t.blur+"px","--darkness":t.darkness,"--transparent-percent":e+"%","--solid-percent":r+"%"},className:"unit "+this.regionPosition,id:this.props.id},div({className:"art",style:{clipPath:`polygon(${this.clipPathPolygon.map(t=>t.map(t=>t+"px").join(" ")).join(",")})`}},div({className:"scale-adjuster"},ArtRenderer({url:this.props.art}))),div({className:"art blur",style:{clipPath:`polygon(${this.clipPathPolygon.map(t=>t.map(t=>t+"px").join(" ")).join(",")})`}},div({className:"scale-adjuster"},ArtRenderer({url:this.props.art}))),div({className:"card-text-wrapper"},this.props.name?div({className:"name fitty-wrap card-text-bold",ref:this.nameRef},this.props.name):void 0,this.props.keywords&&this.props.keywords.length?div({className:"keyword-container card-text-bold"},this.props.keywords.map(t=>KeywordRenderer({key:t,name:t,size:this.props.keywords.length>1?"small":"large"}))):void 0,this.props.effect?EffectText({blueWords:this.props.blueWords,orangeWords:this.props.orangeWords,className:"effect-container card-text-universe"},this.props.effect):void 0,this.props.lvup?div({className:"level-bar",style:{backgroundImage:this.state.levelupBarUri?`url(${this.state.levelupBarUri||""})`:"none"}}):void 0,this.props.lvup?EffectText({blueWords:this.props.blueWords,orangeWords:this.props.orangeWords,className:"level-up-container card-text-universe"},this.props.lvup):void 0),div({className:"frame",style:{backgroundImage:this.state.frameUri?`url(${this.state.frameUri||""})`:"none"}}),div({className:"cost fitty-nowrap card-text-bold",ref:this.costRef},this.props.mana),this.props.faction&&this.props.faction.length?div({className:"region-frame",style:{backgroundImage:this.state.regionFrameUri?`url(${this.state.regionFrameUri||""})`:"none"}},this.state.factionUri?this.state.factionUri.map(t=>div({key:t,className:"region-icon",style:{backgroundImage:`url(${t})`}})):null):void 0,this.props.clan?div({className:"clan",style:{backgroundImage:this.state.clanFrameUri?`url(${this.state.clanFrameUri||""})`:"none"}},div({ref:this.clanRef,className:"card-text-universe-condensed text-area fitty-nowrap"},this.props.clan)):void 0,void 0!==this.props.power?div({className:"power fitty-nowrap card-text-bold",ref:this.powerRef},this.props.power):void 0,void 0!==this.props.health?div({className:"health fitty-nowrap card-text-bold",ref:this.healthRef},this.props.health):void 0,this.props.rarity&&"gemless"!==this.props.rarity&&"none"!==this.props.rarity?div({className:"rarity "+this.props.rarity,style:{backgroundImage:this.state.rarityUri?`url(${this.state.rarityUri||""})`:"none"}}):void 0):void 0)}}export default factory(UnitRendererComponent,cssLoaded);