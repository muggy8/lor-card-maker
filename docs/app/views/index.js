import{useState as t,useCallback as e,useEffect as o,useRef as n,createContext as s,createElement as i}from"/cdn/react";import r from"/Utils/elements.js";import c from"/Views/list.js";import{BannerBar as a,SideBar as l}from"/Components/index.js";import{getSettings as p,saveSettings as d,getCardList as u}from"/Utils/service.js";export const Globals=s({lang:"en",card:null});export let navigationHistory=[];export default r((function(s){const[r,m]=t({lang:"en",view:c,defaultBg:!0,settings:{}});let g={...r};const w=e((t=>{let e={...g,...t};Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),g=e;Object.keys(e).map((t=>e[t]!==r[t])).reduce(((t,e)=>t||e),!1)&&m(e)}),[r,m]);o((()=>{p().then((t=>w({settings:t})))}),[]);const[v,y]=t([]),h=e((()=>u({only:"keyword"}).then(y)),[]);o((()=>{h()}),[]);const f=e((t=>{const e={...r.settings,...t};w({settings:e}),d(e)}),[r.settings,w]),H=n();o((()=>{H.current=w}),[w]);const S=n((()=>!0));o((()=>{navigationHistory.push(r.view);const t=function(t){if(!1===S.current())return t.preventDefault(),t.stopPropagation(),void history.pushState({},"");navigationHistory.splice(-1,1);const e=navigationHistory[navigationHistory.length-1];if(!e)return navigationHistory.push(r.view),H.current({view:c});h(),H.current({view:e})};return window.addEventListener("popstate",t),function(){window.removeEventListener("popstate",t)}}),[]);const b=e((t=>{window.scrollTo(0,0),requestAnimationFrame((()=>{H.current({view:t}),history.pushState({},""),navigationHistory.push(t)}))}),[]);return o((()=>{if(!s.root)return;const t=(r.bannerHeight||0)+"px";s.root.style.setProperty("padding-top",t),s.root.style.setProperty("--banner-height",t),!0!==r.settings.lowSpecsMode||document.documentElement.classList.contains("low-spec-mode")?!0!==r.settings.lowSpecsMode&&document.documentElement.classList.contains("low-spec-mode")&&document.documentElement.classList.remove("low-spec-mode"):document.documentElement.classList.add("low-spec-mode")}),[r.bannerHeight,s.root,r.settings.lowSpecsMode]),i(Globals.Provider,{value:{state:r,setState:m,patchState:w,setView:b,patchSettings:f,getAllowBack:()=>S.current,customKeywords:v,setAllowBack:t=>{S.current=t}}},a(),l(),r.view())}));