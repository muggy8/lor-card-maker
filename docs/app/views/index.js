import{useState as t,useCallback as e,useEffect as o,useRef as s,createContext as n,createElement as i}from"/cdn/react";import r from"/Utils/elements.js";import c from"/Views/list.js";import{BannerBar as a,SideBar as l}from"/Components/index.js";import{getSettings as p,saveSettings as d,getCardList as m}from"/Utils/service.js";import{scaleFontSize as u}from"/Components/card-template/effect-text.js";export const Globals=n({lang:"en",card:null});export let navigationHistory=[];export default r((function(n){const[r,w]=t({lang:"en",view:c,defaultBg:!0,settings:{}});o((()=>{u.lowSpecsMode=!!r.settings.lowSpecsMode}),[r.settings.lowSpecsMode]);let g={...r};const v=e((t=>{let e={...g,...t};Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),g=e;Object.keys(e).map((t=>e[t]!==r[t])).reduce(((t,e)=>t||e),!1)&&w(e)}),[r,w]);o((()=>{p().then((t=>v({settings:t})))}),[]);const[f,y]=t([]),h=e((()=>m({only:"keyword"}).then(y)),[]);o((()=>{h()}),[]);const S=e((t=>{const e={...r.settings,...t};v({settings:e}),d(e)}),[r.settings,v]),H=s();o((()=>{H.current=v}),[v]);const b=s((()=>!0));o((()=>{navigationHistory.push(r.view);const t=function(t){if(!1===b.current())return t.preventDefault(),t.stopPropagation(),void history.pushState({},"");navigationHistory.splice(-1,1);const e=navigationHistory[navigationHistory.length-1];if(!e)return navigationHistory.push(r.view),H.current({view:c});h(),H.current({view:e})};return window.addEventListener("popstate",t),function(){window.removeEventListener("popstate",t)}}),[]);const j=e((t=>{window.scrollTo(0,0),requestAnimationFrame((()=>{H.current({view:t}),history.pushState({},""),navigationHistory.push(t)}))}),[]);return o((()=>{if(!n.root)return;const t=(r.bannerHeight||0)+"px";n.root.style.setProperty("padding-top",t),n.root.style.setProperty("--banner-height",t),!0!==r.settings.lowSpecsMode||document.documentElement.classList.contains("low-spec-mode")?!0!==r.settings.lowSpecsMode&&document.documentElement.classList.contains("low-spec-mode")&&document.documentElement.classList.remove("low-spec-mode"):document.documentElement.classList.add("low-spec-mode")}),[r.bannerHeight,n.root,r.settings.lowSpecsMode]),i(Globals.Provider,{value:{state:r,setState:w,patchState:v,setView:j,patchSettings:S,getAllowBack:()=>b.current,customKeywords:f,setAllowBack:t=>{b.current=t}}},a(),l(),r.view())}));