import{useState as t,useCallback as e,useEffect as o,useRef as s,createContext as n,createElement as i}from"/cdn/react";import r from"/Utils/elements.js";import c from"/Views/list.js";import{BannerBar as a,SideBar as l}from"/Components/index.js";import{getSettings as p,saveSettings as d,getCardList as m}from"/Utils/service.js";import{scaleFontSize as u}from"/Components/card-template/effect-text.js";import{SUPPORTED_LANGUAGES as g}from"/Utils/use-lang.js";export const Globals=n({lang:"en_us",card:null,translations:{}});export let navigationHistory=[];export default r((function(n){const[r,w]=t({}),[v,f]=t({view:c,defaultBg:!0,settings:{lang:"en_us"}});o((()=>{u.lowSpecsMode=!!v.settings.lowSpecsMode}),[v.settings.lowSpecsMode]);let h={...v};const y=e((t=>{let e={...h,...t};Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),h=e;Object.keys(e).map((t=>e[t]!==v[t])).reduce(((t,e)=>t||e),!1)&&f(e)}),[v,f]);o((()=>{let t={};const e=(e,o)=>{t={...t,[e]:o},w(t)};g.map((t=>{fetch(`/Assets/lang/${t}.json`).then((t=>t.json())).then(e.bind(null,t))}))}),[w]),o((()=>{p().then((t=>y({settings:t})))}),[]);const[S,j]=t([]),H=e((()=>m({only:"keyword"}).then(j)),[]);o((()=>{H()}),[]);const b=e((t=>{const e={...v.settings,...t};y({settings:e}),d(e)}),[v.settings,y]),E=s();o((()=>{E.current=y}),[y]);const x=s((()=>!0));o((()=>{navigationHistory.push(v.view);const t=function(t){if(!1===x.current())return t.preventDefault(),t.stopPropagation(),void history.pushState({},"");navigationHistory.splice(-1,1);const e=navigationHistory[navigationHistory.length-1];if(!e)return navigationHistory.push(v.view),E.current({view:c});H(),E.current({view:e})};return window.addEventListener("popstate",t),function(){window.removeEventListener("popstate",t)}}),[]);const L=e((t=>{window.scrollTo(0,0),requestAnimationFrame((()=>{E.current({view:t}),history.pushState({},""),navigationHistory.push(t)}))}),[]);return o((()=>{if(!n.root)return;const t=(v.bannerHeight||0)+"px";n.root.style.setProperty("padding-top",t),n.root.style.setProperty("--banner-height",t),!0!==v.settings.lowSpecsMode||document.documentElement.classList.contains("low-spec-mode")?!0!==v.settings.lowSpecsMode&&document.documentElement.classList.contains("low-spec-mode")&&document.documentElement.classList.remove("low-spec-mode"):document.documentElement.classList.add("low-spec-mode")}),[v.bannerHeight,n.root,v.settings.lowSpecsMode]),i(Globals.Provider,{value:{state:v,setState:f,patchState:y,translations:r,setView:L,patchSettings:b,getAllowBack:()=>x.current,customKeywords:S,setAllowBack:t=>{x.current=t}}},a(),l(),v.view())}));