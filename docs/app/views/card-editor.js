import e,{div as t,button as a,strong as o,section as r}from"/Utils/elements.js";import n from"/Utils/load-css.js";import s from"/Utils/use-lang.js";import l,{useState as c,useCallback as i,useContext as d,createContext as u,useRef as m,useLayoutEffect as p,useEffect as f}from"/cdn/react";import{Globals as g}from"/Views/index.js";import{getCard as b,saveCard as v,deleteCard as h}from"/Utils/service.js";import w from"/Utils/set-immediate-batch.js";import x from"/Components/card-config/edit-name.js";import N from"/Components/card-config/edit-number.js";import j from"/Components/card-config/edit-region.js";import V from"/Components/card-config/edit-rarity.js";import y from"/Components/card-config/edit-keywords.js";import k from"/Components/card-config/edit-effect.js";import C from"/Components/card-config/edit-speed.js";import _ from"/Components/card-config/edit-colored-text.js";import W from"/Components/card-config/edit-art.js";import U from"/Components/card-config/edit-shade.js";import L from"/Components/card-config/edit-icon.js";import{defaultShade as O}from"/Views/list.js";import R from"/Utils/use-toggle.js";import A from"/Utils/debounce-function.js";import I from"/Components/card-config/edit-checkbox.js";import E from"/Components/export.js";const S=n("/Views/card-editor.css");function B(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=u({current:null,setRef:()=>{}});export default function F(n,u){const F=Object.keys(u);F.sort();return e((function(){const e=s(),S=d(g),D=m();D.current=S,f((()=>{const e=S.getAllowBack();return D.current.setAllowBack((()=>document.documentElement.scrollTop>100?(w((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:"smooth"}))),!1):e())),function(){D.current.setAllowBack(e)}}),[]);const[T,z]=c(u);f((()=>(S.state.cardId&&b(S.state.cardId).then(z),()=>{D.current.patchState({cardId:""})})),[]);let M={...T};const P=F.reduce(((e,t)=>(e[t]=i((e=>{if(e&&e.preventDefault&&(e=e.target.value),e===T[t])return;const a={...M};a[t]=e,M=a,z(a)}),F.map((e=>T[e]))),e)),{}),[q,H]=c(null),[J,$,G]=R(!1),K=i((()=>{J||(G(!0),E(T,q,S).then((()=>G(!1)),(e=>console.warn(e)+G(!1))))}),[q,J,S,T]),Q=m(),[X,Y]=c(0),[Z,ee]=c(0);p((()=>{const e=A((function(){let e=Q.current.parentNode.clientWidth;const t=getComputedStyle(Q.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),Y(e),ee(Q.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(Q.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[te,ae,oe]=R(!0),[re,ne,se]=R(!1);return f((()=>{oe(!0)}),F.map((e=>T[e]))),r({id:"card-editor",className:"flex hcenter"},t({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4",style:{paddingBottom:Z+"px"}},t({className:"preview-content",ref:Q,style:{width:X+"px"}},t({className:"gutter-rl-2"},l.createElement(svgRefference.Provider,{value:{current:q,setRef:H}},n({...T,cardDataUpdaters:P,updateTransform:T.art&&S.state.moveableArt?P.transform:void 0,loading:J||re}))),t({className:"flex hcenter gutter-tb"},t({className:"gutter-rl-.5"},a({className:`gutter-trbl-.5 ${T.id?void 0:"hide"}`,onClick:()=>{h(T.id).then((()=>{document.location.reload()}))}},o(e("delete_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:()=>{if(!te||re)return;function e(){oe(!1),se(!1)}if(se(!0),T.id)return v(T.id,T).then(e,e);const t=Date.now().toString();v(t,T).then(e,e),P.id(t)},[te||!se?"data-foo":"disabled"]:!0},o(e("save_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:K,[J?"disabled":"data-foo"]:!0},o(e("share"))))))),t({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4"},B("name",u)?t({className:"flex hcenter gutter-b-2"},x({label:e("name"),value:T.name,updateValue:P.name})):void 0,B("icons",u)?t({className:"flex hcenter gutter-b-2"},L({value:T.icons,updateValue:P.icons})):void 0,B("largerIcon",u)?t({className:"gutter-b-2"},I({label:e("larger_icon"),value:T.largerIcon,updateValue:P.largerIcon})):void 0,B("mana",u)?t({className:"gutter-b-2"},N({label:e("mana_cost"),value:T.mana,updateValue:P.mana})):void 0,B("speed",u)?C({value:T.speed,updateValue:P.speed}):void 0,B("power",u)&&B("health",u)&&null!==T.power&&null!==T.health?t({className:"flex-l no-wrap"},N({className:"block gutter-b-2",label:e("power"),value:T.power,updateValue:P.power}),N({className:"block gutter-b-2",label:e("health"),value:T.health,updateValue:P.health})):void 0,B("faction",u)?j({value:T.faction,updateValue:P.faction}):void 0,B("art",u)?t({className:"gutter-b-2"},W({value:T.art,updateValue:P.art})):void 0,B("shade",u)?t({className:"gutter-b-2"},U({label:e("card_art"),value:T.shade||O,updateValue:P.shade})):void 0,B("rarity",u)?V({value:T.rarity,updateValue:P.rarity}):void 0,B("keywords",u)?y({value:T.keywords,updateValue:P.keywords}):void 0,B("effect",u)?k({value:T.effect,updateValue:P.effect,orangeWords:T.orangeWords,updateOrangeWords:P.orangeWords,label:e("effect")}):void 0,B("lvup",u)?k({value:T.lvup,updateValue:P.lvup,orangeWords:T.orangeWords,updateOrangeWords:P.orangeWords,label:e("lv_up")}):void 0,B("blueWords",u)?_({label:e("other_card_mentioned"),subLabel:e("other_card_example"),value:T.blueWords,updateValue:P.blueWords}):void 0,B("orangeWords",u)?_({label:e("key_text_mentioned"),subLabel:e("key_text_example"),value:T.orangeWords,updateValue:P.orangeWords}):void 0,B("clan",u)?t({className:"gutter-b-2"},x({label:e("clan"),value:T.clan,updateValue:P.clan})):void 0))}),S)}export async function openUri(e,t="export.png"){console.log(e);const a=/data:([^;]+);(([^;]+);)*base64,/.exec(e);console.log(a);const[o,r]=a,n=await fetch(e).then((e=>e.blob())),s=new File([n],t,{type:n.type});if("share"in navigator&&"canShare"in navigator&&navigator.canShare({files:[s]}))navigator.share({files:[s]}).catch((e=>{if("AbortError"===e.name||"share canceled"===e.message.toLowerCase())return;const t=URL.createObjectURL(n);window.open(t,"_blank")}));else if(window.AndroidNativeInterface){const a=JSON.stringify({image:e.substr(o.length),fileName:t});window.AndroidNativeInterface.postMessage(a)}else{const e=URL.createObjectURL(n);window.open(e,"_blank")}}