import e,{div as t,button as a,strong as o,section as r}from"/Utils/elements.js";import n from"/Utils/load-css.js";import s from"/Utils/use-lang.js";import l,{useState as i,useCallback as d,useContext as c,createContext as u,useRef as m,useLayoutEffect as p,useEffect as f}from"/cdn/react";import{Globals as g}from"/Views/index.js";import{getCard as b,saveCard as v,deleteCard as h}from"/Utils/service.js";import w from"/Utils/set-immediate-batch.js";import x from"/Components/card-config/edit-name.js";import N from"/Components/card-config/edit-poc-type.js";import j from"/Components/card-config/edit-number.js";import C from"/Components/card-config/edit-region.js";import y from"/Components/card-config/edit-rarity.js";import V from"/Components/card-config/edit-rarity-poc.js";import W from"/Components/card-config/edit-keywords.js";import _ from"/Components/card-config/edit-effect.js";import k from"/Components/card-config/edit-speed.js";import U from"/Components/card-config/edit-colored-text.js";import B from"/Components/card-config/edit-art.js";import A from"/Components/card-config/edit-shade.js";import R from"/Components/card-config/edit-icon.js";import I from"/Components/card-config/edit-checkbox.js";import L from"/Components/card-config/edit-associated-cards.js";import{defaultShade as O}from"/Views/list.js";import S from"/Utils/use-toggle.js";import E from"/Utils/debounce-function.js";import T from"/Components/export.js";import D from"/Components/card-config/edit-file-name.js";import F from"/Components/card-config/edit-color.js";const M=n("/Views/card-editor.css");function z(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=u({current:null,setRef:()=>{}});export default function P(n,u){const P=Object.keys(u);P.sort();const q=e((function(){const e=s(),M=c(g),q=m();q.current=M,f((()=>{const e=M.getAllowBack();return q.current.setAllowBack((()=>{if(document.documentElement.scrollTop>100){const e=!0===q.current.state.settings.lowSpecsMode;return w((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){q.current.setAllowBack(e)}}),[]);const[H,J]=i(u);f((()=>(M.state.cardId&&b(M.state.cardId).then(J),()=>{q.current.patchState({cardId:""})})),[]);let $={...H};const G=P.reduce(((e,t)=>(e[t]=d((e=>{if(e&&e.preventDefault&&(e=e.target.value),e===H[t])return;const a={...$};a[t]=e,$=a,J(a)}),P.map((e=>H[e]))),e)),{}),[K,Q]=i(null),[X,Y,Z]=S(!1),ee=d((()=>{X||(Z(!0),T(H,K,M).then((()=>Z(!1)),(e=>console.warn(e)+Z(!1))))}),[K,X,M,H]),te=m(),[ae,oe]=i(0),[re,ne]=i(0);p((()=>{const e=E((function(){let e=te.current.parentNode.clientWidth;const t=getComputedStyle(te.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),oe(e),ne(te.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(te.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[se,le,ie]=S(!0),[de,ce,ue]=S(!1);return f((()=>{ie(!0)}),P.map((e=>H[e]))),r({id:"card-editor",className:"flex hcenter"},t({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6",style:{paddingBottom:re+"px"}},t({className:"preview-content",ref:te,style:{width:ae+"px"}},t({className:"gutter-rl-2"},l.createElement(svgRefference.Provider,{value:{current:K,setRef:Q}},n({...H,cardDataUpdaters:G,updateTransform:H.art&&(M.state.moveableArt?G.transform:void 0),loading:X||de}))),t({className:"flex hcenter gutter-tb"},t({className:"gutter-rl-.5"},a({className:`gutter-trbl-.5 ${H.id?void 0:"hide"}`,onClick:()=>{confirm(e("confirm_delete"))&&h(H.id).then((()=>{document.location.reload()}))}},o(e("delete_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:()=>{if(!se||de)return;function e(){ie(!1),ue(!1)}if(ue(!0),H.id)return v(H.id,H).then(e,e);const t=Date.now().toString();v(t,H).then(e,e),G.id(t)},[se||!ue?"data-foo":"disabled"]:!0},o(e("save_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:ee,[X?"disabled":"data-foo"]:!0},o(e("share"))))))),t({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6"},z("name",u)?t({className:"flex hcenter gutter-b-2"},x({label:e("name"),value:H.name,updateValue:G.name})):void 0,z("fileName",u)?t({className:"flex hcenter gutter-b-2"},D({label:e("file_name"),value:H.fileName,placeholder:H.name,updateValue:G.fileName})):void 0,z("pocType",u)?N({value:H.pocType,updateValue:G.pocType}):void 0,z("icons",u)?t({className:"flex hcenter gutter-b-2"},R({value:H.icons,updateValue:G.icons})):void 0,z("largerIcon",u)?t({className:"gutter-b-2"},I({label:e("larger_icon"),value:H.largerIcon,updateValue:G.largerIcon})):void 0,z("mana",u)?t({className:"gutter-b-2"},j({label:e("mana_cost"),value:H.mana,updateValue:G.mana})):void 0,z("clan",u)?t({className:"gutter-b-2"},U({label:e("clan"),value:H.clan,updateValue:G.clan})):void 0,z("speed",u)?k({value:H.speed,updateValue:G.speed}):void 0,z("power",u)&&z("health",u)&&null!==H.power&&null!==H.health?t({className:"flex-l no-wrap"},j({className:"block gutter-b-2",label:e("power"),value:H.power,updateValue:G.power}),j({className:"block gutter-b-2",label:e("health"),value:H.health,updateValue:G.health})):void 0,z("faction",u)?C({value:H.faction,updateValue:G.faction}):void 0,z("art",u)?t({className:"gutter-b-2"},B({label:e("card_art"),value:H.art,updateValue:G.art})):void 0,z("shade",u)?A({label:e("card_art"),value:H.shade||O,updateValue:G.shade}):void 0,z("textBgColor",u)?t({className:"gutter-b-2"},F({label:e("text_background_color"),value:H.textBgColor,updateValue:G.textBgColor,cardArt:H.art})):void 0,z("rarity",u)?"poc"===H.type?V({value:H.rarity,updateValue:G.rarity}):y({value:H.rarity,updateValue:G.rarity}):void 0,z("keywords",u)?W({value:H.keywords,updateValue:G.keywords}):void 0,z("effect",u)?_({value:H.effect,updateValue:G.effect,orangeWords:H.orangeWords,updateOrangeWords:G.orangeWords,blueWords:H.blueWords,updateBlueWords:G.blueWords,label:e("effect")}):void 0,z("lvup",u)?_({value:H.lvup,updateValue:G.lvup,orangeWords:H.orangeWords,updateOrangeWords:G.orangeWords,blueWords:H.blueWords,updateBlueWords:G.blueWords,label:e("lv_up")}):void 0,z("blueWords",u)?U({label:e("other_card_mentioned"),subLabel:e("other_card_example"),value:H.blueWords,updateValue:G.blueWords}):void 0,z("orangeWords",u)?U({label:e("key_text_mentioned"),subLabel:e("key_text_example"),value:H.orangeWords,updateValue:G.orangeWords}):void 0,z("associatedCards",u)?t({className:"gutter-b-2"},L({label:e("associated_cards"),value:H.associatedCards,updateValue:G.associatedCards})):void 0))}),M);return q.defaultCardData=u,q}export async function openUri(e,t="export.png"){const a=/data:([^;]+);(([^;]+);)*base64,/.exec(e),[o,r]=a,n=dataURItoBlob(e),s=new File([n],t,{type:n.type});if("share"in navigator&&"canShare"in navigator&&navigator.canShare({files:[s]}))navigator.share({files:[s]}).catch((e=>{if("AbortError"===e.name||"share canceled"===e.message.toLowerCase())return;const t=URL.createObjectURL(n);window.open(t,"_blank")}));else if(window.AndroidNativeInterface){const a=JSON.stringify({image:e.substr(o.length),fileName:t});window.AndroidNativeInterface.postMessage(a)}else{const e=URL.createObjectURL(n);window.open(e,"_blank")}}export function dataURItoBlob(e){for(var t=atob(e.split(",")[1]),a=e.split(",")[0].split(":")[1].split(";")[0],o=new ArrayBuffer(t.length),r=new Uint8Array(o),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return new Blob([o],{type:a})}