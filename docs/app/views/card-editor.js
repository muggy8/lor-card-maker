import e,{div as t,button as a,strong as r,section as o}from"/Utils/elements.js";import n from"/Utils/load-css.js";import s from"/Utils/use-lang.js";import l,{useState as d,useCallback as c,useContext as i,createContext as u,useRef as m,useLayoutEffect as p,useEffect as f}from"/cdn/react";import g from"/cdn/save-svg-as-png";import{Globals as b}from"/Views/index.js";import{getCard as v,saveCard as h,deleteCard as w}from"/Utils/service.js";import x from"/Utils/set-immediate-batch.js";import N from"/Components/card-config/edit-name.js";import j from"/Components/card-config/edit-number.js";import V from"/Components/card-config/edit-region.js";import y from"/Components/card-config/edit-rarity.js";import k from"/Components/card-config/edit-keywords.js";import C from"/Components/card-config/edit-effect.js";import W from"/Components/card-config/edit-speed.js";import U from"/Components/card-config/edit-colored-text.js";import _ from"/Components/card-config/edit-art.js";import A from"/Components/card-config/edit-shade.js";import{defaultShade as L}from"/Views/list.js";import O from"/Utils/use-toggle.js";const R=n("/Views/card-editor.css");function B(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=u({current:null,setRef:()=>{}});export default function E(n,u){const E=Object.keys(u);E.sort();return e((function(){const e=s(),R=i(b),D=m();D.current=R,f((()=>{const e=R.allowBack;return D.current.setAllowBack((()=>document.documentElement.scrollTop?(x((()=>window.scrollTo(0,0))),!1):e())),function(){D.current.setAllowBack(e)}}),[]);const[F,I]=d(u);f((()=>(R.state.cardId&&v(R.state.cardId).then(I),()=>{D.current.patchState({cardId:""})})),[]);let P={...F};const S=E.reduce(((e,t)=>(e[t]=c((e=>{if(e&&e.preventDefault&&(e=e.target.value),e===F[t])return;const a={...P};a[t]=e,P=a,I(a)}),E.map((e=>F[e]))),e)),{}),[T,z]=d(null),[$,q,H]=O(!1),M=c((()=>{$||(H(!0),g.svgAsPngUri(T,{excludeUnusedCss:!0,width:T.width.baseVal.value,height:T.height.baseVal.value}).then((e=>{openUri(e),H(!1)}),(()=>H(!1))))}),[T,$]),G=m(),[J,K]=d(0),[Q,X]=d(0);p((()=>{function e(){let e=G.current.parentNode.clientWidth;const t=getComputedStyle(G.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),K(e),X(G.current.offsetHeight)}window.scroll(0,0),requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(G.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[Y,Z,ee]=O(!!F.id),[te,ae,re]=O(!1);return f((()=>{ee(!0)}),E.map((e=>F[e]))),o({id:"card-editor",className:"flex hcenter"},t({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4",style:{paddingBottom:Q+"px"}},t({className:"preview-content",ref:G,style:{width:J+"px"}},t({className:"gutter-rl-2"},l.createElement(svgRefference.Provider,{value:{current:T,setRef:z}},n({...F,cardDataUpdaters:S,updateTransform:F.art&&R.state.moveableArt?S.transform:void 0,loading:$||te}))),t({className:"flex hcenter gutter-tb"},t({className:"gutter-rl-.5"},a({className:`gutter-trbl-.5 ${F.id?void 0:"hide"}`,onClick:()=>{w(F.id).then((()=>{document.location.reload()}))}},r(e("delete_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:()=>{if(!Y||te)return;function e(){ee(!1),re(!1)}if(re(!0),F.id)return h(F.id,F).then(e,e);const t=Date.now().toString();h(t,F).then(e,e),S.id(t)},[Y||!re?"data-foo":"disabled"]:!0},r(e("save_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:M,[$?"disabled":"data-foo"]:!0},r(e("export"))))))),t({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4"},B("name",u)?t({className:"flex hcenter gutter-b-2"},N({label:e("name"),value:F.name,updateValue:S.name})):void 0,B("mana",u)?t({className:"gutter-b-2"},j({label:e("mana_cost"),value:F.mana,updateValue:S.mana})):void 0,B("speed",u)?W({value:F.speed,updateValue:S.speed}):void 0,B("power",u)&&B("health",u)&&null!==F.power&&null!==F.health?t({className:"flex-l no-wrap"},j({className:"block gutter-b-2",label:e("power"),value:F.power,updateValue:S.power}),j({className:"block gutter-b-2",label:e("health"),value:F.health,updateValue:S.health})):void 0,B("faction",u)?V({value:F.faction,updateValue:S.faction}):void 0,B("art",u)?t({className:"gutter-b-2"},_({value:F.art,updateValue:S.art})):void 0,B("shade",u)?t({className:"gutter-b-2"},A({value:F.shade||L,updateValue:S.shade})):void 0,B("rarity",u)?y({value:F.rarity,updateValue:S.rarity}):void 0,B("keywords",u)?k({value:F.keywords,updateValue:S.keywords}):void 0,B("effect",u)?C({value:F.effect,updateValue:S.effect,orangeWords:F.orangeWords,updateOrangeWords:S.orangeWords,label:e("effect")}):void 0,B("lvup",u)?C({value:F.lvup,updateValue:S.lvup,orangeWords:F.orangeWords,updateOrangeWords:S.orangeWords,label:e("lv_up")}):void 0,B("blueWords",u)?U({label:e("other_card_mentioned"),subLabel:e("other_card_example"),value:F.blueWords,updateValue:S.blueWords}):void 0,B("orangeWords",u)?U({label:e("key_text_mentioned"),subLabel:e("key_text_example"),value:F.orangeWords,updateValue:S.orangeWords}):void 0,B("clan",u)?t({className:"gutter-b-2"},N({label:e("clan"),value:F.clan,updateValue:S.clan})):void 0))}),R)}export function openUri(e){const t=/data:([^;]+);base64,/.exec(e)[1],a=atob(e.substr(`data:${t};base64,`.length)),r=[];for(let e=0;e<a.length;e+=1024){const t=a.slice(e,e+1024),o=new Array(t.length);for(let e=0;e<t.length;e++)o[e]=t.charCodeAt(e);const n=new Uint8Array(o);r.push(n)}const o=new Blob(r,{type:t}),n=URL.createObjectURL(o);window.open(n,"_blank")}