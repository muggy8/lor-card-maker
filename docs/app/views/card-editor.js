import factory,{div,button,strong,section}from"/Utils/elements.js";import loadCss from"/Utils/load-css.js";import useLang from"/Utils/use-lang.js";import React,{useState,useCallback,useContext,createContext,useRef,useLayoutEffect,useEffect}from"/cdn/react";import saveSvgAsPng from"/cdn/save-svg-as-png";import{Globals}from"/Views/index.js";import{getCard,saveCard,deleteCard}from"/Utils/service.js";import setImmediate from"/Utils/set-immediate-batch.js";import EditName from"/Components/card-config/edit-name.js";import EditNumber from"/Components/card-config/edit-number.js";import EditRegion from"/Components/card-config/edit-region.js";import EditRarity from"/Components/card-config/edit-rarity.js";import EditKeywords from"/Components/card-config/edit-keywords.js";import EditEffect from"/Components/card-config/edit-effect.js";import EditSpeed from"/Components/card-config/edit-speed.js";import EditColorText from"/Components/card-config/edit-colored-text.js";import EditArt from"/Components/card-config/edit-art.js";import EditShade from"/Components/card-config/edit-shade.js";import{defaultShade}from"/Views/list.js";import useToggle from"/Utils/use-toggle.js";const cssLoaded=loadCss("/Views/card-editor.css");function canShow(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=createContext({current:null,setRef:()=>{}});export default function EditorViewFactory(e,t){const a=Object.keys(t);a.sort();return factory((function(){const o=useLang(),r=useContext(Globals),s=useRef();s.current=r,useEffect(()=>{const e=r.allowBack;return s.current.setAllowBack(()=>document.documentElement.scrollTop?(setImmediate(()=>window.scrollTo(0,0)),!1):e()),function(){s.current.setAllowBack(e)}},[]);const[n,d]=useState(t);useEffect(()=>(r.state.cardId&&getCard(r.state.cardId).then(d),()=>{s.current.patchState({cardId:""})}),[]);let l={...n};const i=a.reduce((e,t)=>(e[t]=useCallback(e=>{if(e&&e.preventDefault&&(e=e.target.value),e===n[t])return;const a={...l};a[t]=e,l=a,d(a)},a.map(e=>n[e])),e),{}),[c,u]=useState(null),[m,f,p]=useToggle(!1),g=useCallback(()=>{m||(p(!0),saveSvgAsPng.svgAsPngUri(c,{excludeUnusedCss:!0,width:c.width.baseVal.value,height:c.height.baseVal.value}).then(e=>{openUri(e),p(!1)},()=>p(!1)))},[c,m]),v=useRef(),[b,h]=useState(0),[w,x]=useState(0);useLayoutEffect(()=>{function e(){let e=v.current.parentNode.clientWidth;const t=getComputedStyle(v.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),h(e),x(v.current.offsetHeight)}window.scroll(0,0),requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(v.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}},[]);const[E,C,S]=useToggle(!!n.id),[N,y,j]=useToggle(!1);return useEffect(()=>{S(!0)},a.map(e=>n[e])),section({id:"card-editor",className:"flex hcenter"},div({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4",style:{paddingBottom:w+"px"}},div({className:"preview-content",ref:v,style:{width:b+"px"}},div({className:"gutter-rl-2"},React.createElement(svgRefference.Provider,{value:{current:c,setRef:u}},e({...n,cardDataUpdaters:i,updateTransform:n.art&&r.state.moveableArt?i.transform:void 0,loading:m||N}))),div({className:"flex hcenter gutter-tb"},div({className:"gutter-rl-.5"},button({className:"gutter-trbl-.5 "+(n.id?void 0:"hide"),onClick:()=>{deleteCard(n.id).then(()=>{document.location.reload()})}},strong(o("delete_card")))),div({className:"gutter-rl-.5"},button({className:"gutter-trbl-.5",onClick:()=>{if(!E||N)return;function e(){S(!1),j(!1)}if(j(!0),n.id)return saveCard(n.id,n).then(e,e);const t=Date.now().toString();saveCard(t,n).then(e,e),i.id(t)},[E||!j?"data-foo":"disabled"]:!0},strong(o("save_card")))),div({className:"gutter-rl-.5"},button({className:"gutter-trbl-.5",onClick:g,[m?"disabled":"data-foo"]:!0},strong(o("export"))))))),div({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4"},canShow("name",t)?div({className:"flex hcenter gutter-b-2"},EditName({label:o("name"),value:n.name,updateValue:i.name})):void 0,canShow("mana",t)?div({className:"gutter-b-2"},EditNumber({label:o("mana_cost"),value:n.mana,updateValue:i.mana})):void 0,canShow("speed",t)?EditSpeed({value:n.speed,updateValue:i.speed}):void 0,canShow("power",t)&&canShow("health",t)&&null!==n.power&&null!==n.health?div({className:"flex-l no-wrap"},EditNumber({className:"block gutter-b-2",label:o("power"),value:n.power,updateValue:i.power}),EditNumber({className:"block gutter-b-2",label:o("health"),value:n.health,updateValue:i.health})):void 0,canShow("faction",t)?EditRegion({value:n.faction,updateValue:i.faction}):void 0,canShow("art",t)?div({className:"gutter-b-2"},EditArt({value:n.art,updateValue:i.art})):void 0,canShow("shade",t)?div({className:"gutter-b-2"},EditShade({value:n.shade||defaultShade,updateValue:i.shade})):void 0,canShow("rarity",t)?EditRarity({value:n.rarity,updateValue:i.rarity}):void 0,canShow("keywords",t)?EditKeywords({value:n.keywords,updateValue:i.keywords}):void 0,canShow("effect",t)?EditEffect({value:n.effect,updateValue:i.effect,orangeWords:n.orangeWords,updateOrangeWords:i.orangeWords,label:o("effect")}):void 0,canShow("lvup",t)?EditEffect({value:n.lvup,updateValue:i.lvup,orangeWords:n.orangeWords,updateOrangeWords:i.orangeWords,label:o("lv_up")}):void 0,canShow("blueWords",t)?EditColorText({label:o("other_card_mentioned"),subLabel:o("other_card_example"),value:n.blueWords,updateValue:i.blueWords}):void 0,canShow("orangeWords",t)?EditColorText({label:o("key_text_mentioned"),subLabel:o("key_text_example"),value:n.orangeWords,updateValue:i.orangeWords}):void 0,canShow("clan",t)?div({className:"gutter-b-2"},EditName({label:o("clan"),value:n.clan,updateValue:i.clan})):void 0))}),cssLoaded)}export function openUri(e){const t=/data:([^;]+);base64,/.exec(e)[1],a=atob(e.substr(`data:${t};base64,`.length)),o=[];for(let e=0;e<a.length;e+=1024){const t=a.slice(e,e+1024),r=new Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);const s=new Uint8Array(r);o.push(s)}const r=new Blob(o,{type:t}),s=URL.createObjectURL(r);window.open(s,"_blank")}