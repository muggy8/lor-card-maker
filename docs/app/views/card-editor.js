import e,{div as t,button as o,strong as a,section as r}from"/Utils/elements.js";import n from"/Utils/load-css.js";import s from"/Utils/use-lang.js";import l,{useState as c,useCallback as i,useContext as d,createContext as u,useRef as m,useLayoutEffect as p,useEffect as f}from"/cdn/react";import{Globals as g}from"/Views/index.js";import{getCard as b,saveCard as v,deleteCard as h}from"/Utils/service.js";import w from"/Utils/set-immediate-batch.js";import x from"/Components/card-config/edit-name.js";import y from"/Components/card-config/edit-poc-type.js";import N from"/Components/card-config/edit-number.js";import j from"/Components/card-config/edit-region.js";import C from"/Components/card-config/edit-rarity.js";import V from"/Components/card-config/edit-rarity-poc.js";import _ from"/Components/card-config/edit-keywords.js";import W from"/Components/card-config/edit-effect.js";import k from"/Components/card-config/edit-speed.js";import U from"/Components/card-config/edit-colored-text.js";import B from"/Components/card-config/edit-art.js";import O from"/Components/card-config/edit-shade.js";import R from"/Components/card-config/edit-icon.js";import L from"/Components/card-config/edit-checkbox.js";import A from"/Components/card-config/edit-associated-cards.js";import{defaultShade as I}from"/Views/list.js";import S from"/Utils/use-toggle.js";import T from"/Utils/debounce-function.js";import E from"/Components/export.js";import D from"/Components/card-config/edit-file-name.js";import F from"/Components/card-config/edit-color.js";import{isDesktop as M}from"/cdn/react-device-detect";import z from"/Components/card-config/edit-clone-existing.js";const P=n("/Views/card-editor.css");function q(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=u({current:null,setRef:()=>{}});export default function H(n,u){const M=Object.keys(u);M.sort();const H=e((function(){const e=s(),P=d(g),H=m();H.current=P,f((()=>{const e=P.getAllowBack();return H.current.setAllowBack((()=>{if(document.documentElement.scrollTop>100){const e=!0===H.current.state.settings.lowSpecsMode;return w((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){H.current.setAllowBack(e)}}),[]);const[J,$]=c(u);f((()=>(P.state.cardId&&b(P.state.cardId).then($),()=>{H.current.patchState({cardId:""})})),[]);let G={...J};const K=M.reduce(((e,t)=>(e[t]=i((e=>{if(e&&e.preventDefault&&(e=e.target.value),e===J[t])return;const o={...G};o[t]=e,G=o,$(o)}),M.map((e=>J[e]))),e)),{}),[Q,X]=c(null),[Y,Z,ee]=S(!1),te=i((()=>{Y||(ee(!0),E(J,Q,P).then((()=>ee(!1)),(e=>console.warn(e)+ee(!1))))}),[Q,Y,P,J]),oe=m(),[ae,re]=c(0),[ne,se]=c(0);p((()=>{const e=T((function(){let e=oe.current.parentNode.clientWidth;const t=getComputedStyle(oe.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),re(e),se(oe.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(oe.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[le,ce,ie]=S(!0),[de,ue,me]=S(!1);f((()=>{ie(!0)}),M.map((e=>J[e])));const[pe,fe]=c(!1),ge={cardDataUpdaters:K,updateTransform:J.art&&(P.state.moveableArt?K.transform:void 0),loading:Y||de};return q("pocType",u)&&(ge.showOnlyIcon=pe),r({id:"card-editor",className:"flex hcenter"},t({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6",style:{paddingBottom:ne+"px"}},t({className:"preview-content",ref:oe,style:{width:ae+"px"}},t({className:"gutter-rl-2"},l.createElement(svgRefference.Provider,{value:{current:Q,setRef:X}},n({...J,...ge}))),t({className:"flex hcenter gutter-tb"},t({className:"gutter-rl-.5"},o({className:`gutter-trbl-.5 ${J.id?void 0:"hide"}`,onClick:()=>{confirm(e("confirm_delete"))&&h(J.id).then((()=>{document.location.reload()}))}},a(e("delete_card")))),t({className:"gutter-rl-.5"},o({className:"gutter-trbl-.5",onClick:()=>{if(!le||de)return;function e(){ie(!1),me(!1)}if(me(!0),J.id)return v(J.id,J).then(e,e);const t=Date.now().toString();v(t,J).then(e,e),K.id(t)},[le||!me?"data-foo":"disabled"]:!0},a(e("save_card")))),t({className:"gutter-rl-.5"},o({className:"gutter-trbl-.5",onClick:te,[Y?"disabled":"data-foo"]:!0},a(e("share"))))))),t({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6"},q("name",u)?t({className:"flex hcenter gutter-b-2"},x({label:e("name"),value:J.name,updateValue:K.name})):void 0,q("fileName",u)?t({className:"flex hcenter gutter-b-2"},D({label:e("file_name"),value:J.fileName,placeholder:J.name,updateValue:K.fileName})):void 0,J.id||J.effect||J.lvup?void 0:t({className:"flex hcenter gutter-b-2"},z({cardDataUpdaters:K})),q("pocType",u)?y({value:J.pocType,updateValue:K.pocType}):void 0,q("pocType",u)?t({className:"gutter-b-2"},L({label:e("icon_only"),value:pe,updateValue:fe})):void 0,q("icons",u)?t({className:"flex hcenter gutter-b-2"},R({value:J.icons,updateValue:K.icons})):void 0,q("largerIcon",u)?t({className:"gutter-b-2"},L({label:e("larger_icon"),value:J.largerIcon,updateValue:K.largerIcon})):void 0,q("mana",u)?t({className:"gutter-b-2"},N({label:e("mana_cost"),value:J.mana,updateValue:K.mana})):void 0,q("clan",u)?t({className:"gutter-b-2"},U({label:e("clan"),value:J.clan,updateValue:K.clan})):void 0,q("speed",u)?k({value:J.speed,updateValue:K.speed}):void 0,q("power",u)&&q("health",u)&&null!==J.power&&null!==J.health?t({className:"flex-l no-wrap"},N({className:"block gutter-b-2",label:e("power"),value:J.power,updateValue:K.power}),N({className:"block gutter-b-2",label:e("health"),value:J.health,updateValue:K.health})):void 0,q("faction",u)?j({value:J.faction,updateValue:K.faction}):void 0,q("art",u)?t({className:"gutter-b-2"},B({label:e("card_art"),value:J.art,updateValue:K.art})):void 0,q("shade",u)?O({label:e("card_art"),value:J.shade||I,updateValue:K.shade}):void 0,q("textBgColor",u)?t({className:"gutter-b-2"},F({label:e("text_background_color"),value:J.textBgColor,updateValue:K.textBgColor,cardArt:J.art})):void 0,q("rarity",u)?"poc"===J.type?V({value:J.rarity,updateValue:K.rarity}):C({value:J.rarity,updateValue:K.rarity}):void 0,q("keywords",u)?_({value:J.keywords,updateValue:K.keywords}):void 0,q("effect",u)?W({value:J.effect,updateValue:K.effect,orangeWords:J.orangeWords,updateOrangeWords:K.orangeWords,blueWords:J.blueWords,updateBlueWords:K.blueWords,label:e("effect")}):void 0,q("lvup",u)?W({value:J.lvup,updateValue:K.lvup,orangeWords:J.orangeWords,updateOrangeWords:K.orangeWords,blueWords:J.blueWords,updateBlueWords:K.blueWords,label:e("lv_up_cond")}):void 0,q("blueWords",u)?U({label:e("other_card_mentioned"),subLabel:e("other_card_example"),value:J.blueWords,updateValue:K.blueWords}):void 0,q("orangeWords",u)?U({label:e("key_text_mentioned"),subLabel:e("key_text_example"),value:J.orangeWords,updateValue:K.orangeWords}):void 0,q("associatedCards",u)?t({className:"gutter-b-2"},A({label:e("associated_cards"),value:J.associatedCards,updateValue:K.associatedCards})):void 0))}),P);return H.defaultCardData=u,H}export async function openUri(e,t="export.png"){const o=/data:([^;]+);(([^;]+);)*base64,/.exec(e),[a,r]=o,n=dataURItoBlob(e),s=new File([n],t,{type:n.type});if(M&&!window.AndroidNativeInterface&&!location.origin.includes("localhost"))return saveBlob(n,t);if("share"in navigator&&"canShare"in navigator&&navigator.canShare({files:[s]}))navigator.share({files:[s]}).catch((e=>{if("AbortError"===e.name||"share canceled"===e.message.toLowerCase())return;const t=URL.createObjectURL(n);window.open(t,"_blank")}));else if(window.AndroidNativeInterface){const o=JSON.stringify({image:e.substr(a.length),fileName:t});window.AndroidNativeInterface.postMessage(o)}else{const e=URL.createObjectURL(n);window.open(e,"_blank")}}export function dataURItoBlob(e){for(var t=atob(e.split(",")[1]),o=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),r=new Uint8Array(a),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return new Blob([a],{type:o})}export function saveBlob(e,t){if(console.log(e,t),window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t);else{const o=document.createElement("a");document.body.appendChild(o);const a=window.URL.createObjectURL(e);o.href=a,o.download=t,o.click(),setTimeout((()=>{window.URL.revokeObjectURL(a),document.body.removeChild(o)}),0)}}