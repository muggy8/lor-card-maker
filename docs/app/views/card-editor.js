import e,{div as t,button as a,strong as r,section as o}from"/Utils/elements.js";import s from"/Utils/load-css.js";import n from"/Utils/use-lang.js";import l,{useState as d,useCallback as i,useContext as c,createContext as u,useRef as m,useLayoutEffect as p,useEffect as f}from"/cdn/react";import{Globals as g}from"/Views/index.js";import{getCard as b,saveCard as v,deleteCard as h}from"/Utils/service.js";import w from"/Utils/set-immediate-batch.js";import N from"/Components/card-config/edit-name.js";import x from"/Components/card-config/edit-number.js";import j from"/Components/card-config/edit-region.js";import C from"/Components/card-config/edit-rarity.js";import W from"/Components/card-config/edit-keywords.js";import V from"/Components/card-config/edit-effect.js";import y from"/Components/card-config/edit-speed.js";import _ from"/Components/card-config/edit-colored-text.js";import k from"/Components/card-config/edit-art.js";import U from"/Components/card-config/edit-shade.js";import L from"/Components/card-config/edit-icon.js";import O from"/Components/card-config/edit-checkbox.js";import R from"/Components/card-config/edit-associated-cards.js";import{defaultShade as A}from"/Views/list.js";import I from"/Utils/use-toggle.js";import S from"/Utils/debounce-function.js";import B from"/Components/export.js";import E from"/Components/card-config/edit-file-name.js";const D=s("/Views/card-editor.css");function F(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=u({current:null,setRef:()=>{}});export default function M(s,u){const M=Object.keys(u);M.sort();const T=e((function(){const e=n(),D=c(g),T=m();T.current=D,f((()=>{const e=D.getAllowBack();return T.current.setAllowBack((()=>{if(document.documentElement.scrollTop>100){const e=!0===T.current.state.settings.lowSpecsMode;return w((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){T.current.setAllowBack(e)}}),[]);const[z,P]=d(u);f((()=>(D.state.cardId&&b(D.state.cardId).then(P),()=>{T.current.patchState({cardId:""})})),[]);let q={...z};const H=M.reduce(((e,t)=>(e[t]=i((e=>{if(e&&e.preventDefault&&(e=e.target.value),e===z[t])return;const a={...q};a[t]=e,q=a,P(a)}),M.map((e=>z[e]))),e)),{}),[J,$]=d(null),[G,K,Q]=I(!1),X=i((()=>{G||(Q(!0),B(z,J,D).then((()=>Q(!1)),(e=>console.warn(e)+Q(!1))))}),[J,G,D,z]),Y=m(),[Z,ee]=d(0),[te,ae]=d(0);p((()=>{const e=S((function(){let e=Y.current.parentNode.clientWidth;const t=getComputedStyle(Y.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),ee(e),ae(Y.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(Y.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[re,oe,se]=I(!0),[ne,le,de]=I(!1);return f((()=>{se(!0)}),M.map((e=>z[e]))),o({id:"card-editor",className:"flex hcenter"},t({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6",style:{paddingBottom:te+"px"}},t({className:"preview-content",ref:Y,style:{width:Z+"px"}},t({className:"gutter-rl-2"},l.createElement(svgRefference.Provider,{value:{current:J,setRef:$}},s({...z,cardDataUpdaters:H,updateTransform:z.art&&D.state.moveableArt?H.transform:void 0,loading:G||ne}))),t({className:"flex hcenter gutter-tb"},t({className:"gutter-rl-.5"},a({className:`gutter-trbl-.5 ${z.id?void 0:"hide"}`,onClick:()=>{h(z.id).then((()=>{document.location.reload()}))}},r(e("delete_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:()=>{if(!re||ne)return;function e(){se(!1),de(!1)}if(de(!0),z.id)return v(z.id,z).then(e,e);const t=Date.now().toString();v(t,z).then(e,e),H.id(t)},[re||!de?"data-foo":"disabled"]:!0},r(e("save_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:X,[G?"disabled":"data-foo"]:!0},r(e("share"))))))),t({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6"},F("name",u)?t({className:"flex hcenter gutter-b-2"},N({label:e("name"),value:z.name,updateValue:H.name})):void 0,F("fileName",u)?t({className:"flex hcenter gutter-b-2"},E({label:e("file_name"),value:z.fileName,placeholder:z.name,updateValue:H.fileName})):void 0,F("icons",u)?t({className:"flex hcenter gutter-b-2"},L({value:z.icons,updateValue:H.icons})):void 0,F("largerIcon",u)?t({className:"gutter-b-2"},O({label:e("larger_icon"),value:z.largerIcon,updateValue:H.largerIcon})):void 0,F("mana",u)?t({className:"gutter-b-2"},x({label:e("mana_cost"),value:z.mana,updateValue:H.mana})):void 0,F("clan",u)?t({className:"gutter-b-2"},_({label:e("clan"),value:z.clan,updateValue:H.clan})):void 0,F("speed",u)?y({value:z.speed,updateValue:H.speed}):void 0,F("power",u)&&F("health",u)&&null!==z.power&&null!==z.health?t({className:"flex-l no-wrap"},x({className:"block gutter-b-2",label:e("power"),value:z.power,updateValue:H.power}),x({className:"block gutter-b-2",label:e("health"),value:z.health,updateValue:H.health})):void 0,F("faction",u)?j({value:z.faction,updateValue:H.faction}):void 0,F("art",u)?t({className:"gutter-b-2"},k({label:e("card_art"),value:z.art,updateValue:H.art})):void 0,F("shade",u)?U({label:e("card_art"),value:z.shade||A,updateValue:H.shade}):void 0,F("rarity",u)?C({value:z.rarity,updateValue:H.rarity}):void 0,F("keywords",u)?W({value:z.keywords,updateValue:H.keywords}):void 0,F("effect",u)?V({value:z.effect,updateValue:H.effect,orangeWords:z.orangeWords,updateOrangeWords:H.orangeWords,blueWords:z.blueWords,updateBlueWords:H.blueWords,label:e("effect")}):void 0,F("lvup",u)?V({value:z.lvup,updateValue:H.lvup,orangeWords:z.orangeWords,updateOrangeWords:H.orangeWords,blueWords:z.blueWords,updateBlueWords:H.blueWords,label:e("lv_up")}):void 0,F("blueWords",u)?_({label:e("other_card_mentioned"),subLabel:e("other_card_example"),value:z.blueWords,updateValue:H.blueWords}):void 0,F("orangeWords",u)?_({label:e("key_text_mentioned"),subLabel:e("key_text_example"),value:z.orangeWords,updateValue:H.orangeWords}):void 0,F("associatedCards",u)?t({className:"gutter-b-2"},R({label:e("associated_cards"),value:z.associatedCards,updateValue:H.associatedCards})):void 0))}),D);return T.defaultCardData=u,T}export async function openUri(e,t="export.png"){const a=/data:([^;]+);(([^;]+);)*base64,/.exec(e),[r,o]=a,s=await fetch(e).then((e=>e.blob())),n=new File([s],t,{type:s.type});if("share"in navigator&&"canShare"in navigator&&navigator.canShare({files:[n]}))navigator.share({files:[n]}).catch((e=>{if("AbortError"===e.name||"share canceled"===e.message.toLowerCase())return;const t=URL.createObjectURL(s);window.open(t,"_blank")}));else if(window.AndroidNativeInterface){const a=JSON.stringify({image:e.substr(r.length),fileName:t});window.AndroidNativeInterface.postMessage(a)}else{const e=URL.createObjectURL(s);window.open(e,"_blank")}}