import e,{div as t,button as a,strong as r,section as o}from"/Utils/elements.js";import n from"/Utils/load-css.js";import s from"/Utils/use-lang.js";import l,{useState as c,useCallback as i,useContext as d,createContext as u,useRef as m,useLayoutEffect as p,useEffect as f}from"/cdn/react";import g from"/cdn/save-svg-as-png";import{Globals as b}from"/Views/index.js";import{getCard as v,saveCard as h,deleteCard as w}from"/Utils/service.js";import x from"/Utils/set-immediate-batch.js";import{isMobile as N}from"/cdn/react-device-detect";import j from"/Components/card-config/edit-name.js";import V from"/Components/card-config/edit-number.js";import y from"/Components/card-config/edit-region.js";import C from"/Components/card-config/edit-rarity.js";import k from"/Components/card-config/edit-keywords.js";import U from"/Components/card-config/edit-effect.js";import _ from"/Components/card-config/edit-speed.js";import W from"/Components/card-config/edit-colored-text.js";import A from"/Components/card-config/edit-art.js";import L from"/Components/card-config/edit-shade.js";import O from"/Components/card-config/edit-icon.js";import{defaultShade as R}from"/Views/list.js";import I from"/Utils/use-toggle.js";import E from"/Utils/debounce-function.js";import S from"/Components/card-config/edit-checkbox.js";const B=n("/Views/card-editor.css");function F(e,t){return Object.hasOwnProperty.call(t,e)}export const svgRefference=u({current:null,setRef:()=>{}});export default function $(n,u){const N=Object.keys(u);N.sort();return e((function(){const e=s(),B=d(b),$=m();$.current=B,f((()=>{const e=B.getAllowBack();return $.current.setAllowBack((()=>document.documentElement.scrollTop>100?(x((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:"smooth"}))),!1):e())),function(){$.current.setAllowBack(e)}}),[]);const[D,P]=c(u);f((()=>(B.state.cardId&&v(B.state.cardId).then(P),()=>{$.current.patchState({cardId:""})})),[]);let T={...D};const z=N.reduce(((e,t)=>(e[t]=i((e=>{if(e&&e.preventDefault&&(e=e.target.value),e===D[t])return;const a={...T};a[t]=e,T=a,P(a)}),N.map((e=>D[e]))),e)),{}),[M,q]=c(null),[H,J,G]=I(!1),K=i((()=>{H||(G(!0),g.svgAsPngUri(M,{excludeUnusedCss:!0,width:M.width.baseVal.value,height:M.height.baseVal.value}).then((e=>{openUri(e,`${(D.name||"export").toUpperCase()}.png`),G(!1)}),(()=>G(!1))))}),[M,H]),Q=m(),[X,Y]=c(0),[Z,ee]=c(0);p((()=>{const e=E((function(){let e=Q.current.parentNode.clientWidth;const t=getComputedStyle(Q.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),Y(e),ee(Q.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(Q.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[te,ae,re]=I(!0),[oe,ne,se]=I(!1);return f((()=>{re(!0)}),N.map((e=>D[e]))),o({id:"card-editor",className:"flex hcenter"},t({className:"card-preview gutter-t-2 box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4",style:{paddingBottom:Z+"px"}},t({className:"preview-content",ref:Q,style:{width:X+"px"}},t({className:"gutter-rl-2"},l.createElement(svgRefference.Provider,{value:{current:M,setRef:q}},n({...D,cardDataUpdaters:z,updateTransform:D.art&&B.state.moveableArt?z.transform:void 0,loading:H||oe}))),t({className:"flex hcenter gutter-tb"},t({className:"gutter-rl-.5"},a({className:`gutter-trbl-.5 ${D.id?void 0:"hide"}`,onClick:()=>{w(D.id).then((()=>{document.location.reload()}))}},r(e("delete_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:()=>{if(!te||oe)return;function e(){re(!1),se(!1)}if(se(!0),D.id)return h(D.id,D).then(e,e);const t=Date.now().toString();h(t,D).then(e,e),z.id(t)},[te||!se?"data-foo":"disabled"]:!0},r(e("save_card")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",onClick:K,[H?"disabled":"data-foo"]:!0},r(e("share"))))))),t({className:"card-configs gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4"},F("name",u)?t({className:"flex hcenter gutter-b-2"},j({label:e("name"),value:D.name,updateValue:z.name})):void 0,F("icons",u)?t({className:"flex hcenter gutter-b-2"},O({value:D.icons,updateValue:z.icons})):void 0,F("largerIcon",u)?t({className:"gutter-b-2"},S({label:e("larger_icon"),value:D.largerIcon,updateValue:z.largerIcon})):void 0,F("mana",u)?t({className:"gutter-b-2"},V({label:e("mana_cost"),value:D.mana,updateValue:z.mana})):void 0,F("speed",u)?_({value:D.speed,updateValue:z.speed}):void 0,F("power",u)&&F("health",u)&&null!==D.power&&null!==D.health?t({className:"flex-l no-wrap"},V({className:"block gutter-b-2",label:e("power"),value:D.power,updateValue:z.power}),V({className:"block gutter-b-2",label:e("health"),value:D.health,updateValue:z.health})):void 0,F("faction",u)?y({value:D.faction,updateValue:z.faction}):void 0,F("art",u)?t({className:"gutter-b-2"},A({value:D.art,updateValue:z.art})):void 0,F("shade",u)?t({className:"gutter-b-2"},L({label:e("card_art"),value:D.shade||R,updateValue:z.shade})):void 0,F("rarity",u)?C({value:D.rarity,updateValue:z.rarity}):void 0,F("keywords",u)?k({value:D.keywords,updateValue:z.keywords}):void 0,F("effect",u)?U({value:D.effect,updateValue:z.effect,orangeWords:D.orangeWords,updateOrangeWords:z.orangeWords,label:e("effect")}):void 0,F("lvup",u)?U({value:D.lvup,updateValue:z.lvup,orangeWords:D.orangeWords,updateOrangeWords:z.orangeWords,label:e("lv_up")}):void 0,F("blueWords",u)?W({label:e("other_card_mentioned"),subLabel:e("other_card_example"),value:D.blueWords,updateValue:z.blueWords}):void 0,F("orangeWords",u)?W({label:e("key_text_mentioned"),subLabel:e("key_text_example"),value:D.orangeWords,updateValue:z.orangeWords}):void 0,F("clan",u)?t({className:"gutter-b-2"},j({label:e("clan"),value:D.clan,updateValue:z.clan})):void 0))}),B)}export function openUri(e,t="export.png"){const a=/data:([^;]+);base64,/.exec(e)[1],r=atob(e.substr(`data:${a};base64,`.length)),o=[];for(let e=0;e<r.length;e+=1024){const t=r.slice(e,e+1024),a=new Array(t.length);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);const n=new Uint8Array(a);o.push(n)}const n=new Blob(o,{type:a}),s=new File([n],t,{type:n.type});if("share"in navigator&&"canShare"in navigator&&navigator.canShare({files:[s]}))navigator.share({files:[s]}).catch((e=>{if("AbortError"===e.name||"share canceled"===e.message.toLowerCase())return;const t=URL.createObjectURL(n);window.open(t,"_blank")}));else if(window.AndroidNativeInterface){const r=JSON.stringify({image:e.substr(`data:${a};base64,`.length),fileName:t});window.AndroidNativeInterface.postMessage(r)}else{const e=URL.createObjectURL(n);window.open(e,"_blank")}}