import e,{div as t,button as r,strong as o,section as s}from"/Utils/elements.js";import{createElement as n,useEffect as c,useState as i,useLayoutEffect as l,useCallback as a,useRef as m,useContext as d}from"/cdn/react";import{Globals as u}from"/Views/index.js";import p from"/Utils/load-css.js";import f from"/Utils/use-lang.js";import{getCardList as g}from"/Utils/service.js";import{typeToComponent as x}from"/Views/list.js";import{svgRefference as w}from"/Views/card-editor.js";import b from"/Components/batch-renderer.js";import h from"/cdn/save-svg-as-png";import v from"/Utils/use-toggle.js";import j from"/Utils/debounce-function.js";import y from"/Components/list-limit.js";import N from"/Utils/use-asset-cache.js";import{isMobile as k}from"/cdn/react-device-detect";import _ from"/Components/export.js";import C from"/Components/card-template/svg-wrap";const U=p("/Views/batch-export.css");export default e((function(){const e=f(),p=d(u),h=!0===p.state.settings.lowSpecsMode,k=m();k.current=p,c((()=>{const e=p.getAllowBack();return k.current.setAllowBack((()=>{if(document.documentElement.scrollTop>100){const e=!0===k.current.state.settings.lowSpecsMode;return setImmediate((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){k.current.setAllowBack(e)}}),[]);const C=N((e=>{g().then(e)}),[],[]),U=N((e=>{e(C.reduce(((e,t)=>(e[t.id]=t,e)),{}))}),[C],{}),[E,L]=i(!1),z=a((()=>{L(!E)}),[E]),A=m(new Map),S=[];for(let e of A.current.entries()){const[t,r]=e;r&&S.push(U[t])}const B=m(),[F,M]=i(0),[O,V]=i(0);l((()=>{const e=j((function(){let e=B.current.parentNode.clientWidth;const t=getComputedStyle(B.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),M(e),V(B.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(B.current,{childList:!0,subtree:!0,attributes:["style"]}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[q,R]=i(null),[T,H,I]=v(!1),P=m(),[W,D]=i(0);return c((()=>{const e=j((()=>{const e=window.getComputedStyle(P.current).display;"string"==typeof e&&e.includes("flex")?D(0):D(1)}),350);return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),[]),s({id:"batch-exporter",className:"gutter-t-2 flex hcenter"},t({className:"export-preview gutter-t-2 box-xs-12 box-s-8 box-m-6",style:{paddingBottom:O+"px"}},t({className:"preview-content",ref:B,style:{width:F+"px"}},t({className:"gutter-rl-.5 gutter-b flex hcenter"},S?r({className:"export-button gutter-tb-.5 gutter-rl-2",onClick:()=>{!T&&Object.keys(S).length&&(I(!0),requestAnimationFrame((()=>{_(S,q,p).then((()=>I(!1)),(e=>console.warn(e)+I(!1)))})))},[!Object.keys(S).length||T?"disabled":"data-foo"]:!0},o(e("share_selection"))):void 0),t({className:"gutter-rl-2"},Object.keys(S).length?void 0:t({className:"no-export-selected"},t({className:"flex vhcenter"},e("no_export_selected")),t({className:"flex-m",style:{opacity:W},ref:P},e("scroll_down_for_selection"))),n(w.Provider,{value:{current:q,setRef:R}},b({cards:S,loading:T}))))),t({className:"export-selection gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6"},t({className:"flex hcenter"},o(e("select_exports"))),t({className:"gutter-trbl-.5 flex"},y({defaultSize:h?6:void 0},C.map((r=>{const o=x(r.type);return o?t({className:"clickable gutter-trbl-.5 box-xs-6 box-s-4 flex column vhcenter"+(A.current.get(r.id)?"":" ghost"),key:r.id,onClick:()=>{A.current.get(r.id)?A.current.delete(r.id):A.current.set(r.id,!0),z()}},(()=>{try{return o(r)}catch(t){return o({name:e("error_loading_card",{cardName:r.name})})}})()):t({key:r.id})}))))))}),U);