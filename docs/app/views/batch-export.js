import factory,{div,button,strong,section}from"/Utils/elements.js";import{createElement,useEffect,useState,useLayoutEffect,useCallback,useRef,useContext}from"/cdn/react";import{Globals}from"/Views/index.js";import loadCss from"/Utils/load-css.js";import useLang from"/Utils/use-lang.js";import{getCardList}from"/Utils/service.js";import{typeToComponent}from"/Views/list.js";import{svgRefference,openUri}from"/Views/card-editor.js";import BatchRenderer from"/Components/batch-renderer.js";import saveSvgAsPng from"/cdn/save-svg-as-png";import useToggle from"/Utils/use-toggle.js";import debounceFunction from"/Utils/debounce-function.js";import listLimit from"/Components/list-limit.js";const cssLoaded=loadCss("/Views/batch-export.css");function BatchExportComponent(){const e=useLang(),t=useContext(Globals),s=useRef();s.current=t,useEffect(()=>{const e=t.allowBack;return s.current.setAllowBack(()=>document.documentElement.scrollTop?(setImmediate(()=>window.scrollTo(0,0)),!1):e()),function(){s.current.setAllowBack(e)}},[]);const[o,r]=useState([]),[n,i]=useState({});useEffect(()=>{const e=o.reduce((e,t)=>(e[t.id]=t,e),{});i(e)},[o]);const[c,l]=useState(!1),a=useCallback(()=>{l(!c)},[c]),u=useRef(new Map),d=[];for(let e of u.current.entries()){const[t,s]=e;s&&d.push(n[t])}useEffect(()=>{getCardList().then(r)},[]);const m=useRef(),[f,p]=useState(0),[g,x]=useState(0);useLayoutEffect(()=>{function e(){let e=m.current.parentNode.clientWidth;const t=getComputedStyle(m.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),p(e),x(m.current.offsetHeight)}window.scroll(0,0),requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(m.current,{attributes:!0}),function(){window.removeEventListener("resize",e),t.disconnect()}},[]);const[v,b]=useState(null),[h,w,y]=useToggle(!1),C=useRef(),[E,L]=useState(0);return useEffect(()=>{const e=debounceFunction(()=>{const e=window.getComputedStyle(C.current).display;"string"==typeof e&&e.includes("flex")?L(0):L(1)},350);return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),section({id:"batch-exporter",className:"gutter-t-2 flex hcenter"},div({className:"export-preview gutter-t-2 box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4",style:{paddingBottom:g+"px"}},div({className:"preview-content",ref:m,style:{width:f+"px"}},div({className:"gutter-rl-.5 gutter-b flex hcenter"},d?button({className:"export-button gutter-tb-.5 gutter-rl-2",onClick:()=>{!h&&Object.keys(d).length&&(y(!0),saveSvgAsPng.svgAsPngUri(v,{excludeUnusedCss:!0,width:v.width.baseVal.value,height:v.height.baseVal.value}).then(e=>{openUri(e),y(!1)},()=>y(!1)))},[!Object.keys(d).length||h?"disabled":"data-foo"]:!0},strong(e("export_selection"))):void 0),div({className:"gutter-rl-2"},Object.keys(d).length?void 0:div({className:"no-export-selected"},div({className:"flex vhcenter"},e("no_export_selected")),div({className:"flex-m",style:{opacity:E},ref:C},e("scroll_down_for_selection"))),createElement(svgRefference.Provider,{value:{current:v,setRef:b}},BatchRenderer({cards:d,loading:h}))))),div({className:"export-selection gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4"},div({className:"flex hcenter"},strong(e("select_exports"))),div({className:"gutter-trbl-.5 flex"},listLimit(o.map(e=>{const t=typeToComponent(e.type);return t?div({className:"clickable gutter-trbl-.5 box-xs-6 box-s-4 flex column vhcenter"+(u.current.get(e.id)?"":" ghost"),key:e.id,onClick:()=>{u.current.get(e.id)?u.current.delete(e.id):u.current.set(e.id,!0),a()}},t(e)):div({key:e.id})})))))}export default factory(BatchExportComponent,cssLoaded);