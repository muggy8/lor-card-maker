import e,{div as t,button as r,strong as s,section as o}from"/Utils/elements.js";import{createElement as n,useEffect as i,useState as l,useLayoutEffect as c,useCallback as a,useRef as d,useContext as m}from"/cdn/react";import{Globals as u}from"/Views/index.js";import p from"/Utils/load-css.js";import x from"/Utils/use-lang.js";import{getCardList as f}from"/Utils/service.js";import{typeToComponent as g}from"/Views/list.js";import{svgRefference as b,openUri as w}from"/Views/card-editor.js";import h from"/Components/batch-renderer.js";import v from"/cdn/save-svg-as-png";import y from"/Utils/use-toggle.js";import N from"/Utils/debounce-function.js";import j from"/Components/list-limit.js";const k=p("/Views/batch-export.css");export default e((function(){const e=x(),p=m(u),k=d();k.current=p,i((()=>{const e=p.allowBack;return k.current.setAllowBack((()=>document.documentElement.scrollTop?(setImmediate((()=>window.scrollTo(0,0))),!1):e())),function(){k.current.setAllowBack(e)}}),[]);const[U,C]=l([]),[_,L]=l({});i((()=>{const e=U.reduce(((e,t)=>(e[t.id]=t,e)),{});L(e)}),[U]);const[V,A]=l(!1),E=a((()=>{A(!V)}),[V]),z=d(new Map),B=[];for(let e of z.current.entries()){const[t,r]=e;r&&B.push(_[t])}i((()=>{f().then(C)}),[]);const F=d(),[O,q]=l(0),[M,P]=l(0);c((()=>{const e=N((function(){let e=F.current.parentNode.clientWidth;const t=getComputedStyle(F.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),q(e),P(F.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(F.current,{childList:!0,subtree:!0,attributes:["style"]}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[R,S]=l(null),[T,H,I]=y(!1),W=d(),[D,G]=l(0);return i((()=>{const e=N((()=>{const e=window.getComputedStyle(W.current).display;"string"==typeof e&&e.includes("flex")?G(0):G(1)}),350);return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),[]),o({id:"batch-exporter",className:"gutter-t-2 flex hcenter"},t({className:"export-preview gutter-t-2 box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4",style:{paddingBottom:M+"px"}},t({className:"preview-content",ref:F,style:{width:O+"px"}},t({className:"gutter-rl-.5 gutter-b flex hcenter"},B?r({className:"export-button gutter-tb-.5 gutter-rl-2",onClick:()=>{!T&&Object.keys(B).length&&(I(!0),requestAnimationFrame((()=>{v.svgAsPngUri(R,{excludeUnusedCss:!0,width:R.width.baseVal.value,height:R.height.baseVal.value}).then((e=>{w(e),I(!1)}),(()=>I(!1)))})))},[!Object.keys(B).length||T?"disabled":"data-foo"]:!0},s(e("export_selection"))):void 0),t({className:"gutter-rl-2"},Object.keys(B).length?void 0:t({className:"no-export-selected"},t({className:"flex vhcenter"},e("no_export_selected")),t({className:"flex-m",style:{opacity:D},ref:W},e("scroll_down_for_selection"))),n(b.Provider,{value:{current:R,setRef:S}},h({cards:B,loading:T}))))),t({className:"export-selection gutter-tb-4 gutter-rl box-xs-12 box-s-8 box-m-6 box-l-5 box-xl-4"},t({className:"flex hcenter"},s(e("select_exports"))),t({className:"gutter-trbl-.5 flex"},j(U.map((e=>{const r=g(e.type);return r?t({className:"clickable gutter-trbl-.5 box-xs-6 box-s-4 flex column vhcenter"+(z.current.get(e.id)?"":" ghost"),key:e.id,onClick:()=>{z.current.get(e.id)?z.current.delete(e.id):z.current.set(e.id,!0),E()}},r(e)):t({key:e.id})}))))))}),k);