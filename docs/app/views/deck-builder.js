import e,{div as t,strong as r,button as a,nav as s,section as o,label as c}from"/Utils/elements.js";import{useState as n,useCallback as l,useRef as i,useEffect as d,useContext as u,useLayoutEffect as m,createElement as f}from"/cdn/react";import{getRitoCards as p,patchRitoCards as g,getLatestRitoData as h,getCardList as w,getCard as b,saveCard as k,deleteCard as C}from"/Utils/service.js";import{isMobile as N}from"/cdn/react-device-detect";import y from"/Utils/load-css.js";import v from"/Utils/use-lang.js";import x from"/Utils/use-filter.js";import L from"/Components/list-limit.js";import _ from"/Components/deck/card-name.js";import j from"/Components/deck/rito-cards-filters-ui.js";import D from"/Components/deck/deck-view.js";import S from"/Utils/use-asset-cache.js";import E from"/Components/deck/custom-cards-filters-ui.js";import A from"/Utils/debounce-function.js";import O from"/cdn/save-svg-as-png";import{svgRefference as F}from"/Views/card-editor.js";import{Globals as R}from"/Views/index.js";import V from"/Components/card-config/edit-name.js";import z from"/Components/card-config/edit-art.js";import{ExternalCustomCard as U,isExternalImage as I}from"/Components/deck/deck-card.js";import M from"/Components/export.js";import P from"/Components/card-config/edit-checkbox.js";import B from"/Components/card-config/edit-file-name.js";const H=y("/Views/deck-builder.css");export function getRitoCardsFromDataDump({sets:e}){if(!e)return;const t=e.map((e=>e.data)).flat();return t.sort(((e,t)=>{if("champion"===e.supertype.toLowerCase()&&"champion"!==t.supertype.toLowerCase())return-1;if("champion"!==e.supertype.toLowerCase()&&"champion"===t.supertype.toLowerCase())return 1;const r=e.cost-t.cost;if(r)return r;const a=t.collectible-e.collectible;if(a)return a;const s=e.name.localeCompare(t.name);return s||0})),t}function T(e){const t=e.reduce(((e,t)=>t?(Object.keys(t).forEach((r=>{e[r]=e[r]||new Map;const a=t[r];Array.isArray(a)?a.forEach((t=>{e[r].set(t,!0)})):e[r].set(a,!0)})),e):e),{});return Object.keys(t).forEach((e=>{const r=t[e];t[e]=[],r.forEach(((r,a)=>{t[e].push(a)}))})),t}const q={id:void 0,cards:[],type:"deck",name:"",showDeckStats:!0,includeAssociated:!1,dataVersion:2,fileName:""};export default e((function(){const e=v(),c=u(R),N=!0===c.state.settings.lowSpecsMode,y=i();y.current=c;const[O,H]=n(q),W=O.cards;let G={};const J=l((e=>{G={...G,...e},H({...O,...G})}),[O]),K=l((e=>{J({name:e})}),[J]),Q=l((e=>{J({fileName:e})}),[J]),X=l((()=>{J({showDeckStats:!O.showDeckStats})}),[J,O.showDeckStats]),Y=l((()=>{J({includeAssociated:!O.includeAssociated})}),[J,O.includeAssociated]),Z=S((e=>{const t=[...W];t.sort(((e,t)=>{const r=(Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost)||1/0,a=(Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost)||1/0,s=(e.card.name||"").toLowerCase(),o=(t.card.name||"").toLowerCase();return r-a||s.localeCompare(o)})),e(t)}),[W],[]);d((()=>{const e=c.getAllowBack();return y.current.setAllowBack((function(){if(document.documentElement.scrollTop>100){const e=!0===y.current.state.settings.lowSpecsMode;return setImmediate((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){y.current.setAllowBack(e)}}),[]),d((()=>(c.state.cardId&&b(c.state.cardId).then((e=>{H({...q,...e}),e.cards.forEach((e=>{const t=e.card.id||e.card.cardCode;ye.current.set(t,e)}))})),()=>{y.current.patchState({cardId:""})})),[c.state.cardId]);const[$,ee]=n("rito"),te=i(),re=S((e=>{const t=()=>e(te.current.offsetHeight);return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)}),[]),ae=S((e=>{w({exclude:["deck"]}).then((t=>{e(t),t.forEach((e=>{e&&e.id&&(de.current[e.id]=e)}))}))}),[]),[se,oe,ce,ne]=x({name:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},effect:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},lvup:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},clan:{filter:(e,t)=>!e||Array.prototype.some.call(t,(t=>t.toLowerCase().includes(e.toLowerCase())))},keywords:{filter:(e,t)=>!e||!e.length||t.some((t=>e.includes(t)||e.some((e=>"string"!=typeof e&&"string"!=typeof t&&e.id===t.id))))},rarity:{filter:(e,t)=>!e||!e.length||e.includes(t)},type:{filter:(e,t)=>!e||!e.length||e.includes(t)},faction:{filter:(e,t)=>!e||!e.length||e.some((e=>t.includes(e)))},speed:{filter:(e,t)=>!e||!e.length||e.includes(t)},mana:{filter:(e,t)=>{if(!e||!e.length)return!0;const[r,a]=e;return t<=a&&t>=r}},power:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[a,s]=e;return t<=s&&t>=a}},health:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[a,s]=e;return t<=s&&t>=a}}});d((()=>{if(!ae||!ae.length)return oe([]);oe(ae)}),[ae]);const le=l(((e,t)=>{const r={};r[e]=t,ne(r)}),[ne]),ie=S((e=>{if(!(ae&&ae.length&&se&&se.length))return;const t=T(ae);t.health&&(t.health=t.health.filter((e=>null!=e))),t.power&&(t.power=t.power.filter((e=>null!=e))),t.mana&&(t.mana=t.mana.filter((e=>null!=e)));const r=t.type;r&&(t.type=t.type.filter((e=>!e.toLowerCase().includes("champion"))),r.length!==t.type.length&&t.type.push("champion"));const a=T(se),s=[];a.keywords&&(a.keywords=a.keywords.filter((e=>{const t=e.id||e;return!s.includes(t)&&(s.push(t),!0)})));e({...t,keywords:a.keywords})}),[ae,se],{}),de=i({}),[ue,me]=n();d((()=>{p().then((e=>{let t;me(t=getRitoCardsFromDataDump(e)),t.forEach((e=>{e&&(de.current[e.cardCode]=e)}))}))}),[]);const[fe,pe]=n(!1),ge=l((()=>{fe||(pe(!0),h().then((async e=>{await g(e),me(getRitoCardsFromDataDump(e)),pe(!1)})))}),[fe]),[he,we,be,ke]=x({collectible:{value:!0,filter:(e,t)=>t===e},name:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},descriptionRaw:{filter:(e,t,r)=>!e||(t.toLowerCase().includes(e.toLowerCase())||r.levelupDescriptionRaw.toLowerCase().includes(e.toLowerCase())||r.description.toLowerCase().includes(e.toLowerCase())||r.levelupDescription.toLowerCase().includes(e.toLowerCase()))},subtypes:{filter:(e,t)=>!e||Array.prototype.some.call(t,(t=>t.toLowerCase().includes(e.toLowerCase())))},type:{filter:(e,t)=>!e||!e.length||e.includes(t)},set:{filter:(e,t)=>!e||!e.length||e.includes(t)},keywords:{filter:(e,t)=>!e||!e.length||t.some((t=>e.includes(t)))},rarity:{filter:(e,t)=>!e||!e.length||e.includes(t)},regionRefs:{filter:(e,t)=>!e||!e.length||e.some((e=>t.includes(e)))},spellSpeed:{filter:(e,t)=>!e||!e.length||e.includes(t)},cost:{filter:(e,t)=>{if(!e||!e.length)return!0;const[r,a]=e;return t<=a&&t>=r}},attack:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[a,s]=e;return t<=s&&t>=a}},health:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[a,s]=e;return t<=s&&t>=a}}});d((()=>{if(!ue||!ue.length)return we([]);we(ue)}),[ue]);const Ce=l(((e,t)=>{const r={};r[e]=t,ke(r)}),[ke]),Ne=S((e=>{if(!(ue&&ue.length&&he&&he.length))return;const t=T(ue);t.set.sort(((e,t)=>e.localeCompare(t)));const r=T(he);e({...t,keywords:r.keywords})}),[ue,he],{}),ye=i(new Map),ve=l((()=>{const e=[];ye.current.forEach((t=>e.push(t))),e.sort(((e,t)=>{const r=(Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost)||1/0,a=(Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost)||1/0,s=(e.card.name||"").toLowerCase(),o=(t.card.name||"").toLowerCase();return t.count-e.count||r-a||s.localeCompare(o)})),J({cards:e})}),[J]),xe=l((e=>{const t=e.id||e.cardCode||e.url;let r=ye.current.get(t);r||(r={count:0,card:e},ye.current.set(t,r)),r.count++,ve()}),[ve]),Le=l((e=>{const t=e.id||e.cardCode||e.url;let r=ye.current.get(t);r&&(r.count&&r.count--,r.count<1&&ye.current.delete(t),ve())}),[ve]),_e=i(),[je,De]=n(0),[Se,Ee]=n(0);m((()=>{const e=A((function(){let e=_e.current.parentNode.clientWidth;const t=getComputedStyle(_e.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),De(e),Ee(_e.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(_e.current,{childList:!0,subtree:!0,attributes:["style"]}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[Ae,Oe]=n(null),[Fe,Re]=n(!1),Ve=l((()=>{if(Fe)return;Re(!0);const e={...O};if(O.includeAssociated){const t=[];O.cards.forEach((e=>{const r=e.card,a=r.associatedCardRefs||r.associatedCards;a&&a.forEach((e=>{const r=de.current[e]||de.current[e.id]||de.current[e.cardCode]||e;t.push(r)}))})),e.associatedCardsData=t}M(e,Ae,c).then((()=>Re(!1)),(e=>console.warn(e)+Re(!1)))}),[Ae,Fe,O,c]),[ze,Ue]=n(!O.id),[Ie,Me]=n(!1);d((()=>{Ue(!0)}),Object.keys(O).map((e=>O[e])));const Pe=l((()=>{if(!ze||Ie)return;function e(){Ue(!1),Me(!1)}if(Me(!0),O.id)return k(O.id,O).then(e,e);const t=Date.now().toString();k(t,O).then(e,e),J({id:t})}),[!ze||Ie,O,J]);return o({id:"deck-builder",className:"flex hcenter gutter-t-2"},t({className:"deck-preview box-xs-12 box-s-10 box-m-6",style:{paddingBottom:Se+"px"}},t({className:"preview-content gutter-rl-2",ref:_e,style:{width:je+"px"}},t({className:"flex vhcenter",ref:te},t({className:"gutter-rl"},e("deck_size"),": ",W.reduce(((e,t)=>e+t.count),0))),f(F.Provider,{value:{current:Ae,setRef:Oe}},t({className:"preview-height-limit flex vhcenter",style:{"--simple-stats-height":re+"px"}},D({cards:W,loading:Fe,cardStats:O.showDeckStats}))),t({className:"flex vhcenter gutter-b"},t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5 "+(O.id?"":"hide"),onClick:()=>{C(O.id).then((()=>{document.location.reload()}))}},r(e("delete_deck")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",[ze||!Me?"data-foo":"disabled"]:!0,onClick:Pe},r(e("save_deck")))),t({className:"gutter-rl-.5"},a({className:"gutter-trbl-.5",[Fe?"disabled":"data-foo"]:!0,onClick:Ve},r(e("share"))))))),t({className:"card-finder box-xs-12 box-s-10 box-m-6"},s({className:"flex no-wrap card-list-options gutter-t-.5"},t({className:("rito"===$?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ee("rito")},e("official_cards")),t({className:("custom"===$?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ee("custom")},e("custom_cards")),t({className:("inDeck"===$?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ee("inDeck")},e("currently_selected_cards")),t({className:("about"===$?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ee("about")},e("about_deck_builder"))),t({className:"tab-body"},"rito"===$?t({className:"gutter-rl"},j({refreshRitoData:ge,refreshRitoLoading:fe,filterOptions:Ne,updateSelectedFilters:ke,updateSelectedFilter:Ce,selectedFilters:be}),t({className:"card-name-list"},L({defaultSize:N?8:24},(he||[]).map((e=>e?t({className:"flex gutter-b",key:e.cardCode},_({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},a({className:"grow gutter-trbl-.5",onClick:()=>xe(e)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),a({className:"grow gutter-trbl-.5",onClick:()=>Le(e)},t({className:"icon minus"})))):void 0))),ue&&ue.length?void 0:t({className:"flex"},a({onClick:ge,className:"gutter-trbl-.5 grow"},fe?t({className:"icon loading"}):e("load_rito_data"))))):void 0,"custom"===$?t({className:"gutter-rl"},E({filterOptions:ie,updateSelectedFilters:ne,updateSelectedFilter:le,selectedFilters:ce}),t({className:"card-name-list"},L({defaultSize:N?8:24},(se||[]).map((e=>e?t({className:"flex gutter-b",key:e.id},_({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},a({className:"grow gutter-trbl-.5",onClick:()=>xe(e)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),a({className:"grow gutter-trbl-.5",onClick:()=>Le(e)},t({className:"icon minus"})))):void 0))))):void 0,"inDeck"===$?t({className:"gutter-rl"},t({className:"card-name-list gutter-t"},t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},V({label:e("deck_name"),value:O.name,updateValue:K})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},B({label:e("file_name"),value:O.fileName,updateValue:Q,placeholder:O.name})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},z({label:e("other_custom_card"),moveable:!1,multiple:!0,updateValue:e=>{e.forEach((e=>xe({url:e})))}})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},P({label:e("show_deck_stats"),value:O.showDeckStats,updateValue:X})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},P({label:e("include_associated_cards"),value:O.includeAssociated,updateValue:Y})),(Z||[]).map((e=>e?t({className:"flex gutter-b",key:e.card.id||e.card.cardCode||e.card.url},I(e.card)?t({className:"box-9 gutter-rl"},U(e.card)):_({card:e.card,className:"box-9"},e.card.name),t({className:"box-3 flex no-wrap "+(I(e.card)?"vcenter":"")},a({className:"grow gutter-trbl-.5",onClick:()=>xe(e.card)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),a({className:"grow gutter-trbl-.5",onClick:()=>Le(e.card)},t({className:"icon minus"})))):void 0)))):void 0,"about"===$?t({className:"gutter-rl"},t({className:"about-deck-uilder gutter-t"},t({className:"about-info"},e("about_deck_builder_1",!0)),t({className:"about-info"},e("about_deck_builder_2",!0)),t({className:"about-info"},e("about_deck_builder_3",!0)),t({className:"about-info"},e("about_deck_builder_4",!0)),t({className:"about-info"},e("about_deck_builder_5",!0)))):void 0)))}),H);