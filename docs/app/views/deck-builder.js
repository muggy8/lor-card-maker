import e,{div as t,strong as r,button as s,nav as a,section as o,label as c}from"/Utils/elements.js";import{useState as n,useCallback as l,useRef as i,useEffect as d,useContext as u,useLayoutEffect as m,createElement as p}from"/cdn/react";import{getRitoCards as f,patchRitoCards as g,getLatestRitoData as h,getCardList as w,getCard as b,saveCard as C,deleteCard as N}from"/Utils/service.js";import{isMobile as y}from"/cdn/react-device-detect";import k from"/Utils/load-css.js";import x from"/Utils/use-lang.js";import v from"/Utils/use-filter.js";import L from"/Components/list-limit.js";import j from"/Components/deck/card-name.js";import O from"/Components/deck/rito-cards-filters-ui.js";import E from"/Components/deck/deck-view.js";import S from"/Utils/use-asset-cache.js";import U from"/Components/deck/custom-cards-filters-ui.js";import _ from"/Utils/debounce-function.js";import A from"/cdn/save-svg-as-png";import{svgRefference as F}from"/Views/card-editor.js";import{openUri as D}from"/Views/card-editor.js";import{Globals as R}from"/Views/index.js";import V from"/Components/card-config/edit-name.js";const P=k("/Views/deck-builder.css");function z({sets:e}){if(!e)return;const t=e.map((e=>e.data)).flat();return t.sort(((e,t)=>{if("champion"===e.supertype.toLowerCase()&&"champion"!==t.supertype.toLowerCase())return-1;if("champion"!==e.supertype.toLowerCase()&&"champion"===t.supertype.toLowerCase())return 1;const r=e.cost-t.cost;if(r)return r;const s=t.collectible-e.collectible;if(s)return s;const a=e.name.localeCompare(t.name);return a||0})),t}function I(e){const t=e.reduce(((e,t)=>t?(Object.keys(t).forEach((r=>{e[r]=e[r]||new Map;const s=t[r];Array.isArray(s)?s.forEach((t=>{e[r].set(t,!0)})):e[r].set(s,!0)})),e):e),{});return Object.keys(t).forEach((e=>{const r=t[e];t[e]=[],r.forEach(((r,s)=>{t[e].push(s)}))})),t}const B={id:void 0,cards:[],type:"deck",name:""};export default e((function(){const e=x(),c=u(R),y=i();y.current=c;const[k,P]=n(B),M=k.cards;let T={};const q=l((e=>{T={...T,...e},P({...k,...T})}),[k]),H=l((e=>{q({name:e})}),[q]),W=S((e=>{const t=[...M];t.sort(((e,t)=>{const r=Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost,s=Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost,a=e.card.name.toLowerCase(),o=t.card.name.toLowerCase();return r-s||a.localeCompare(o)})),e(t)}),[M],[]);d((()=>{const e=c.getAllowBack();return y.current.setAllowBack((function(){return document.documentElement.scrollTop>100?(setImmediate((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:"smooth"}))),!1):e()})),function(){y.current.setAllowBack(e)}}),[]),d((()=>(c.state.cardId&&b(c.state.cardId).then((e=>{P(e),e.cards.forEach((e=>{const t=e.card.id||e.card.cardCode;me.current.set(t,e)}))})),()=>{y.current.patchState({cardId:""})})),[c.state.cardId]);const[$,G]=n("rito"),J=S((e=>{w({exclude:["keyword","deck"]}).then(e)}),[]),[K,Q,X,Y]=v({name:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},effect:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},lvup:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},clan:{filter:(e,t)=>!e||Array.prototype.some.call(t,(t=>t.toLowerCase().includes(e.toLowerCase())))},keywords:{filter:(e,t)=>!e||!e.length||t.some((t=>e.includes(t)||e.some((e=>"string"!=typeof e&&"string"!=typeof t&&e.id===t.id))))},rarity:{filter:(e,t)=>!e||!e.length||e.includes(t)},type:{filter:(e,t)=>!e||!e.length||e.includes(t)},faction:{filter:(e,t)=>!e||!e.length||e.some((e=>t.includes(e)))},speed:{filter:(e,t)=>!e||!e.length||e.includes(t)},mana:{filter:(e,t)=>{if(!e||!e.length)return!0;const[r,s]=e;return t<=s&&t>=r}},power:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}},health:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}}});d((()=>{if(!J||!J.length)return Q([]);Q(J)}),[J]);const Z=l(((e,t)=>{const r={};r[e]=t,Y(r)}),[Y]),ee=S((e=>{if(!(J&&J.length&&K&&K.length))return;const t=I(J);t.health=t.health.filter((e=>null!=e)),t.power=t.power.filter((e=>null!=e));const r=t.type;t.type=t.type.filter((e=>!e.toLowerCase().includes("champion"))),r.length!==t.type.length&&t.type.push("champion");const s=I(K),a=[];s.keywords=s.keywords.filter((e=>{const t=e.id||e;return!a.includes(t)&&(a.push(t),!0)}));e({...t,keywords:s.keywords})}),[J,K],{}),[te,re]=n();d((()=>{f().then((e=>{re(z(e))}))}),[]);const[se,ae]=n(!1),oe=l((()=>{ae(!0),h().then((async e=>{await g(e),re(z(e)),ae(!1)}))}),[]),[ce,ne,le,ie]=v({collectible:{value:!0,filter:(e,t)=>t===e},name:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},descriptionRaw:{filter:(e,t,r)=>!e||(t.toLowerCase().includes(e.toLowerCase())||r.levelupDescriptionRaw.toLowerCase().includes(e.toLowerCase())||r.description.toLowerCase().includes(e.toLowerCase())||r.levelupDescription.toLowerCase().includes(e.toLowerCase()))},subtypes:{filter:(e,t)=>!e||Array.prototype.some.call(t,(t=>t.toLowerCase().includes(e.toLowerCase())))},type:{filter:(e,t)=>!e||!e.length||e.includes(t)},set:{filter:(e,t)=>!e||!e.length||e.includes(t)},keywords:{filter:(e,t)=>!e||!e.length||t.some((t=>e.includes(t)))},rarity:{filter:(e,t)=>!e||!e.length||e.includes(t)},regionRefs:{filter:(e,t)=>!e||!e.length||e.some((e=>t.includes(e)))},spellSpeed:{filter:(e,t)=>!e||!e.length||e.includes(t)},cost:{filter:(e,t)=>{if(!e||!e.length)return!0;const[r,s]=e;return t<=s&&t>=r}},attack:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}},health:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}}});d((()=>{if(!te||!te.length)return ne([]);ne(te)}),[te]);const de=l(((e,t)=>{const r={};r[e]=t,ie(r)}),[ie]),ue=S((e=>{if(!(te&&te.length&&ce&&ce.length))return;const t=I(te);t.set.sort(((e,t)=>e.localeCompare(t)));const r=I(ce);e({...t,keywords:r.keywords})}),[te,ce],{}),me=i(new Map),pe=l((()=>{const e=[];me.current.forEach((t=>e.push(t))),e.sort(((e,t)=>{const r=Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost,s=Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost,a=e.card.name.toLowerCase(),o=t.card.name.toLowerCase();return t.count-e.count||r-s||a.localeCompare(o)})),q({cards:e})}),[q]),fe=l((e=>{const t=e.id||e.cardCode;let r=me.current.get(t);r||(r={count:0,card:e},me.current.set(t,r)),r.count++,pe()}),[pe]),ge=l((e=>{const t=e.id||e.cardCode;let r=me.current.get(t);r&&(r.count&&r.count--,r.count<1&&me.current.delete(t),pe())}),[pe]),he=i(),[we,be]=n(0),[Ce,Ne]=n(0);m((()=>{const e=_((function(){let e=he.current.parentNode.clientWidth;const t=getComputedStyle(he.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),be(e),Ne(he.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(he.current,{childList:!0,subtree:!0,attributes:["style"]}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[ye,ke]=n(null),[xe,ve]=n(!1),Le=l((()=>{xe||(ve(!0),A.svgAsPngUri(ye,{excludeUnusedCss:!0,width:ye.width.baseVal.value,height:ye.height.baseVal.value}).then((e=>{D(e,`${(k.name||"export").toUpperCase()}.png`),ve(!1)}),(()=>ve(!1))))}),[ye,xe]),[je,Oe]=n(!k.id),[Ee,Se]=n(!1);d((()=>{Oe(!0)}),Object.keys(k).map((e=>k[e])));const Ue=l((()=>{if(!je||Ee)return;function e(){Oe(!1),Se(!1)}if(Se(!0),k.id)return C(k.id,k).then(e,e);const t=Date.now().toString();C(t,k).then(e,e),q({id:t})}),[!je||Ee,k,q]);return o({id:"deck-builder",className:"flex hcenter gutter-t-2"},t({className:"deck-preview box-xs-12 box-s-10 box-m-6",style:{paddingBottom:Ce+"px"}},t({className:"preview-content gutter-rl-2",ref:he,style:{width:we+"px"}},t({className:"flex vhcenter"},t({className:"gutter-rl"},e("deck_size"),": ",M.reduce(((e,t)=>e+t.count),0))),p(F.Provider,{value:{current:ye,setRef:ke}},E({cards:M,loading:xe})),t({className:"flex vhcenter gutter-b"},t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5 "+(k.id?"":"hide"),onClick:()=>{N(k.id).then((()=>{document.location.reload()}))}},r(e("delete_deck")))),t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5",[je||!Se?"data-foo":"disabled"]:!0,onClick:Ue},r(e("save_deck")))),t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5",[xe?"disabled":"data-foo"]:!0,onClick:Le},r(e("export"))))))),t({className:"card-finder box-xs-12 box-s-10 box-m-6"},a({className:"flex card-list-options gutter-t-.5"},t({className:("rito"===$?"active ":"")+"tab-header box-4 gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>G("rito")},e("official_cards")),t({className:("custom"===$?"active ":"")+"tab-header box-4 gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>G("custom")},e("custom_cards")),t({className:("inDeck"===$?"active ":"")+"tab-header box-4 gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>G("inDeck")},e("currently_selected_cards"))),t({className:"tab-body"},"rito"===$?t({className:"gutter-rl"},O({refreshRitoData:oe,refreshRitoLoading:se,filterOptions:ue,updateSelectedFilters:ie,updateSelectedFilter:de,selectedFilters:le}),t({className:"card-name-list"},L({defaultSize:24},(ce||[]).map((e=>e?t({className:"flex gutter-b",key:e.cardCode},j({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>fe(e)},t({className:"icon"},t({className:"add"}))),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>ge(e)},t({className:"icon"},t({className:"minus"}))))):void 0))),te&&te.length?void 0:t({className:"flex"},s({onClick:oe,className:"gutter-trbl-.5 grow"},se?t({className:"icon"},t({className:"loading"})):e("load_rito_data"))))):void 0,"custom"===$?t({className:"gutter-rl"},U({filterOptions:ee,updateSelectedFilters:Y,updateSelectedFilter:Z,selectedFilters:X}),t({className:"card-name-list"},L({defaultSize:24},(K||[]).map((e=>e?t({className:"flex gutter-b",key:e.id},j({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>fe(e)},t({className:"icon"},t({className:"add"}))),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>ge(e)},t({className:"icon"},t({className:"minus"}))))):void 0))))):void 0,"inDeck"===$?t({className:"gutter-rl"},t({className:"card-name-list gutter-t"},t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},V({label:e("deck_name"),value:k.name,updateValue:H})),(W||[]).map((e=>e?t({className:"flex gutter-b",key:e.card.id||e.card.cardCode},j({card:e.card,className:"box-9"},e.card.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>fe(e.card)},t({className:"icon"},t({className:"add"}))),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>ge(e.card)},t({className:"icon"},t({className:"minus"}))))):void 0)))):void 0)))}),P);