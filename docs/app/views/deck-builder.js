import e,{div as t,strong as r,button as s,nav as a,section as c,label as o,fragment as l,img as i}from"/Utils/elements.js";import{useState as d,useCallback as n,useRef as m,useEffect as u,useContext as p,useLayoutEffect as f,createElement as g}from"/cdn/react";import{getCard as b,saveCard as h,deleteCard as k}from"/Utils/service.js";import N from"/Utils/load-css.js";import w from"/Utils/use-lang.js";import C from"/Components/list-limit.js";import v from"/Components/deck/card-name.js";import x from"/Components/deck/rito-cards-filters-ui.js";import _ from"/Components/deck/deck-view.js";import y from"/Utils/use-asset-cache.js";import j from"/Components/deck/custom-cards-filters-ui.js";import L from"/Utils/debounce-function.js";import{svgRefference as F}from"/Views/card-editor.js";import{Globals as S}from"/Views/index.js";import O from"/Components/card-config/edit-name.js";import A from"/Components/card-config/edit-art.js";import{ExternalCustomCard as D,isExternalImage as E}from"/Components/deck/deck-card.js";import I from"/Components/export.js";import P from"/Components/card-config/edit-checkbox.js";import V from"/Components/card-config/edit-file-name.js";import R from"/Utils/datauri.js";import z from"/cdn/react-modal";import U,{RelicItemRitoIcon as B}from"/Components/deck/poc-relic-item-selection-modal-icon.js";import M from"/Components/deck/hooks/use-filterable-rito-card-list.js";import H from"/Components/deck/hooks/use-filterable-custom-card-list.js";import q from"/Components/deck/hooks/use-rito-poc-stickers.js";import T from"/Components/card-config/edit-clone-existing.js";const W=e(z),G=N("/Views/deck-builder.css"),J={id:void 0,cards:[],type:"deck",name:"",showDeckStats:!0,includeAssociated:!1,showPocItems:!0,showAssociatedCards:!1,dataVersion:2,fileName:""};export default e((function(){const e=w(),o=p(S),i=!0===o.state.settings.lowSpecsMode,N=m();N.current=o;const[z,G]=d(J),K=z.cards;let Q={};const X=n((e=>{Q={...Q,...e},G({...z,...Q})}),[z]),Y=n((e=>{X({name:e})}),[X]),Z=n((e=>{X({fileName:e})}),[X]),$=n((()=>{X({showDeckStats:!z.showDeckStats})}),[X,z.showDeckStats]),ee=n((()=>{X({includeAssociated:!z.includeAssociated})}),[X,z.includeAssociated]),te=n((()=>{X({showPocItems:!z.showPocItems})}),[X,z.showPocItems]),re=y((e=>{const t=[...K];t.sort(((e,t)=>{const r=(Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost)||1/0,s=(Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost)||1/0,a=(e.card.name||"").toLowerCase(),c=(t.card.name||"").toLowerCase();return r-s||a.localeCompare(c)})),e(t)}),[K],[]);u((()=>{const e=o.getAllowBack();return N.current.setAllowBack((function(){if(document.documentElement.scrollTop>100){const e=!0===N.current.state.settings.lowSpecsMode;return setImmediate((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){N.current.setAllowBack(e)}}),[]);const se=m(new Map);u((()=>(o.state.cardId&&b(o.state.cardId).then((e=>{G({...J,...e}),e.cards.forEach((e=>{const t=e.card.id||e.card.cardCode;se.current.set(t,e)}))})),()=>{N.current.patchState({cardId:""})})),[o.state.cardId]);const ae=n((e=>{e&&(delete e.id,delete e.dataVersion,delete e.type,G({...z,...e}),se.current.clear(),e.cards&&e.cards.forEach&&e.cards.forEach((e=>{const t=e.card.id||e.card.cardCode;se.current.set(t,e)})))}),[]),[ce,oe]=d("rito"),le=m(),ie=y((e=>{const t=()=>e(le.current.offsetHeight);return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)}),[]),de=m({}),ne=H(de),me=M(de),ue=n((()=>{const e=[];se.current.forEach((t=>e.push(t))),e.sort(((e,t)=>{const r=(Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost)||1/0,s=(Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost)||1/0,a=(e.card.name||"").toLowerCase(),c=(t.card.name||"").toLowerCase();return t.count-e.count||r-s||a.localeCompare(c)})),X({cards:e})}),[X]),pe=n((e=>{const t=e.id||e.cardCode||e.url;let r=se.current.get(t);r||(r={count:0,card:e},se.current.set(t,r)),r.count++,ue()}),[ue]),fe=n((e=>{const t=e.id||e.cardCode||e.url;let r=se.current.get(t);r&&(r.count&&r.count--,r.count<1&&se.current.delete(t),ue())}),[ue]),ge=q(),[be,he]=d(!1),[ke,Ne]=d((()=>console.log)),we=n((e=>{Ne((()=>t=>{const r=e.id||e.cardCode||e.url;let s=se.current.get(r);s&&(s.stickers||(s.stickers=[]),s.stickers.push(t),ue(),he(!1))})),he(!0)}),[ue]),Ce=n(((e,t)=>{const r=e.id||e.cardCode||e.url;let s=se.current.get(r);s&&s.stickers&&(s.stickers.splice(t,1),ue())}),[ue]),ve=y((e=>{R("/Assets/poc/empty-sticker-epic.png").then(e)}),[]),xe=m(),[_e,ye]=d(0),[je,Le]=d(0);f((()=>{const e=L((function(){let e=xe.current.parentNode.clientWidth;const t=getComputedStyle(xe.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),ye(e),Le(xe.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(xe.current,{childList:!0,subtree:!0,attributes:["style"]}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[Fe,Se]=d(null),[Oe,Ae]=d(!1),De=n((()=>{if(Oe)return;Ae(!0);const e={...z};if(z.includeAssociated){const t=[];z.cards.forEach((e=>{const r=e.card,s=r.associatedCardRefs||r.associatedCards;s&&s.forEach((e=>{const r=de.current[e]||de.current[e.id]||de.current[e.cardCode]||e;t.push(r)}))})),e.associatedCardsData=t}I(e,Fe,o).then((()=>Ae(!1)),(e=>console.warn(e)+Ae(!1)))}),[Fe,Oe,z,o]),[Ee,Ie]=d(!z.id),[Pe,Ve]=d(!1);u((()=>{Ie(!0)}),Object.keys(z).map((e=>z[e])));const Re=n((()=>{if(!Ee||Pe)return;function e(){Ie(!1),Ve(!1)}if(Ve(!0),z.id)return h(z.id,z).then(e,e);const t=Date.now().toString();h(t,z).then(e,e),X({id:t})}),[!Ee||Pe,z,X]);return c({id:"deck-builder",className:"flex hcenter gutter-t-2"},t({className:"deck-preview box-xs-12 box-s-10 box-m-6",style:{paddingBottom:je+"px"}},t({className:"preview-content gutter-rl-2",ref:xe,style:{width:_e+"px"}},t({className:"flex vhcenter",ref:le},t({className:"gutter-rl"},e("deck_size"),": ",K.reduce(((e,t)=>e+t.count),0))),t({className:"preview-height-limit flex vhcenter",style:{"--simple-stats-height":ie+"px"}},g(F.Provider,{value:{current:Fe,setRef:Se}},_({cards:K,loading:Oe,cardStats:z.showDeckStats,showAssociatedCards:z.showAssociatedCards}))),t({className:"flex vhcenter gutter-b"},t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5 "+(z.id?"":"hide"),onClick:()=>{k(z.id).then((()=>{document.location.reload()}))}},r(e("delete_deck")))),t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5",[Ee||!Ve?"data-foo":"disabled"]:!0,onClick:Re},r(e("save_deck")))),t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5",[Oe?"disabled":"data-foo"]:!0,onClick:De},r(e("share"))))))),t({className:"card-finder box-xs-12 box-s-10 box-m-6"},a({className:"flex no-wrap card-list-options gutter-t-.5"},t({className:("rito"===ce?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>oe("rito")},e("official_cards")),t({className:("custom"===ce?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>oe("custom")},e("custom_cards")),t({className:("inDeck"===ce?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>oe("inDeck")},e("currently_selected_cards")),t({className:("about"===ce?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>oe("about")},e("about_deck_builder"))),t({className:"tab-body"},"rito"===ce?t({className:"gutter-rl"},x({refreshRitoData:me.refreshList,refreshRitoLoading:me.loading,filterOptions:me.filterOptions,updateSelectedFilters:me.patchFilters,updateSelectedFilter:me.patchFilter,selectedFilters:me.currentFilters}),t({className:"card-name-list"},C({defaultSize:i?8:24},(me.filteredCardList||[]).map((e=>e?t({className:"flex gutter-b",key:e.cardCode},v({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>pe(e)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>fe(e)},t({className:"icon minus"})))):void 0))),me.cardList&&me.cardList.length?void 0:t({className:"flex"},s({onClick:me.refreshList,className:"gutter-trbl-.5 grow"},me.loading?t({className:"icon loading"}):e("load_rito_data"))))):void 0,"custom"===ce?t({className:"gutter-rl"},j({filterOptions:ne.filterOptions,updateSelectedFilters:ne.patchFilters,updateSelectedFilter:ne.patchFilter,selectedFilters:ne.currentFilters}),t({className:"card-name-list"},C({defaultSize:i?8:24},(ne.filteredCardList||[]).map((e=>e?t({className:"flex gutter-b",key:e.id},v({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>pe(e)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>fe(e)},t({className:"icon minus"})))):void 0))))):void 0,"inDeck"===ce?t({className:"gutter-rl"},t({className:"card-name-list gutter-t"},t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},O({label:e("deck_name"),value:z.name,updateValue:Y})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},V({label:e("file_name"),value:z.fileName,updateValue:Z,placeholder:z.name})),void 0===z.id?t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},T({updateAll:ae,only:"deck"})):void 0,t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},A({label:e("other_custom_card"),moveable:!1,multiple:!0,updateValue:e=>{e.forEach((e=>pe({url:e})))}})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},P({label:e("show_deck_stats"),value:z.showDeckStats,updateValue:$})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},P({label:e("include_associated_cards"),value:z.includeAssociated,updateValue:ee})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},P({label:e("show_poc_items"),value:z.showPocItems,updateValue:te})),(re||[]).map((e=>e?t({className:z.showPocItems?"gutter-b":"gutter-b-.5",key:e.card.id||e.card.cardCode||e.card.url},t({className:"flex gutter-b-.5"},E(e.card)?t({className:"box-9 gutter-rl"},D(e.card)):v({card:e.card,className:"box-9"},e.card.name),t({className:"box-3 flex no-wrap "+(E(e.card)?"vcenter":"")},s({className:"grow gutter-trbl-.5",onClick:()=>pe(e.card)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>fe(e.card)},t({className:"icon minus"})))),z.showPocItems?l(t({className:"flex"},e.stickers?Array.prototype.map.call(e.stickers,((r,a)=>t({className:"box-2 text-center",key:r.itemCode||r.relicCode},B(r),s({className:"gutter-trbl-.5 clickable",onClick:()=>Ce(e.card,a)},t({className:"icon multiply"}))))):void 0,t({className:"box-2 clickable"},B({url:ve,urlFull:ve,onClick:()=>we(e.card)})))):void 0):void 0)))):void 0,"about"===ce?t({className:"gutter-rl"},t({className:"about-deck-uilder gutter-t"},t({className:"about-info"},e("about_deck_builder_1",!0)),t({className:"about-info"},e("about_deck_builder_2",!0)),t({className:"about-info"},e("about_deck_builder_3",!0)),t({className:"about-info"},e("about_deck_builder_4",!0)),t({className:"about-info"},e("about_deck_builder_5",!0)))):void 0)),W({isOpen:be,contentLabel:"Select PoC Items or Relics",className:"poc-item-relic-modal gutter-trbl",overlayClassName:"poc-item-relic-overlay",shouldCloseOnOverlayClick:!0,onRequestClose:()=>he(!1),ariaHideApp:!1},ge.relic.list.length||ge.item.list.length?void 0:t({className:"flex gutter-b"},s({className:"gutter-trbl-.5 grow",onClick:ge.refreshList},e("load_rito_data"))),ge.relic.list.length||ge.item.list.length?x({refreshRitoData:ge.refreshList,refreshRitoLoading:ge.loading,filterOptions:ge.filterOptions,updateSelectedFilters:ge.patchFilters,updateSelectedFilter:ge.patchFilter,selectedFilters:ge.currentFilters}):void 0,ge.relic.filteredList.length?t(t({className:"text-center gutter-t gutter-b-.5"},r(e("relic"))),t({className:"flex"},ge.relic.filteredList.map((e=>U({...e,onClick:()=>ke(e),key:e.relicCode}))))):void 0,ge.item.filteredList.length?t(t({className:"text-center gutter-t gutter-b-.5"},r(e("item"))),t({className:"flex"},ge.item.filteredList.map((e=>U({...e,onClick:()=>ke(e),key:e.itemCode}))))):void 0))}),G);