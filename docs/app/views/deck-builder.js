import e,{div as t,strong as r,button as s,nav as a,section as o,label as c,fragment as l,img as n}from"/Utils/elements.js";import{useState as i,useCallback as d,useRef as u,useEffect as m,useContext as p,useLayoutEffect as f,createElement as g}from"/cdn/react";import{getRitoCards as h,patchRitoCards as w,getLatestRitoData as b,getRitoPoCItemRelic as k,patchRitoPocItemRelic as C,getLatestPoCItemRelicData as N,getCardList as y,getCard as v,saveCard as x,deleteCard as L}from"/Utils/service.js";import _ from"/Utils/load-css.js";import j from"/Utils/use-lang.js";import A from"/Utils/use-filter.js";import D from"/Components/list-limit.js";import S from"/Components/deck/card-name.js";import E from"/Components/deck/rito-cards-filters-ui.js";import O from"/Components/deck/deck-view.js";import F from"/Utils/use-asset-cache.js";import I from"/Components/deck/custom-cards-filters-ui.js";import P from"/Utils/debounce-function.js";import{svgRefference as R}from"/Views/card-editor.js";import{Globals as V}from"/Views/index.js";import U from"/Components/card-config/edit-name.js";import z from"/Components/card-config/edit-art.js";import{ExternalCustomCard as M,isExternalImage as B}from"/Components/deck/deck-card.js";import H from"/Components/export.js";import q from"/Components/card-config/edit-checkbox.js";import T from"/Components/card-config/edit-file-name.js";import W from"/Utils/datauri.js";import G from"/cdn/react-modal";import J,{RelicItemRitoIcon as K}from"/Components/deck/poc-relic-item-selection-modal-icon.js";const Q=e(G),X=_("/Views/deck-builder.css");export function getRitoCardsFromDataDump({sets:e}){if(!e)return;const t=e.map((e=>e.data)).flat();return t.sort(((e,t)=>{if("champion"===e.supertype.toLowerCase()&&"champion"!==t.supertype.toLowerCase())return-1;if("champion"!==e.supertype.toLowerCase()&&"champion"===t.supertype.toLowerCase())return 1;const r=e.cost-t.cost;if(r)return r;const s=t.collectible-e.collectible;if(s)return s;const a=e.name.localeCompare(t.name);return a||0})),t}function Y(e){const t=e.reduce(((e,t)=>t?(Object.keys(t).forEach((r=>{e[r]=e[r]||new Map;const s=t[r];Array.isArray(s)?s.forEach((t=>{e[r].set(t,!0)})):e[r].set(s,!0)})),e):e),{});return Object.keys(t).forEach((e=>{const r=t[e];t[e]=[],r.forEach(((r,s)=>{t[e].push(s)}))})),t}const Z={id:void 0,cards:[],type:"deck",name:"",showDeckStats:!0,includeAssociated:!1,showPocItems:!1,showAssociatedCards:!1,dataVersion:2,fileName:""};export default e((function(){const e=j(),c=p(V),n=!0===c.state.settings.lowSpecsMode,_=u();_.current=c;const[G,X]=i(Z),$=G.cards;let ee={};const te=d((e=>{ee={...ee,...e},X({...G,...ee})}),[G]),re=d((e=>{te({name:e})}),[te]),se=d((e=>{te({fileName:e})}),[te]),ae=d((()=>{te({showDeckStats:!G.showDeckStats})}),[te,G.showDeckStats]),oe=d((()=>{te({includeAssociated:!G.includeAssociated})}),[te,G.includeAssociated]),ce=d((()=>{te({showPocItems:!G.showPocItems})}),[te,G.showPocItems]),le=F((e=>{const t=[...$];t.sort(((e,t)=>{const r=(Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost)||1/0,s=(Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost)||1/0,a=(e.card.name||"").toLowerCase(),o=(t.card.name||"").toLowerCase();return r-s||a.localeCompare(o)})),e(t)}),[$],[]);m((()=>{const e=c.getAllowBack();return _.current.setAllowBack((function(){if(document.documentElement.scrollTop>100){const e=!0===_.current.state.settings.lowSpecsMode;return setImmediate((()=>window.scroll({top:-document.documentElement.scrollTop,left:0,behavior:e?"instant":"smooth"}))),!1}return e()})),function(){_.current.setAllowBack(e)}}),[]),m((()=>(c.state.cardId&&v(c.state.cardId).then((e=>{X({...Z,...e}),e.cards.forEach((e=>{const t=e.card.id||e.card.cardCode;Ee.current.set(t,e)}))})),()=>{_.current.patchState({cardId:""})})),[c.state.cardId]);const[ne,ie]=i("rito"),de=u(),ue=F((e=>{const t=()=>e(de.current.offsetHeight);return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)}),[]),me=F((e=>{y({exclude:["deck"]}).then((t=>{e(t),t.forEach((e=>{e&&e.id&&(ke.current[e.id]=e)}))}))}),[]),[pe,fe,ge,he]=A({name:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},effect:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},lvup:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},clan:{filter:(e,t)=>!e||Array.prototype.some.call(t,(t=>t.toLowerCase().includes(e.toLowerCase())))},keywords:{filter:(e,t)=>!e||!e.length||t.some((t=>e.includes(t)||e.some((e=>"string"!=typeof e&&"string"!=typeof t&&e.id===t.id))))},rarity:{filter:(e,t)=>!e||!e.length||e.includes(t)},type:{filter:(e,t)=>!e||!e.length||e.includes(t)},faction:{filter:(e,t)=>!e||!e.length||e.some((e=>t.includes(e)))},speed:{filter:(e,t)=>!e||!e.length||e.includes(t)},mana:{filter:(e,t)=>{if(!e||!e.length)return!0;const[r,s]=e;return t<=s&&t>=r}},power:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}},health:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}}});m((()=>{if(!me||!me.length)return fe([]);fe(me)}),[me]);const we=d(((e,t)=>{const r={};r[e]=t,he(r)}),[he]),be=F((e=>{if(!(me&&me.length&&pe&&pe.length))return;const t=Y(me);t.health&&(t.health=t.health.filter((e=>null!=e))),t.power&&(t.power=t.power.filter((e=>null!=e))),t.mana&&(t.mana=t.mana.filter((e=>null!=e)));const r=t.type;r&&(t.type=t.type.filter((e=>!e.toLowerCase().includes("champion"))),r.length!==t.type.length&&t.type.push("champion"));const s=Y(pe),a=[];s.keywords&&(s.keywords=s.keywords.filter((e=>{const t=e.id||e;return!a.includes(t)&&(a.push(t),!0)})));e({...t,keywords:s.keywords})}),[me,pe],{}),ke=u({}),[Ce,Ne]=i();m((()=>{h().then((e=>{let t;Ne(t=getRitoCardsFromDataDump(e)),t.forEach((e=>{e&&(ke.current[e.cardCode]=e)}))}))}),[]);const[ye,ve]=i(!1),xe=d((()=>{ye||(ve(!0),b().then((async e=>{await w(e),Ne(getRitoCardsFromDataDump(e)),ve(!1)})))}),[ye]),[Le,_e,je,Ae]=A({collectible:{value:!0,filter:(e,t)=>t===e},name:{filter:(e,t)=>!e||t.toLowerCase().includes(e.toLowerCase())},descriptionRaw:{filter:(e,t,r)=>!e||(t.toLowerCase().includes(e.toLowerCase())||r.levelupDescriptionRaw.toLowerCase().includes(e.toLowerCase())||r.description.toLowerCase().includes(e.toLowerCase())||r.levelupDescription.toLowerCase().includes(e.toLowerCase()))},subtypes:{filter:(e,t)=>!e||Array.prototype.some.call(t,(t=>t.toLowerCase().includes(e.toLowerCase())))},type:{filter:(e,t)=>!e||!e.length||e.includes(t)},set:{filter:(e,t)=>!e||!e.length||e.includes(t)},keywords:{filter:(e,t)=>!e||!e.length||t.some((t=>e.includes(t)))},rarity:{filter:(e,t)=>!e||!e.length||e.includes(t)},regionRefs:{filter:(e,t)=>!e||!e.length||e.some((e=>t.includes(e)))},spellSpeed:{filter:(e,t)=>!e||!e.length||e.includes(t)},cost:{filter:(e,t)=>{if(!e||!e.length)return!0;const[r,s]=e;return t<=s&&t>=r}},attack:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}},health:{filter:(e,t,r)=>{if(!e||!e.length)return!0;if("unit"!==(r.type||"").toLowerCase())return!1;const[s,a]=e;return t<=a&&t>=s}}});m((()=>{if(!Ce||!Ce.length)return _e([]);_e(Ce)}),[Ce]);const De=d(((e,t)=>{const r={};r[e]=t,Ae(r)}),[Ae]),Se=F((e=>{if(!(Ce&&Ce.length&&Le&&Le.length))return;const t=Y(Ce);t.set.sort(((e,t)=>e.localeCompare(t)));const r=Y(Le);e({...t,keywords:r.keywords})}),[Ce,Le],{}),Ee=u(new Map),Oe=d((()=>{const e=[];Ee.current.forEach((t=>e.push(t))),e.sort(((e,t)=>{const r=(Object.prototype.hasOwnProperty.call(e.card,"mana")?e.card.mana:e.card.cost)||1/0,s=(Object.prototype.hasOwnProperty.call(t.card,"mana")?t.card.mana:t.card.cost)||1/0,a=(e.card.name||"").toLowerCase(),o=(t.card.name||"").toLowerCase();return t.count-e.count||r-s||a.localeCompare(o)})),te({cards:e})}),[te]),Fe=d((e=>{const t=e.id||e.cardCode||e.url;let r=Ee.current.get(t);r||(r={count:0,card:e},Ee.current.set(t,r)),r.count++,Oe()}),[Oe]),Ie=d((e=>{const t=e.id||e.cardCode||e.url;let r=Ee.current.get(t);r&&(r.count&&r.count--,r.count<1&&Ee.current.delete(t),Oe())}),[Oe]),[Pe,Re]=i({items:[],relics:[]});m((()=>{k().then(Re)}),[]);const[Ve,Ue]=i(!1),ze=d((()=>{Ve||(Ue(!0),N().then((async e=>{await C(e),Re(e),Ue(!1)})))}),[Ve]),[Me,Be]=i(!1),[He,qe]=i((()=>console.log)),Te=d((e=>{qe((()=>t=>{const r=e.id||e.cardCode||e.url;let s=Ee.current.get(r);s&&(s.stickers||(s.stickers=[]),s.stickers.push(t),Oe(),Be(!1))})),Be(!0)}),[Oe]),We=d(((e,t)=>{const r=e.id||e.cardCode||e.url;let s=Ee.current.get(r);s&&s.stickers&&(s.stickers.splice(t,1),Oe())}),[Oe]),Ge=F((e=>{W("/Assets/poc/empty-sticker-epic.png").then(e)}),[]),Je=u(),[Ke,Qe]=i(0),[Xe,Ye]=i(0);f((()=>{const e=P((function(){let e=Je.current.parentNode.clientWidth;const t=getComputedStyle(Je.current.parentNode);e=e-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),Qe(e),Ye(Je.current.offsetHeight)}),250);requestAnimationFrame(e);const t=new MutationObserver(e);return window.addEventListener("resize",e),t.observe(Je.current,{childList:!0,subtree:!0,attributes:["style"]}),function(){window.removeEventListener("resize",e),t.disconnect()}}),[]);const[Ze,$e]=i(null),[et,tt]=i(!1),rt=d((()=>{if(et)return;tt(!0);const e={...G};if(G.includeAssociated){const t=[];G.cards.forEach((e=>{const r=e.card,s=r.associatedCardRefs||r.associatedCards;s&&s.forEach((e=>{const r=ke.current[e]||ke.current[e.id]||ke.current[e.cardCode]||e;t.push(r)}))})),e.associatedCardsData=t}H(e,Ze,c).then((()=>tt(!1)),(e=>console.warn(e)+tt(!1)))}),[Ze,et,G,c]),[st,at]=i(!G.id),[ot,ct]=i(!1);m((()=>{at(!0)}),Object.keys(G).map((e=>G[e])));const lt=d((()=>{if(!st||ot)return;function e(){at(!1),ct(!1)}if(ct(!0),G.id)return x(G.id,G).then(e,e);const t=Date.now().toString();x(t,G).then(e,e),te({id:t})}),[!st||ot,G,te]);return o({id:"deck-builder",className:"flex hcenter gutter-t-2"},t({className:"deck-preview box-xs-12 box-s-10 box-m-6",style:{paddingBottom:Xe+"px"}},t({className:"preview-content gutter-rl-2",ref:Je,style:{width:Ke+"px"}},t({className:"flex vhcenter",ref:de},t({className:"gutter-rl"},e("deck_size"),": ",$.reduce(((e,t)=>e+t.count),0))),g(R.Provider,{value:{current:Ze,setRef:$e}},t({className:"preview-height-limit flex vhcenter",style:{"--simple-stats-height":ue+"px"}},O({cards:$,loading:et,cardStats:G.showDeckStats,showAssociatedCards:G.showAssociatedCards}))),t({className:"flex vhcenter gutter-b"},t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5 "+(G.id?"":"hide"),onClick:()=>{L(G.id).then((()=>{document.location.reload()}))}},r(e("delete_deck")))),t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5",[st||!ct?"data-foo":"disabled"]:!0,onClick:lt},r(e("save_deck")))),t({className:"gutter-rl-.5"},s({className:"gutter-trbl-.5",[et?"disabled":"data-foo"]:!0,onClick:rt},r(e("share"))))))),t({className:"card-finder box-xs-12 box-s-10 box-m-6"},a({className:"flex no-wrap card-list-options gutter-t-.5"},t({className:("rito"===ne?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ie("rito")},e("official_cards")),t({className:("custom"===ne?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ie("custom")},e("custom_cards")),t({className:("inDeck"===ne?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ie("inDeck")},e("currently_selected_cards")),t({className:("about"===ne?"active ":"")+"tab-header grow gutter-trbl-.5 clickable flex vhcenter text-center",onClick:()=>ie("about")},e("about_deck_builder"))),t({className:"tab-body"},"rito"===ne?t({className:"gutter-rl"},E({refreshRitoData:xe,refreshRitoLoading:ye,filterOptions:Se,updateSelectedFilters:Ae,updateSelectedFilter:De,selectedFilters:je}),t({className:"card-name-list"},D({defaultSize:n?8:24},(Le||[]).map((e=>e?t({className:"flex gutter-b",key:e.cardCode},S({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>Fe(e)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>Ie(e)},t({className:"icon minus"})))):void 0))),Ce&&Ce.length?void 0:t({className:"flex"},s({onClick:xe,className:"gutter-trbl-.5 grow"},ye?t({className:"icon loading"}):e("load_rito_data"))))):void 0,"custom"===ne?t({className:"gutter-rl"},I({filterOptions:be,updateSelectedFilters:he,updateSelectedFilter:we,selectedFilters:ge}),t({className:"card-name-list"},D({defaultSize:n?8:24},(pe||[]).map((e=>e?t({className:"flex gutter-b",key:e.id},S({card:e,className:"box-9"},e.name),t({className:"box-3 flex no-wrap"},s({className:"grow gutter-trbl-.5",onClick:()=>Fe(e)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>Ie(e)},t({className:"icon minus"})))):void 0))))):void 0,"inDeck"===ne?t({className:"gutter-rl"},t({className:"card-name-list gutter-t"},t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},U({label:e("deck_name"),value:G.name,updateValue:re})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},T({label:e("file_name"),value:G.fileName,updateValue:se,placeholder:G.name})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},z({label:e("other_custom_card"),moveable:!1,multiple:!0,updateValue:e=>{e.forEach((e=>Fe({url:e})))}})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},q({label:e("show_deck_stats"),value:G.showDeckStats,updateValue:ae})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},q({label:e("include_associated_cards"),value:G.includeAssociated,updateValue:oe})),t({className:"current-deck-input-fields gutter-rl-.5 gutter-b-1"},q({label:e("show_poc_items"),value:G.showPocItems,updateValue:ce})),(le||[]).map((e=>e?t({className:G.showPocItems?"gutter-b":"gutter-b-.5",key:e.card.id||e.card.cardCode||e.card.url},t({className:"flex gutter-b-.5"},B(e.card)?t({className:"box-9 gutter-rl"},M(e.card)):S({card:e.card,className:"box-9"},e.card.name),t({className:"box-3 flex no-wrap "+(B(e.card)?"vcenter":"")},s({className:"grow gutter-trbl-.5",onClick:()=>Fe(e.card)},t({className:"icon plus"})),t({className:"gutter-rl-.25"}),s({className:"grow gutter-trbl-.5",onClick:()=>Ie(e.card)},t({className:"icon minus"})))),G.showPocItems?l(t({className:"flex"},e.stickers?Array.prototype.map.call(e.stickers,((r,a)=>t({className:"box-2 text-center",key:r.itemCode||r.relicCode},K(r),s({className:"gutter-trbl-.5 clickable",onClick:()=>We(e.card,a)},t({className:"icon multiply"}))))):void 0,t({className:"box-2 clickable"},K({url:Ge,urlFull:Ge,onClick:()=>Te(e.card)})))):void 0):void 0)))):void 0,"about"===ne?t({className:"gutter-rl"},t({className:"about-deck-uilder gutter-t"},t({className:"about-info"},e("about_deck_builder_1",!0)),t({className:"about-info"},e("about_deck_builder_2",!0)),t({className:"about-info"},e("about_deck_builder_3",!0)),t({className:"about-info"},e("about_deck_builder_4",!0)),t({className:"about-info"},e("about_deck_builder_5",!0)))):void 0)),Q({isOpen:Me,contentLabel:"Select PoC Items or Relics",className:"poc-item-relic-modal gutter-trbl",overlayClassName:"poc-item-relic-overlay",shouldCloseOnOverlayClick:!0,onRequestClose:()=>Be(!1),ariaHideApp:!1},t({className:"flex gutter-b"},s({className:"gutter-trbl-.5 grow",onClick:ze},Pe.relics.length||Pe.items.length?e("refresh_rito_data"):e("load_rito_data"))),Pe.relics.length?t(t({className:"text-center gutter-t gutter-b-.5"},r(e("relic"))),t({className:"flex"},Pe.relics.map((e=>J({...e,onClick:()=>He(e),key:e.relicCode}))))):void 0,Pe.items.length?t(t({className:"text-center gutter-t gutter-b-.5"},r(e("item"))),t({className:"flex"},Pe.items.map((e=>J({...e,onClick:()=>He(e),key:e.itemCode}))))):void 0))}),X);